function OkkChatReady(e){var t=objectAssign({},{_audio:null,_mute:!1,_hasError:!1,mute:function(){this._mute=!0},unmute:function(){this._mute=!1},_onerror:function(){this._hasError=!0},hasError:function(){return this._hasError},play:function(){var e=ChatConfig.INCOMING_MESSAGE_SOUND_PATH||null;!this._audio&&e&&(this._audio=new Audio,this._audio.onerror=this._onerror,this._audio.src=e),!this._audio||this.hasError()||this._mute||this._audio.play()}}),a=objectAssign({},{_loadQueue:{},_accessKey:null,_socket:null,_updateQueue:[],_connectToSocket:function(){var t=this,s={path:ChatConfig.SOCKET_IO_NS};this._accessKey&&(s.extraHeaders={Authorization:this._accessKey});var n=io(ChatConfig.SOCKET_IO_URL,s);n.on("connect",function(){console.log("connected!!!"),t._socket=n,e.Actions.operatorStatusChanged("online")}),n.on("disconnect",function(){console.log("disconnect!!!"),e.Actions.operatorStatusChanged("offline")}),n.on("incoming:message",function(t){var a=JSON.parse(t);e.Actions.incomingMessage(a)}),n.on("operator:message",function(t){var a=JSON.parse(t),s=this._updateQueue.shift();e.Actions.updateMessageContent(s.to,s.tempMessageId,a)}.bind(this)),n.on("operator:message:history",function(t){var s=JSON.parse(t);if(s.success){var o=e.Stores.AuthStore.getOperator(),r=e.Stores.MessageStore.addContactRawMessages(o,s.contact,s.data);if(e.Stores.MessageStore.emitUpdate(),e.Stores.ContactsStore.setLoadedState(s.contact),e.Stores.ContactsStore.emitContactSelect(),r&&r.length){for(var i=[],t={},c=0;c<r.length;c++)i.push(+r[c].replace(/(m_|temp_)/gi,""));t={messageIds:i},n.emit("operator:read:messages",JSON.stringify(t))}a.popQueue(s.contact)}}),n.on("client:status",function(t){var a=JSON.parse(t);e.Actions.clientStatusChanged(a.id,a.username,a.status)}),n.on("client:new",function(e){}),n.on("client:list",function(t){var a=JSON.parse(t);a.success&&(e.Stores.ContactsStore.init(a.data),e.Stores.ContactsStore.emitChange(),e.Stores.MessageStore.init(a.unread))})},pushQueue:function(e){return this._loadQueue[e]?!1:(this._loadQueue[e]=!0,!0)},popQueue:function(e){delete this._loadQueue[e]},authenticate:function(){fetch(ChatConfig.URL_TO_OPERATOR_AUTH,{credentials:"include"}).then(function(e){return e.json()}).then(function(t){t.success?(a._accessKey=t.access_key,setTimeout(function(){var s=t.user,n={id:s.id,name:s.first_name,nick:s.username,status:"online"};e.Actions.authSuccess(n),a._connectToSocket()},1e3)):setTimeout(function(){e.Actions.authFail(t.message)},1e3)})["catch"](function(t){setTimeout(function(){e.Actions.authFail(t.message)},1e3)})},loadContacts:function(){this._socket.emit("client:list")},loadRawContactMessages:function(e,t){var a={mobile:e};t&&(a.firstMessageId=t),this._socket.emit("operator:message:history",JSON.stringify(a))},sendMessageToServer:function(e){this._updateQueue.push({to:e.receiver,tempMessageId:e.id}),this._socket.emit("operator:message",JSON.stringify(e))}});a.dispatchToken=e.Dispatcher.register(function(s){switch(s.type){case e.ActionTypes.NEW_OUT_MESSAGE:var n=s.payload,o={id:n.id,message:n.contentType==e.MessageContentTypes.IMAGE?n.fullImage:n.message,sender:n.sender,receiver:n.receiver,contentType:n.contentType,messageType:n.messageType,date:e.CoreUtils.formatDate(n.date),endOfConversation:n.endOfConversation,operator:!0};a.sendMessageToServer(o);break;case e.ActionTypes.API_FETCH_CONTACTS:a.loadContacts();break;case e.ActionTypes.API_AUTH_OPERATOR:a.authenticate(s.credentials);break;case e.ActionTypes.API_FETCH_CONTACT_HISTORY:var r=s.contact.name,i=a.pushQueue(r);i&&a.loadRawContactMessages(r,s.firstMessageId);break;case e.ActionTypes.NEW_IN_MESSAGE:t.play();break;case e.ActionTypes.MUTE_NOTIFICATION_SOUND:t.mute();break;case e.ActionTypes.UNMUTE_NOTIFICATION_SOUND:t.unmute()}})}function getRandomItem(e){var t=Object.keys(e),a=t.length;return e[t[Math.floor(Math.random()*a)]]}function genNumber(){return genNumber.prevValues||(genNumber.prevValues=0),genNumber.prevValues++,genNumber.prevValues+1e5}var _lastMessageId=1,_messages={},_contacts={},_fullMessageImages={},_chatParticipants={},_activeContactId,_preActiveContactId,_contactFilterPattern="",_currentOperator,keyMirror=function(e){var t,a={};if(!(e instanceof Object)||Array.isArray(e))throw new Error("keyMirror(...): Argument must be an object.");for(t in e)e.hasOwnProperty(t)&&(a[t]=t);return a},MessageContentTypes={IMAGE:"image",TEXT:"text"},MessageTypes={INCOMING:"in",OUTGOING:"out"},ChatConstants=keyMirror({MESSAGE_CHANGE_EVENT:null,CONTACT_SELECT_EVENT:null,MESSAGE_UPDATE_EVENT:null,CONTACTS_CHANGE_EVENT:null,FULL_IMAGES_CHANGE_EVENT:null,OPERATOR_CHANGED:null,PARTICIPANTS_CHANGED:null}),ActionTypes=keyMirror({CLICK_CONTACT:null,RECEIVE_RAW_MESSAGES:null,NEW_OUT_MESSAGE:null,NEW_IN_MESSAGE:null,READ_MESSAGES:null,CONTACT_MESSAGES_SCROLL:null,CONTACT_FILTER:null,CLEAR_SELECTED_CONTACT:null,AUTH_SUCCESS:null,AUTH_FAIL:null,PUT_FULL_IMAGE:null,API_FETCH_CONTACTS:null,API_AUTH_OPERATOR:null,API_FETCH_CONTACT_MESSAGES:null,API_FETCH_CONTACT_HISTORY:null,UPDATE_MESSAGE_CONTENT:null,CLIENT_STATUS_CHANGED:null,OPERATOR_STATUS_CHANGED:null,MUTE_NOTIFICATION_SOUND:null,UNMUTE_NOTIFICATION_SOUND:null}),AuthStatuses={SUCCESS:1,ERROR:2},KeyConstants={ENTER_KEY:13},CoreUtils={timeSince:function(e){switch(typeof e){case"number":break;case"string":e=+new Date(e);break;case"object":e.constructor===Date&&(e=e.getTime());break;default:e=+new Date}var t=[[60,"seconds",1],[120,"1 minute ago","1 minute from now"],[3600,"minutes",60],[7200,"1 hour ago","1 hour from now"],[86400,"hours",3600],[172800,"Yesterday","Tomorrow"],[604800,"days",86400],[1209600,"Last week","Next week"],[2419200,"weeks",604800],[4838400,"Last month","Next month"],[29030400,"months",2419200],[58060800,"Last year","Next year"],[290304e4,"years",29030400],[580608e4,"Last century","Next century"],[580608e5,"centuries",290304e4]],a=(+new Date-e)/1e3,s="ago",n=1;if(0==Math.floor(a))return"Just now";Math.floor(a)<0&&(a=Math.abs(a),s="from now",n=2);for(var o,r=0;o=t[r++];)if(a<o[0])return"string"==typeof o[2]?o[n]:Math.floor(a/o[2])+" "+o[1]+" "+s;return e},padLeft:function(e,t,a){var s=String(t||10).length-String(e).length+1;return s>0?new Array(s).join(a||"0")+e:e},getCurrentTime:function(e){var t=new Date(e)||new Date;return t.toLocaleTimeString().replace(/([\d]+:[\d]{2})(:[\d]{2})(.*)/,"$1$3")},formatDate:function(e){var t;return t="string"==typeof e?new Date(e):"object"==typeof e&&e.constructor==Date?e:new Date,[t.getFullYear(),CoreUtils.padLeft(t.getMonth()+1),CoreUtils.padLeft(t.getDate())].join("-")+" "+[CoreUtils.padLeft(t.getHours()),CoreUtils.padLeft(t.getMinutes()),CoreUtils.padLeft(t.getSeconds())].join(":")},mapMessageFromRaw:function(e,t,a){a&&(e.messageType=e.sender!=a?MessageTypes.INCOMING:MessageTypes.OUTGOING),e.receiver||(e.receiver=e.sender);var s=""+e.id,n=0==s.indexOf("m_")||0==s.indexOf("temp_")?e.id:"m_"+e.id,o={id:n,from:e.sender,fromName:e.operator?e.operatorName:e.sender,to:e.receiver,message:e.message,contentType:e.contentType,messageType:e.messageType,operator:e.operator,date:e.date,endOfConversation:e.endOfConversation,fullImageUrl:e.fullImageUrl,sending:e.sending||!1,isRead:!!e.delivered,delivered:!!e.delivered};return o},scrollIntoViewNeeded:function(e,t,a){var s=!1;a=0===arguments.length?!0:!!a;var n=window.getComputedStyle(e,null),o=parseInt(n.getPropertyValue("border-top-width")),r=parseInt(n.getPropertyValue("border-left-width")),i=t.offsetTop-e.offsetTop<e.scrollTop,c=t.offsetTop-e.offsetTop+t.clientHeight-o>e.scrollTop+e.clientHeight,l=t.offsetLeft-e.offsetLeft<e.scrollLeft,d=t.offsetLeft-e.offsetLeft+t.clientWidth-r>e.scrollLeft+e.clientWidth,m=i&&!c;return(i||c)&&a&&(e.scrollTop=t.offsetTop-e.offsetTop-e.clientHeight/2-o+t.clientHeight/2),(l||d)&&a&&(e.scrollLeft=t.offsetLeft-e.offsetLeft-e.clientWidth/2-r+t.clientWidth/2,s=!0),(i||c||l||d)&&!a&&(t.scrollIntoView(m),s=!0),s},getCoefficient:function(e,t,a){var s=Math.max(e,t),n=1;return s>a&&(n=s/a),n},getThumbnailBase64:function(e,t){var a=this,s=document.createElement("canvas"),n=new Image;n.onload=function(){var e=n.width,o=n.height,r=a.getCoefficient(e,o,1280);s.width=e/r,s.height=o/r;var i=s.getContext("2d");i.drawImage(n,0,0,s.width,s.height);var c=s.toDataURL("image/png");r=a.getCoefficient(e,o,300),s.width=e/r,s.height=o/r,i.drawImage(n,0,0,s.width,s.height);var l=s.toDataURL("image/png");s=n=null,"function"==typeof t&&t(l,c)},n.src=e},downloadImage:function(e,t,a){var s=document.createElement("img");s.src=e;var n=document.createElement("a");n.setAttribute("download",a),n.setAttribute("href",e),n.appendChild(s);var o=open();o.document.title=t,o.document.body.appendChild(n)},downloadImageByUrl:function(e,t,a){var s=document.createElement("img");s.src=e;var n=document.createElement("a");n.setAttribute("download",a),n.setAttribute("href",e),n.appendChild(s);var o=open();o.document.title=t,o.document.body.appendChild(n)},asyncLoop:function(e){var t=-1,a=e.length,s=function(){return t++,t==a?void e.callback():void e.run(s,t)};s()}},ChatActions={muteNotifications:function(){ChatDispatcher.dispatch({type:ActionTypes.MUTE_NOTIFICATION_SOUND,payload:{}})},unmuteNotifications:function(){ChatDispatcher.dispatch({type:ActionTypes.UNMUTE_NOTIFICATION_SOUND,payload:{}})},operatorStatusChanged:function(e){ChatDispatcher.dispatch({type:ActionTypes.OPERATOR_STATUS_CHANGED,payload:{status:e}})},clientStatusChanged:function(e,t,a){ChatDispatcher.dispatch({type:ActionTypes.CLIENT_STATUS_CHANGED,payload:{id:e,username:t,status:a}})},updateMessageContent:function(e,t,a){ChatDispatcher.dispatch({type:ActionTypes.UPDATE_MESSAGE_CONTENT,payload:{receiver:e,tempMessageId:t,data:a}})},outgoingMessage:function(e){var t=e.id||"m_"+ ++_lastMessageId;ChatDispatcher.dispatch({type:ActionTypes.NEW_OUT_MESSAGE,payload:{id:t,message:e.message,sender:e.sender,operatorName:e.operatorName,receiver:e.receiver,contentType:e.contentType,messageType:e.messageType,date:e.date,fullImage:e.fullImage,sending:e.sending,endOfConversation:e.endOfConversation,operator:!0}})},authSuccess:function(e){ChatDispatcher.dispatch({type:ActionTypes.AUTH_SUCCESS,operator:e})},authFail:function(e){ChatDispatcher.dispatch({type:ActionTypes.AUTH_FAIL,error:e})},incomingMessage:function(e){e.contentType==MessageContentTypes.IMAGE?ChatDispatcher.dispatch({type:ActionTypes.NEW_IN_MESSAGE,payload:{id:e.id,message:"data:image/jpg;base64,"+e.message,sender:e.sender,receiver:e.receiver,contentType:e.contentType,messageType:e.messageType||MessageTypes.INCOMING,date:e.date,endOfConversation:e.endOfConversation,fullImage:null,fullImageUrl:e.fullImageUrl,operator:e.operator,operatorName:e.operatorName},operator:AuthStore.getOperator()}):ChatDispatcher.dispatch({type:ActionTypes.NEW_IN_MESSAGE,payload:{id:e.id,message:e.message,sender:e.sender,receiver:e.receiver,contentType:e.contentType,messageType:e.messageType||MessageTypes.INCOMING,date:e.date,endOfConversation:e.endOfConversation,fullImage:null,fullImageUrl:null,operator:e.operator,operatorName:e.operatorName},operator:AuthStore.getOperator()})},readMessages:function(e){ChatDispatcher.dispatch({type:ActionTypes.READ_MESSAGES,contactId:e,changed:_preActiveContactId!=e})},clickContact:function(e){ChatDispatcher.dispatch({type:ActionTypes.CLICK_CONTACT,prevContactId:_preActiveContactId,contactId:e,changed:_activeContactId!=e})},clearSelected:function(){ChatDispatcher.dispatch({type:ActionTypes.CLEAR_SELECTED_CONTACT})},messagesScroll:function(e,t){ChatDispatcher.dispatch({type:ActionTypes.CONTACT_MESSAGES_SCROLL,contactId:e,scrollTopValue:t})},contactFilter:function(e){ChatDispatcher.dispatch({type:ActionTypes.CONTACT_FILTER,pattern:e})},fetchContacts:function(){ChatDispatcher.dispatch({type:ActionTypes.API_FETCH_CONTACTS})},authenticate:function(e){ChatDispatcher.dispatch({type:ActionTypes.API_AUTH_OPERATOR,credentials:e})},putFullImage:function(e,t){ChatDispatcher.dispatch({type:ActionTypes.PUT_FULL_IMAGE,messageId:e,imageData:t})},fetchContactHistory:function(e,t){var a=/m_|temp_/i,s=t&&+(""+t).replace(a,"");ChatDispatcher.dispatch({type:ActionTypes.API_FETCH_CONTACT_HISTORY,contact:e,firstMessageId:s})}},AuthStore=objectAssign({},EventEmitter.prototype,{errors:[],_clearErrors:function(){this.errors=[]},_addError:function(e){this.errors.push(e)},getErrors:function(){return this.errors},emitChange:function(){this.emit(ChatConstants.OPERATOR_CHANGED)},addChangeListener:function(e){this.on(ChatConstants.OPERATOR_CHANGED,e)},removeChangeListener:function(e){this.removeListener(ChatConstants.OPERATOR_CHANGED,e)},setOperator:function(e){_currentOperator=e},getOperator:function(){return _currentOperator},getStatus:function(){return this.status},setStatus:function(e){this.status=e}}),ParticipantsStore=objectAssign({},EventEmitter.prototype,{emitChange:function(){this.emit(ChatConstants.PARTICIPANTS_CHANGED)},addChangeListener:function(e){this.on(ChatConstants.PARTICIPANTS_CHANGED,e)},removeChangeListener:function(e){this.removeListener(ChatConstants.PARTICIPANTS_CHANGED,e)},getParticipants:function(e){return Object.keys(_chatParticipants[e]||{})},addParticipant:function(e){var t=!1,a=e.receiver,s=e.sender;return _chatParticipants[a]||(_chatParticipants[a]={}),s!=a&&(_chatParticipants[a][s]=1,t=!0),t}}),UnreadMessageStore=objectAssign({},EventEmitter.prototype,{emitChange:function(){this.emit(ChatConstants.MESSAGE_CHANGE_EVENT)},addChangeListener:function(e){this.on(ChatConstants.MESSAGE_CHANGE_EVENT,e)},removeChangeListener:function(e){this.removeListener(ChatConstants.MESSAGE_CHANGE_EVENT,e)},_getUnreadMessageIds:function(e){return _messages[e]&&_messages[e].unreadIds||[]},getCount:function(e){var t=this._getUnreadMessageIds(e);return t.length},getAll:function(){var e=0,t=Object.keys(_messages);for(var a in t)e+=this.getCount(t[a]);return e}}),MessageStore=objectAssign({},EventEmitter.prototype,{init:function(e){if(e&&e.length){for(var t=0,a=e.length;a>t;t++){var s=e[t];this.getMessages(s.username),_messages[s.username].unreadIds=new Array(s.unread+1).join("0").split("")}UnreadMessageStore.emitChange()}},getFirstMessageId:function(e){var t=_messages[e].messages;if(!t)return null;var a=Object.keys(t);if(!a.length)return null;var s=a[0];return t[s].id||null},getLastMessageId:function(e){var t=_messages[e].messages;if(!t)return null;var a=Object.keys(t);if(!a.length)return null;var s=a[a.length-1];return t[s].id||null},addContactRawMessages:function(e,t,a){var s={},n=[],o=!1;for(var r in a){var i=a[r],c=!0;i.contentType==MessageContentTypes.IMAGE&&(i.message="data:image/jpg;base64,"+i.message);var l=CoreUtils.mapMessageFromRaw(i,c,e.nick);s[l.id]=l,l.delivered||(o||(o=!0,l.firstUnread=!0),n.push(l.id))}return MessageStore.addHistoryMessages(t,s,n),MessageStore.emitUpdate(),UnreadMessageStore.emitChange(),n},getAll:function(){return _messages},getMessages:function(e){if(!e)return[];_messages[e]||(_messages[e]={messages:{},unreadIds:[],firstUnreadMsgId:null,init:!1});var t=[],a=_messages[e].messages;for(var s in a)t.push(a[s]);return t},addHistoryMessages:function(e,t,a){var s=null,n=_messages[e];n?(a&&a.length&&(s=a[0]),n.firstUnreadMsgId=s,n.unreadIds=[],n.messages=React.addons.update(t,{$merge:n.messages})):(a&&a.length&&(s=a[0]),_messages[e]={messages:t,unreadIds:[],firstUnreadMsgId:s})},addMessage:function(e,t,a){t.isRead=a==e,_messages[e]||(_messages[e]={messages:{},unreadIds:[],firstUnreadMsgId:null}),t.isRead||(_messages[e].unreadIds.push(t.id),null==_messages[e].firstUnreadMsgId&&(_messages[e].firstUnreadMsgId=t.id)),_messages[e].messages[t.id]=t},getUnreadMessagesIds:function(e){return e&&_messages[e]?_messages[e].unreadIds:[]},emitChange:function(){this.emit(ChatConstants.MESSAGE_CHANGE_EVENT)},emitUpdate:function(){this.emit(ChatConstants.MESSAGE_UPDATE_EVENT)},addChangeListener:function(e){this.on(ChatConstants.MESSAGE_CHANGE_EVENT,e)},removeChangeListener:function(e){this.removeListener(ChatConstants.MESSAGE_CHANGE_EVENT,e)},removeUpdateListener:function(e){this.removeListener(ChatConstants.MESSAGE_UPDATE_EVENT,e)},addUpdateListener:function(e){this.on(ChatConstants.MESSAGE_UPDATE_EVENT,e)},addOutMessage:function(e){_lastMessageId++;var t={id:e.id,from:e.operator.nick,fromName:e.operator.name,to:e.contact.name,message:e.data.message,contentType:e.type,messageType:MessageTypes.OUTGOING,endOfConversation:e.endOfConversation,operator:!0,date:e.date,isRead:!0};_messages[e.contact.name].messages[t.id]=t,this.emitChange()},unmarkFirstRead:function(e){if(e){var t=_messages[e].firstUnreadMsgId;null!=t&&(_messages[e].messages[t].firstUnread=!1)}},readMessages:function(e){var t=_messages[e].messages,a=_messages[e].unreadIds||(_messages[e].unreadIds=[]),s=_messages[e].firstUnreadMsgId;s&&(t[s].firstUnread=!1);for(var n=a.length>0,o=0,r=a.length;r>o;o++)if(0!=a[o]){var i=t[a[o]];0==o&&(i.firstUnread=!0,_messages[e].firstUnreadMsgId=i.id),i.isRead=!0}return _messages[e].unreadIds=[],n}}),ContactsStore=objectAssign({},EventEmitter.prototype,{init:function(e){for(var t=0,a=e.length;a>t;t++){var s=e[t];_contacts[s.username]={id:s.id,name:s.username,status:s.status,loadStatus:"init"}}},getCountAll:function(){return Object.keys(_contacts).length},getAll:function(){var e=[];if(_contactFilterPattern){_preActiveContactId=_activeContactId,_activeContactId=null;for(var t in _contacts){var a=_contacts[t];a.name.indexOf(_contactFilterPattern)>=0&&e.push(a)}}else for(var t in _contacts){var a=_contacts[t];e.push(a)}return e},setFilter:function(e){this.clearContact(),_contactFilterPattern=e},clearContact:function(){_preActiveContactId=_activeContactId,_activeContactId=null},emitChange:function(){this.emit(ChatConstants.CONTACTS_CHANGE_EVENT)},emitContactSelect:function(){this.emit(ChatConstants.CONTACT_SELECT_EVENT)},addChangeListener:function(e){this.on(ChatConstants.CONTACTS_CHANGE_EVENT,e)},addContactSelectListener:function(e){this.on(ChatConstants.CONTACT_SELECT_EVENT,e)},removeChangeListener:function(e){this.removeListener(ChatConstants.CONTACTS_CHANGE_EVENT,e)},removeContactSelectListener:function(e){this.removeListener(ChatConstants.CONTACT_SELECT_EVENT,e)},getActive:function(){return _activeContactId},getCurrentContact:function(){return _contacts[_activeContactId]},setActive:function(e){var t=_activeContactId!=e;_preActiveContactId=_activeContactId,_activeContactId=e,_preActiveContactId||(_preActiveContactId=_activeContactId);var a=_contacts[_activeContactId].clicks;return _contacts[_activeContactId].clicks=a&&++a||1,t},setLoadingState:function(e){_contacts[e].loadStatus="loading"},setLoadedState:function(e){_contacts[e].loadStatus="loaded"}}),ChatDispatcher=new Flux.Dispatcher;AuthStore.dispatchToken=ChatDispatcher.register(function(e){switch(e.type){case ActionTypes.AUTH_SUCCESS:AuthStore.setStatus(AuthStatuses.SUCCESS),AuthStore.setOperator(e.operator),AuthStore.emitChange();break;case ActionTypes.AUTH_FAIL:AuthStore.setStatus(AuthStatuses.ERROR),AuthStore._clearErrors(),AuthStore._addError(e.error),AuthStore.emitChange();break;case ActionTypes.OPERATOR_STATUS_CHANGED:_currentOperator.status=e.payload.status,AuthStore.emitChange()}}),ParticipantsStore.dispatchToken=ChatDispatcher.register(function(e){var t;switch(e.type){case ActionTypes.NEW_IN_MESSAGE:case ActionTypes.NEW_OUT_MESSAGE:var a=e.payload;t=ParticipantsStore.addParticipant(a),t&&ParticipantsStore.emitChange()}}),ContactsStore.dispatchToken=ChatDispatcher.register(function(e){switch(ChatDispatcher.waitFor([AuthStore.dispatchToken]),e.type){case ActionTypes.CLICK_CONTACT:var t=ContactsStore.setActive(e.contactId);t&&ContactsStore.emitContactSelect();break;case ActionTypes.CONTACT_MESSAGES_SCROLL:_contacts[e.contactId].scrollTop=e.scrollTopValue,ContactsStore.emitChange();break;case ActionTypes.CONTACT_FILTER:ContactsStore.setFilter(e.pattern),ContactsStore.emitChange();break;case ActionTypes.CLEAR_SELECTED_CONTACT:ContactsStore.clearContact();break;case ActionTypes.API_FETCH_CONTACT_HISTORY:ContactsStore.setLoadingState(e.contact.name,"loading");break;case ActionTypes.CLIENT_STATUS_CHANGED:var a=e.payload,s=_contacts[a.username];s?s.status=a.status:_contacts[a.username]={id:a.id,name:a.username,status:a.status,loadStatus:"init"},ContactsStore.emitChange()}}),MessageStore.dispatchToken=ChatDispatcher.register(function(e){ChatDispatcher.waitFor([ContactsStore.dispatchToken]);var t,a=null,s=-1;switch(e.type){case ActionTypes.CLICK_CONTACT:e.changed&&(MessageStore.unmarkFirstRead(e.prevContactId),MessageStore.emitUpdate());break;case ActionTypes.NEW_OUT_MESSAGE:var n=e.payload;a=CoreUtils.mapMessageFromRaw(n,!0);var o=a.to;t=ContactsStore.getActive(),MessageStore.addMessage(o,a,t),n.receiver==t&&MessageStore.emitUpdate(),MessageStore.emitChange();break;case ActionTypes.NEW_IN_MESSAGE:var r=e.payload;a=CoreUtils.mapMessageFromRaw(r,!1,e.operator.nick),t=ContactsStore.getActive(),MessageStore.addMessage(a.to,a,t),r.sender!=t&&r.receiver!=t||MessageStore.emitUpdate(),MessageStore.emitChange();break;case ActionTypes.CONTACT_FILTER:_preActiveContactId&&(s=_messages[_preActiveContactId].firstUnreadMsgId,null!=s&&(_messages[_preActiveContactId].messages[s].firstUnread=!1,_messages[_preActiveContactId].firstUnreadMsgId=null));break;case ActionTypes.UPDATE_MESSAGE_CONTENT:var i=e.payload,c=i.data,l=_messages[i.receiver].messages[i.tempMessageId];l.id=c.id,l.sending=!1,c.contentType==MessageContentTypes.IMAGE&&(l.fullImageUrl=c.fullImageUrl),c.receiver==t&&MessageStore.emitUpdate(),MessageStore.emitChange()}}),UnreadMessageStore.dispatchToken=ChatDispatcher.register(function(e){switch(ChatDispatcher.waitFor([ContactsStore.dispatchToken,MessageStore.dispatchToken]),e.type){case ActionTypes.READ_MESSAGES:var t=MessageStore.readMessages(e.contactId);t&&UnreadMessageStore.emitChange();break;case ActionTypes.NEW_OUT_MESSAGE:UnreadMessageStore.emitChange();break;case ActionTypes.NEW_IN_MESSAGE:UnreadMessageStore.emitChange();break;case ActionTypes.CLICK_CONTACT:e.changed&&UnreadMessageStore.emitChange();break;case ActionTypes.RECEIVE_RAW_MESSAGES:UnreadMessageStore.emitChange()}});var OperatorInfo=React.createClass({displayName:"OperatorInfo",getInitialState:function(){return{operator:AuthStore.getOperator()}},componentDidMount:function(){AuthStore.addChangeListener(this._onAuthChanged)},componentWillUnmount:function(){AuthStore.removeChangeListener(this._onAuthChanged)},_onAuthChanged:function(){this.setState({operator:AuthStore.getOperator()})},_onMuteVolumeChange:function(e){e?ChatActions.muteNotifications():ChatActions.unmuteNotifications()},render:function(){return React.createElement("div",{className:"operator-info operator-"+this.state.operator.status},React.createElement(MuteUnmuteButton,{muted:!1,onChange:this._onMuteVolumeChange}),"  ",React.createElement("i",{className:"fa fa-circle "+this.state.operator.status||"offline"}),"  ",React.createElement("b",null,this.state.operator.name)," ","("+this.state.operator.nick+")")}}),LoadMessageHistoryButton=React.createClass({displayName:"LoadMessageHistoryButton",getInitialState:function(){return{btnState:this.props.status||"init"}},_onClick:function(e){e.preventDefault(),e.stopPropagation(),"function"==typeof this.props.onClick&&this.props.onClick(),this.setState({btnState:"loading"})},componentWillReceiveProps:function(e){this.setState({btnState:e.status})},_renderState:function(){switch(this.state.btnState){case"init":return React.createElement("div",{className:"history-load",style:{textAlign:"center"}},React.createElement("span",{className:"btn-badge"},React.createElement("a",{onClick:this._onClick,href:"#"},this.props.title)));case"loading":return React.createElement("div",{className:"history-load",style:{textAlign:"center"}},React.createElement("span",{className:"btn-badge"},React.createElement("b",null,this.props.titleLoading||"Loading...")));case"loaded":return React.createElement("div",{className:"history-load",style:{textAlign:"center"}})}},render:function(){return this._renderState()}}),UploadImageButton=React.createClass({displayName:"UploadImageButton",getCoefficient:function(e,t,a){var s=Math.max(e,t),n=1;return s>a&&(n=s/a),n},_onUploadedBase64:function(e,t){this.props.onImageBase64&&this.props.onImageBase64(e,t)},_onFileChange:function(e){if("function"==typeof window.FileReader){var t=this.refs.fileUpload,a=t.files[0],s=new FileReader,n=this;s.onload=function(){var e=new Image;e.onload=function(){var e=n.refs.imageCanvas,t=n.img.width,a=n.img.height,s=n.getCoefficient(t,a,1280);e.width=t/s,e.height=a/s;var o=e.getContext("2d");o.drawImage(n.img,0,0,e.width,e.height);var r=e.toDataURL("image/png");s=n.getCoefficient(t,a,300),e.width=t/s,e.height=a/s,o.drawImage(n.img,0,0,e.width,e.height);var i=e.toDataURL("image/png");n._onUploadedBase64(i,r)},e.src=s.result,n.img=e},s.readAsDataURL(a)}},render:function(){return React.createElement("i",{className:this.props.classes,style:{position:"relative"}},React.createElement("form",{action:"#"},React.createElement("input",{style:{opacity:0,zIndex:2,left:0,top:0,width:"100%",position:"absolute"},ref:"fileUpload",type:"file",accept:"image/*",onChange:this._onFileChange})),React.createElement("canvas",{ref:"imageCanvas",style:{display:"none"}}))}}),UnreadOutgoingMessage=React.createClass({displayName:"UnreadOutgoingMessage",scrolled:!1,canScroll:function(){return!this.scrolled},scrollIntoViewIfNeeded:function(e,t){if(!this.scrolled){var a=ReactDOM.findDOMNode(this);CoreUtils.scrollIntoViewNeeded(e,a,t),this.scrolled=!0}},_onDownloadMessages:function(e){CoreUtils.downloadImageByUrl(this.props.data.fullImageUrl,"Image viewing","chat-thumbnail.png"),e.preventDefault(),e.stopPropagation()},renderMessage:function(e){return e.contentType==MessageContentTypes.TEXT?e.message||"Empty message":e.contentType==MessageContentTypes.IMAGE?React.createElement("a",{href:"#",onClick:this._onDownloadMessages},React.createElement("img",{className:"image-message",src:e.message})):void 0},operatorStatus:function(){return this.props.data.operator?React.createElement("i",{className:"msg-badge"},"operator"):""},render:function(){return React.createElement("li",{className:"message-container clearfix messages-unread"},React.createElement("span",{className:"mark"},"New messages"),React.createElement("div",{className:"message-data align-right"},React.createElement("span",{className:"message-data-time"},CoreUtils.getCurrentTime(this.props.data.date),", ",CoreUtils.timeSince(this.props.data.date)),"   ",React.createElement("span",{className:"message-data-name"},this.props.data.fromName||"Empty sender",this.operatorStatus()),"  "),React.createElement("div",{className:"message other-message float-right"},this.renderMessage(this.props.data)))}}),UnreadIncomingMessage=React.createClass({displayName:"UnreadIncomingMessage",scrolled:!1,_onDownloadMessages:function(e){CoreUtils.downloadImageByUrl(this.props.data.fullImageUrl,"Image viewing","chat-thumbnail.png"),e.preventDefault(),e.stopPropagation()},renderMessage:function(e){return e.contentType==MessageContentTypes.TEXT?e.message||"Empty message":e.contentType==MessageContentTypes.IMAGE?React.createElement("a",{href:"#",onClick:this._onDownloadMessages},React.createElement("img",{className:"image-message",src:e.message})):void 0},scrollIntoViewIfNeeded:function(e,t){if(!this.scrolled){var a=ReactDOM.findDOMNode(this);CoreUtils.scrollIntoViewNeeded(e,a,t),this.scrolled=!0}},canScroll:function(){return!this.scrolled},_operatorStatus:function(){return this.props.data.operator?React.createElement("i",{className:"msg-badge"},"operator"):""},_operatorMsgClasses:function(){return this.props.data.operator?" other-operator":""},render:function(){return React.createElement("li",{className:"message-container messages-unread"},React.createElement("span",{className:"mark"},"New messages"),React.createElement("div",{className:"message-data"},React.createElement("span",{className:"message-data-name"},this.props.data.fromName||"Not specified",this._operatorStatus()),React.createElement("span",{className:"message-data-time"},CoreUtils.getCurrentTime(this.props.data.date),", ",CoreUtils.timeSince(this.props.data.date))),React.createElement("div",{className:"message my-message"+this._operatorMsgClasses()},this.renderMessage(this.props.data)))}}),UnreadEndConversationMessage=React.createClass({displayName:"UnreadEndConversationMessage",scrolled:!1,scrollIntoViewIfNeeded:function(e,t){if(!this.scrolled){var a=ReactDOM.findDOMNode(this);CoreUtils.scrollIntoViewNeeded(e,a,t),this.scrolled=!0}},canScroll:function(){return!this.scrolled},renderMessage:function(e){return React.createElement("div",{className:"message-resolved"})},operatorStatus:function(){return this.props.data.operator?React.createElement("i",{className:"msg-badge"},"operator"):""},render:function(){return React.createElement("li",{className:"message-container clearfix messages-unread"},React.createElement("span",{className:"mark"},"New messages"),React.createElement("div",{className:"message-data align-right"},React.createElement("span",{className:"message-data-time"},CoreUtils.getCurrentTime(this.props.data.date),", ",CoreUtils.timeSince(this.props.data.date)),"   ",React.createElement("span",{className:"message-data-name"},this.props.data.fromName||"Empty sender",this.operatorStatus()),"  "),this.renderMessage(this.props.data))}}),TypingMessage=React.createClass({displayName:"TypingMessage",render:function(){var e=function(){return(new Date).toLocaleTimeString().replace(/([\d]+:[\d]{2})(:[\d]{2})(.*)/,"$1$3")};return React.createElement("li",null,React.createElement("div",{className:"message-data"},React.createElement("span",{className:"message-data-name"},React.createElement("i",{className:"fa fa-circle online"}),this.props.phone||"Not specified"),React.createElement("span",{className:"message-data-time"},this.props.time||e())),React.createElement("i",{className:"fa fa-circle online"}),React.createElement("i",{className:"fa fa-circle online",style:{color:"#AED2A6"}}),React.createElement("i",{className:"fa fa-circle online",style:{color:"#DAE9DA"}}))}}),OutgoingMessage=React.createClass({displayName:"OutgoingMessage",canScroll:function(){return!0},scrollIntoViewIfNeeded:function(e,t){var a=ReactDOM.findDOMNode(this);CoreUtils.scrollIntoViewNeeded(e,a,t)},_onDownloadMessages:function(e){CoreUtils.downloadImageByUrl(this.props.data.fullImageUrl,"Image viewing","chat-thumbnail.png"),e.preventDefault(),e.stopPropagation()},operatorStatus:function(){return this.props.data.operator?React.createElement("i",{className:"msg-badge"},"operator"):""},renderSendIndicator:function(e){return e.sending?React.createElement("span",{className:"fa fa-refresh fa-spin fa-fw send-icon"}):""},renderMessage:function(e){return e.contentType==MessageContentTypes.TEXT?e.message||"Empty message":e.contentType==MessageContentTypes.IMAGE?React.createElement("a",{href:"#",onClick:this._onDownloadMessages},React.createElement("img",{className:"image-message",src:e.message})):void 0},render:function(){return React.createElement("li",{className:"clearfix"},React.createElement("div",{className:"message-data align-right"},React.createElement("span",{className:"message-data-time"},CoreUtils.getCurrentTime(this.props.data.date),", ",CoreUtils.timeSince(this.props.data.date)),"   ",React.createElement("span",{className:"message-data-name"},this.props.data.fromName||"Empty sender",this.operatorStatus()),"  "),React.createElement("div",{className:"message other-message float-right"},this.renderMessage(this.props.data),this.renderSendIndicator(this.props.data)))}}),MinChatBox=React.createClass({displayName:"MinChatBox",getInitialState:function(){return{clientsCount:ContactsStore.getCountAll(),unreadCount:UnreadMessageStore.getAll()}},componentDidMount:function(){UnreadMessageStore.addChangeListener(this._onUnreadChange),ContactsStore.addChangeListener(this._onContactsChanged)},componentWillUnmount:function(){UnreadMessageStore.removeChangeListener(this._onUnreadChange),ContactsStore.removeChangeListener(this._onContactsChanged)},_onContactsChanged:function(){
var e=ContactsStore.getCountAll();this.setState({clientsCount:e})},_onUnreadChange:function(){var e=UnreadMessageStore.getAll();this.setState({unreadCount:e})},_maximizeClicked:function(){"function"==typeof this.props.onMaximize&&this.props.onMaximize()},render:function(){return React.createElement("div",{className:"chat-container min-container clearfix"},React.createElement("div",{className:"msg-count center-text bg-"+this.props.status},React.createElement("div",{className:"status"},React.createElement("i",{className:"fa fa-circle "+this.props.status||"offline"}),this.props.status),React.createElement("div",null,"Clients: ",React.createElement("i",{className:"clients-badge"},this.state.clientsCount))),React.createElement("div",{className:"chat-info"},"New: ",React.createElement("span",{className:"msg-badge unread"},this.state.unreadCount),React.createElement(IconButton,{onClick:this._maximizeClicked,classes:"fa fa-2x fa-plus-square maximize-icon"})))}}),EmptyMinChatBox=React.createClass({displayName:"EmptyMinChatBox",_maximizeClicked:function(){"function"==typeof this.props.onMaximize&&this.props.onMaximize()},render:function(){return React.createElement("div",{className:"chat-container min-container clearfix"},React.createElement("div",{className:"msg-count-empty center-text"},"Chat"),React.createElement("div",{className:"chat-info"},React.createElement(IconButton,{onClick:this._maximizeClicked,classes:"fa fa-2x fa-plus-square maximize-icon"})))}}),LoginBox=React.createClass({displayName:"LoginBox",componentDidMount:function(){AuthStore.addChangeListener(this._onAuthChanged)},componentWillUnmount:function(){AuthStore.removeChangeListener(this._onAuthChanged)},getInitialState:function(){return{loginState:this.props.initialLoginState||"login",error:!1,messages:AuthStore.getErrors()}},_onAuthChanged:function(){AuthStore.getStatus()===AuthStatuses.SUCCESS?(this.successState(),"function"==typeof this.props.onAuthSuccess&&setTimeout(function(){this.props.onAuthSuccess(AuthStore.getOperator())}.bind(this),1e3)):this.tryAgainState()},_onMinimize:function(){this.setState({loginState:"min",originalState:this.state.loginState})},_onMaximize:function(){this.setState({loginState:this.state.originalState})},progressState:function(){this.setState({loginState:"progress",originalState:"progress"})},successState:function(){this.setState({loginState:"success",originalState:"success",error:!1,messages:[]})},tryAgainState:function(){this.setState({loginState:"login",originalState:"login",error:!0,messages:AuthStore.getErrors()})},loginClick:function(e){this.progressState(),ChatActions.authenticate()},_renderErrorInfo:function(){return this.state.error?React.createElement("div",{className:"error-box"},React.createElement("ul",null,this.state.messages.map(function(e){return React.createElement("li",null,e)}))):""},renderState:function(){switch(this.state.loginState){case"min":return React.createElement(EmptyMinChatBox,{onMaximize:this._onMaximize});case"login":return React.createElement("div",{className:"chat"},React.createElement(EmptyHeaderBox,{onMinimize:this._onMinimize}),React.createElement("div",{className:"wrapper"},this._renderErrorInfo(),React.createElement("button",{className:"login-btn",onClick:this.loginClick},React.createElement("i",{className:"chat-spinner"}),React.createElement("span",{className:"state"},"Log in"))));case"progress":return React.createElement("div",{className:"chat"},React.createElement(EmptyHeaderBox,{onMinimize:this._onMinimize}),React.createElement("div",{className:"wrapper loading"},React.createElement("button",{className:"login-btn"},React.createElement("i",{className:"chat-spinner"}),React.createElement("span",{className:"state"},"Authenticating"))));case"success":return React.createElement("div",{className:"chat"},React.createElement(EmptyHeaderBox,{onMinimize:this._onMinimize}),React.createElement("div",{className:"wrapper ok loading"},React.createElement("button",{className:"login-btn"},React.createElement("i",{className:"chat-spinner"}),React.createElement("span",{className:"state"},"Welcome back!"))))}},render:function(){return this.renderState()}}),IncomingMessage=React.createClass({displayName:"IncomingMessage",_onDownloadMessages:function(e){CoreUtils.downloadImageByUrl(this.props.data.fullImageUrl,"Image viewing","chat-thumbnail.png"),e.preventDefault(),e.stopPropagation()},renderMessage:function(e){return e.contentType==MessageContentTypes.TEXT?e.message||"Empty message":e.contentType==MessageContentTypes.IMAGE?React.createElement("a",{href:"#",onClick:this._onDownloadMessages},React.createElement("img",{className:"image-message",src:e.message})):void 0},operatorStatus:function(){return this.props.data.operator?React.createElement("i",{className:"msg-badge"},"operator"):""},_operatorMsgClasses:function(){return this.props.data.operator?" other-operator":""},render:function(){return React.createElement("li",null,React.createElement("div",{className:"message-data"},React.createElement("span",{className:"message-data-name"},this.props.data.fromName||"Not specified",this.operatorStatus()),React.createElement("span",{className:"message-data-time"},CoreUtils.getCurrentTime(this.props.data.date),", ",CoreUtils.timeSince(this.props.data.date))),React.createElement("div",{className:"message my-message"+this._operatorMsgClasses()},this.renderMessage(this.props.data)))}}),MuteUnmuteButton=React.createClass({displayName:"MuteUnmuteButton",_styles:{cursor:"pointer"},getInitialState:function(){return{muted:this.props.muted||!1}},getClasses:function(){var e="msg-badge badge-sm ";return this.state.muted?e+"fa fa-volume-off":e+"fa fa-volume-up"},_onClick:function(){"function"==typeof this.props.onChange&&this.props.onChange(!this.state.muted),this.setState({muted:!this.state.muted})},render:function(){return React.createElement("i",{style:this._styles,onClick:this._onClick,className:this.getClasses()})}}),IconButton=React.createClass({displayName:"IconButton",render:function(){return React.createElement("i",{onClick:this.props.onClick||function(){},className:this.props.classes})}}),HistoryButton=React.createClass({displayName:"HistoryButton",render:function(){return React.createElement("button",{onClick:this.props.onClick,className:this.props.classes},React.createElement("i",{className:this.props.icons}),"  ",this.props.title||"")}}),HistoryBox=React.createClass({displayName:"HistoryBox",scroll:0,canScroll:!0,renderMessage:function(e){var t=this.props.contact;switch(e.messageType){case MessageTypes.INCOMING:return e.firstUnread?e.endOfConversation?React.createElement(UnreadEndConversationMessage,{key:e.id,data:e,status:t.status}):React.createElement(UnreadIncomingMessage,{ref:"unreadItem",key:e.id,data:e,status:t.status}):e.endOfConversation?React.createElement(EndConversationMessage,{key:e.id,data:e,status:t.status}):React.createElement(IncomingMessage,{key:e.id,data:e,status:t.status});case MessageTypes.OUTGOING:return e.firstUnread?e.endOfConversation?React.createElement(UnreadEndConversationMessage,{key:e.id,data:e,status:t.status}):React.createElement(UnreadOutgoingMessage,{ref:"unreadItem",key:e.id,data:e,status:t.status}):e.endOfConversation?React.createElement(EndConversationMessage,{key:e.id,data:e,status:t.status}):React.createElement(OutgoingMessage,{key:e.id,data:e,status:t.status})}},_scrollToFirstUnread:function(){var e=this.refs.unreadItem,t=ReactDOM.findDOMNode(this);e&&e.canScroll()?(this.refs.unreadItem.scrollIntoViewIfNeeded(t,!0),this.scroll=t.scrollHeight-t.offsetHeight):this.canScroll&&(t.scrollTop=t.scrollHeight,this.scroll=t.scrollHeight-t.offsetHeight)},_onLoadHistory:function(){"function"==typeof this.props.onLoadHistory&&this.props.onLoadHistory(this.props.contact)},componentDidMount:function(){this._scrollToFirstUnread()},componentWillUpdate:function(e,t){e.contact.id!=this.props.contact.id&&(this.scroll=0);var a=ReactDOM.findDOMNode(this);this.canScroll=!this.props.messages.length||a.scrollTop>=this.scroll},componentDidUpdate:function(){this._scrollToFirstUnread()},render:function(){var e=this.renderMessage;return React.createElement("div",{className:"chat-history"},React.createElement(LoadMessageHistoryButton,{status:this.props.contact.loadStatus,onClick:this._onLoadHistory,title:"Load history",titleLoading:"Loading..."}),React.createElement("ul",{className:"chat-history-messages"},this.props.messages.map(function(t){return e(t)})))}}),HeaderBox=React.createClass({displayName:"HeaderBox",closeClicked:function(e){"function"==typeof this.props.onClose&&this.props.onClose()},_minimizeClicked:function(e){"function"==typeof this.props.onMinimize&&this.props.onMinimize()},render:function(){return React.createElement("div",{className:"chat-header clearfix"},React.createElement("div",{className:"chat-about"},React.createElement("div",{className:"chat-with"}," Chat with: ",this.props.contact.name||""),React.createElement("div",{className:"chat-num-messages"},"already",React.createElement("i",{className:"msg-badge"},this.props.count||0),"messages")),React.createElement(IconButton,{onClick:this.closeClicked,classes:"fa fa-times header-icon"}),React.createElement(IconButton,{onClick:this._minimizeClicked,classes:"fa fa-minus-square header-icon"}))}}),FooterBox=React.createClass({displayName:"FooterBox",getInitialState:function(){return{value:""}},sendMessage:function(e){if(""!==this.state.value.trim()){var t=new Date,a={id:"temp_"+ ++_lastMessageId,message:this.state.value,sender:this.props.operator.nick,operatorName:this.props.operator.name,receiver:this.props.contact.name,contentType:MessageContentTypes.TEXT,messageType:MessageTypes.OUTGOING,endOfConversation:!1,date:t,sending:!0,fullImage:null};ChatActions.outgoingMessage(a),this.setState({value:""})}},sendEndMessage:function(e){var t=new Date,a={id:"temp_"+ ++_lastMessageId,message:"End of conversation",sender:this.props.operator.nick,operatorName:this.props.operator.name,receiver:this.props.contact.name,contentType:MessageContentTypes.TEXT,messageType:MessageTypes.OUTGOING,endOfConversation:!0,date:t,sending:!0,fullImage:null};ChatActions.outgoingMessage(a)},handleChange:function(e){this.setState({value:e.target.value})},handleKeyUp:function(e){e.keyCode===KeyConstants.ENTER_KEY&&this.sendMessage()},_onImageUpload:function(e,t){var a=new Date,s={id:null,message:e,sender:this.props.operator.nick,operatorName:this.props.operator.name,receiver:this.props.contact.name,contentType:MessageContentTypes.IMAGE,messageType:MessageTypes.OUTGOING,endOfConversation:!1,date:a,sending:!0,fullImage:t};ChatActions.outgoingMessage(s)},render:function(){return React.createElement("div",{className:"chat-message clearfix"},React.createElement("textarea",{name:"message-to-send",id:"message-to-send",placeholder:"Type your message",value:this.state.value,onChange:this.handleChange,onKeyUp:this.handleKeyUp,rows:"2"}),React.createElement(IconButton,{classes:"fa fa-file-o"}),"   ",React.createElement(UploadImageButton,{onImageBase64:this._onImageUpload,classes:"fa fa-file-image-o"}),React.createElement(HistoryButton,{onClick:this.sendMessage,title:"send",icons:"fa fa-paper-plane-o",classes:"btn-send"}),React.createElement(HistoryButton,{onClick:this.sendEndMessage,title:"end",icons:"fa fa-comments",classes:"btn-replied"}))}}),EndConversationMessage=React.createClass({displayName:"EndConversationMessage",operatorStatus:function(){return this.props.data.operator?React.createElement("i",{className:"msg-badge"},"operator"):""},renderMessage:function(e){return React.createElement("div",{className:"message-resolved"})},render:function(){return React.createElement("li",{className:"clearfix"},React.createElement("div",{className:"message-data align-right"},React.createElement("span",{className:"message-data-time"},CoreUtils.getCurrentTime(this.props.data.date),", ",CoreUtils.timeSince(this.props.data.date)),"   ",React.createElement("span",{className:"message-data-name"},this.props.data.fromName||"Empty sender",this.operatorStatus()),"  "),this.renderMessage(this.props.data))}}),EmptyHeaderBox=React.createClass({displayName:"EmptyHeaderBox",_onMinimize:function(){"function"==typeof this.props.onMinimize&&this.props.onMinimize()},render:function(){return React.createElement("div",{className:"chat-header clearfix"},React.createElement(IconButton,{onClick:this._onMinimize,classes:"fa fa-minus-square header-icon"}))}}),EmptyConversationBox=React.createClass({displayName:"EmptyConversationBox",_onMinimize:function(){"function"==typeof this.props.onMinimize&&this.props.onMinimize()},render:function(){return React.createElement("div",{className:"chat"},React.createElement(EmptyHeaderBox,{onMinimize:this._onMinimize}),React.createElement(EmptyChatBox,null))}}),EmptyChatBox=React.createClass({displayName:"EmptyChatBox",render:function(){return React.createElement("div",{className:"wrapper no-conversation"},React.createElement("div",null,React.createElement("i",{className:"fa fa-4x fa-comment"})),React.createElement("span",{className:"state"},"No conversation"))}}),ConversationBox=React.createClass({displayName:"ConversationBox",_onClose:function(){"function"==typeof this.props.onClose&&this.props.onClose()},_onMinimize:function(){"function"==typeof this.props.onMinimize&&this.props.onMinimize()},_onOutMessage:function(e){"function"==typeof this.props.onOutgoingMessage&&this.props.onOutgoingMessage(e)},_onLoadHistory:function(e){"function"==typeof this.props.onLoadHistory&&this.props.onLoadHistory(e)},render:function(){return React.createElement("div",{className:"chat"},React.createElement(HeaderBox,{contact:this.props.contact,count:this.props.messages.length,onClose:this._onClose,onMinimize:this._onMinimize}),React.createElement(HistoryBox,{contact:this.props.contact,messages:this.props.messages,onLoadHistory:this._onLoadHistory}),React.createElement(FooterBox,{operator:this.props.operator,contact:this.props.contact,onMessage:this._onOutMessage}))}}),ContactsListBox=React.createClass({displayName:"ContactsListBox",onActivateContact:function(e){"function"==typeof this.props.onSelectContact&&this.props.onSelectContact(e)},render:function(){var e=this.props.current?this.props.current.name:null,t=this.onActivateContact;return React.createElement("ul",{className:"list"},this.props.items.map(function(a){return React.createElement(Contact,{key:a.id,data:a,selectedId:e,onActivate:t})}))}}),ContactSearchBox=React.createClass({displayName:"ContactSearchBox",getInitialState:function(){return{value:""}},_handleChange:function(e){this.setState({value:e.target.value}),"function"==typeof this.props.onLiveSearch&&this.props.onLiveSearch(e.target.value)},_handleKeyUp:function(e){e.keyCode===KeyConstants.ENTER_KEY&&this._onSearch()},_onSearch:function(){"function"==typeof this.props.onSearch&&this.props.onSearch(this.state.value)},_onClear:function(){this.setState({value:""}),"function"==typeof this.props.onClear&&this.props.onClear()},render:function(){return React.createElement("div",{className:"search"},React.createElement("input",{className:"search-input",onChange:this._handleChange,onKeyUp:this._handleKeyUp,type:"text",placeholder:"search",value:this.state.value}),React.createElement("i",{onClick:this._onSearch,className:"fa fa-search"}),React.createElement("i",{onClick:this._onClear,className:"fa fa-close"}))}}),ContactsBox=React.createClass({displayName:"ContactsBox",_onSearch:function(e){ChatActions.contactFilter(e)},_onClear:function(){ChatActions.contactFilter("")},_onLiveSearch:function(e){ChatActions.contactFilter(e)},_onSelectContact:function(e){"function"==typeof this.props.onSelectContact&&this.props.onSelectContact(e)},render:function(){return React.createElement("div",{className:"people-list",id:"people-list"},React.createElement(ContactSearchBox,{onLiveSearch:this._onLiveSearch,onSearch:this._onSearch,onClear:this._onClear}),React.createElement(OperatorInfo,null),React.createElement(ContactsListBox,{items:this.props.contacts,current:this.props.current,onSelectContact:this._onSelectContact}))}}),Contact=React.createClass({displayName:"Contact",getInitialState:function(){var e=UnreadMessageStore.getCount(this.props.data.name),t=ParticipantsStore.getParticipants(this.props.data.name);return{active:!1,unread:e,participants:t}},componentDidMount:function(){UnreadMessageStore.addChangeListener(this._onUnreadChange),ParticipantsStore.addChangeListener(this._participantsChange)},componentWillUnmount:function(){UnreadMessageStore.removeChangeListener(this._onUnreadChange),ParticipantsStore.removeChangeListener(this._participantsChange)},_onUnreadChange:function(){var e=UnreadMessageStore.getCount(this.props.data.name);this.setState({unread:e})},_participantsChange:function(){var e=ParticipantsStore.getParticipants(this.props.data.name);e.length>0&&this.setState({participants:e})},_getParticipants:function(){return this.state.participants?React.createElement("span",null,this.state.participants.map(function(e,t){return React.createElement("span",{key:t,className:"msg-badge badge-sm"},e)})):""},activateContact:function(){"function"==typeof this.props.onActivate&&this.props.onActivate(this.props.data)},getUnreadMessageCount:function(){return this.state.unread?React.createElement("i",{className:"msg-badge unread"},this.state.unread||0):""},clientActive:function(){var e=this.props.data;return this.props.selectedId==e.name?" active":""},render:function(){return React.createElement("li",{className:"contact clearfix"+this.clientActive(),onClick:this.activateContact},React.createElement("div",{className:"about"},React.createElement("div",{className:"name"},this.props.data.name||"+000000000000"),React.createElement("div",{className:"status"},React.createElement("i",{className:"fa fa-circle "+this.props.data.status||"offline"}),this.props.data.status||"offline"),React.createElement("div",null,this._getParticipants()),React.createElement("div",{className:"msg-unread"},this.getUnreadMessageCount())))}}),ChatBox=React.createClass({displayName:"ChatBox",getInitialState:function(){return{chatState:this.props.initialChatState||"login",contacts:[],messages:[],currentContact:{},operator:{},unread:0}},componentDidMount:function(){AuthStore.addChangeListener(this._onAuthChanged),ContactsStore.addChangeListener(this._storeContactsChange),ContactsStore.addContactSelectListener(this._storeContactSelect),MessageStore.addUpdateListener(this._storeMessagesChange)},componentWillUnmount:function(){AuthStore.removeChangeListener(this._onAuthChanged),ContactsStore.removeChangeListener(this._storeContactsChange),ContactsStore.removeContactSelectListener(this._storeContactSelect),MessageStore.removeUpdateListener(this._storeMessagesChange)},_onAuthChanged:function(){this.setState({operator:AuthStore.getOperator()})},_onSelectContact:function(e){if(ChatActions.clickContact(e.name),ChatActions.readMessages(e.name),"init"==e.loadStatus){var t=MessageStore.getFirstMessageId(e.name);ChatActions.fetchContactHistory(e,t)}},_storeContactSelect:function(){var e=ContactsStore.getCurrentContact();this.setState({chatState:"chat",currentContact:e})},_storeContactsChange:function(){var e=ContactsStore.getCurrentContact(),t=e&&e.name||null;this.setState({chatState:e?"chat":"no-chat",currentContact:e,messages:MessageStore.getMessages(t),contacts:ContactsStore.getAll()})},_storeMessagesChange:function(){var e=ContactsStore.getCurrentContact();e&&this.setState({currentContact:e,messages:MessageStore.getMessages(e.name)})},authSuccess:function(e){this.setState({operator:e,chatState:"no-chat"}),ChatActions.fetchContacts()},onConversationClose:function(){this.setState({chatState:"no-chat",messages:[],currentContact:{}}),ChatActions.clearSelected()},_onMinimize:function(){this.setState({chatState:"min",messages:[],currentContact:{}}),ChatActions.clearSelected()},_onMaximize:function(){this.setState({chatState:"no-chat",messages:[],currentContact:{}})},_onLoadHistory:function(e){var t=MessageStore.getFirstMessageId(e.name);ChatActions.fetchContactHistory(e,t)},onOutgoingMessage:function(e){var t=this.state.operator,a=this.state.currentContact;MessageStore.addOutMessage({contact:a,operator:t,data:e,type:MessageContentTypes.TEXT})},renderState:function(){switch(this.state.chatState||"login"){case"min":return React.createElement(MinChatBox,{onMaximize:this._onMaximize,status:this.state.operator.status});case"login":return React.createElement("div",{id:"chat-template",className:"chat-container clearfix"},React.createElement(LoginBox,{onAuthSuccess:this.authSuccess}));case"chat":return React.createElement("div",{id:"chat-template",className:"chat-container clearfix"},React.createElement(ContactsBox,{current:this.state.currentContact,contacts:this.state.contacts,onSelectContact:this._onSelectContact}),React.createElement(ConversationBox,{contact:this.state.currentContact,operator:this.state.operator,messages:this.state.messages,onClose:this.onConversationClose,onMinimize:this._onMinimize,onOutgoingMessage:this.onOutgoingMessage,onLoadHistory:this._onLoadHistory}));case"no-chat":return React.createElement("div",{id:"chat-template",className:"chat-container clearfix"},React.createElement(ContactsBox,{contacts:this.state.contacts,onSelectContact:this._onSelectContact}),React.createElement(EmptyConversationBox,{onMinimize:this._onMinimize}))}},render:function(){return this.renderState()}}),chatBox=ReactDOM.render(React.createElement(ChatBox,null),document.getElementById("chatbox"),function(){if("function"==typeof window.OkkChatReady){var e={Dispatcher:ChatDispatcher,ActionTypes:ActionTypes,Actions:ChatActions,Stores:{AuthStore:AuthStore,ContactsStore:ContactsStore,MessageStore:MessageStore,ParticipantsStore:ParticipantsStore,UnreadMessageStore:UnreadMessageStore},MessageTypes:MessageTypes,MessageContentTypes:MessageContentTypes,CoreUtils:CoreUtils};window.OkkChatReady(e)}});