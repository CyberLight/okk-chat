!function e(t,a,n){function s(r,c){if(!a[r]){if(!t[r]){var o="function"==typeof require&&require;if(!c&&o)return o(r,!0);if(i)return i(r,!0);throw new Error("Cannot find module '"+r+"'")}var l=a[r]={exports:{}};t[r][0].call(l.exports,function(e){var a=t[r][1][e];return s(a?a:e)},l,l.exports,e,t,a,n)}return a[r].exports}for(var i="function"==typeof require&&require,r=0;r<n.length;r++)s(n[r]);return s}({1:[function(e,t,a){var n=1,s={},i={},r={},c={};window._messages=s;var o,l,m,d="",p={IMAGE:"image",TEXT:"text"},u={INCOMING:"in",OUTGOING:"out",END_OF_CONVERSATION:"end-of-conversation"},h={MESSAGE_CHANGE_EVENT:"MESSAGE_CHANGED_EVENT",CONTACT_SELECT_EVENT:"CONTACT_SELECT_EVENT",MESSAGE_UPDATE_EVENT:"MESSAGE_UPDATE_EVENT",CONTACTS_CHANGE_EVENT:"CONTACTS_CHANGE_EVENT",FULL_IMAGES_CHANGE_EVENT:"FULL_IMAGES_CHANGE_EVENT",OPERATOR_CHANGED:"OPERATOR_CHANGED",PARTICIPANTS_CHANGED:"PARTICIPANTS_CHANGED"},g={CLICK_CONTACT:"CLICK_CONTACT",RECEIVE_RAW_MESSAGES:"RECEIVE_RAW_MESSAGES",NEW_OUT_MESSAGE:"NEW_OUT_MESSAGE",NEW_IN_MESSAGE:"NEW_IN_MESSAGE",READ_MESSAGES:"READ_MESSAGES",CONTACT_MESSAGES_SCROLL:"CONTACT_MESSAGES_SCROLL",CONTACT_FILTER:"CONTACT_FILTER",CLEAR_SELECTED_CONTACT:"CLEAR_SELECTED_CONTACT",AUTH_SUCCESS:"AUTH_SUCCESS",AUTH_FAIL:"AUTH_FAIL",PUT_FULL_IMAGE:"PUT_FULL_IMAGE",API_FETCH_CONTACTS:"API_FETCH_CONTACTS",API_AUTH_OPERATOR:"API_AUTH_OPERATOR",API_FETCH_CONTACT_MESSAGES:"API_FETCH_CONTACT_MESSAGES",API_FETCH_CONTACT_HISTORY:"API_FETCH_CONTACT_HISTORY"},f={SUCCESS:1,ERROR:2},E={ENTER_KEY:13},C={padLeft:function(e,t,a){var n=String(t||10).length-String(e).length+1;return n>0?new Array(n).join(a||"0")+e:e},getCurrentTime:function(e){var t=new Date(e)||new Date;return t.toLocaleTimeString().replace(/([\d]+:[\d]{2})(:[\d]{2})(.*)/,"$1$3")},formatDate:function(e){var t;return t="string"==typeof e?new Date(e):"object"==typeof e&&e.constructor==Date?e:new Date,[t.getFullYear(),C.padLeft(t.getMonth()+1),C.padLeft(t.getDate())].join("-")+" "+[C.padLeft(t.getHours()),C.padLeft(t.getMinutes()),C.padLeft(t.getSeconds())].join(":")},mapMessageFromRaw:function(e,t,a){var n=e.messageType;n!=u.END_OF_CONVERSATION&&a&&(e.messageType=e.sender!=a?u.INCOMING:u.OUTGOING),e.receiver||(e.receiver=e.sender);var s={id:e.id,from:e.sender,to:e.receiver,message:e.message,contentType:e.contentType,messageType:e.messageType,operator:e.operator,date:e.date,isRead:!!t};return s},scrollIntoViewNeeded:function(e,t,a){var n=!1;a=0===arguments.length?!0:!!a;var s=window.getComputedStyle(e,null),i=parseInt(s.getPropertyValue("border-top-width")),r=parseInt(s.getPropertyValue("border-left-width")),c=t.offsetTop-e.offsetTop<e.scrollTop,o=t.offsetTop-e.offsetTop+t.clientHeight-i>e.scrollTop+e.clientHeight,l=t.offsetLeft-e.offsetLeft<e.scrollLeft,m=t.offsetLeft-e.offsetLeft+t.clientWidth-r>e.scrollLeft+e.clientWidth,d=c&&!o;return(c||o)&&a&&(e.scrollTop=t.offsetTop-e.offsetTop-e.clientHeight/2-i+t.clientHeight/2),(l||m)&&a&&(e.scrollLeft=t.offsetLeft-e.offsetLeft-e.clientWidth/2-r+t.clientWidth/2,n=!0),(c||o||l||m)&&!a&&(t.scrollIntoView(d),n=!0),n},getCoefficient:function(e,t,a){var n=Math.max(e,t),s=1;return n>a&&(s=n/a),s},getThumbnailBase64:function(e,t){var a=this,n=document.createElement("canvas"),s=new Image;s.onload=function(){var e=s.width,i=s.height,r=a.getCoefficient(e,i,1280);n.width=e/r,n.height=i/r;var c=n.getContext("2d");c.drawImage(s,0,0,n.width,n.height);var o=n.toDataURL("image/png");r=a.getCoefficient(e,i,150),n.width=e/r,n.height=i/r,c.drawImage(s,0,0,n.width,n.height);var l=n.toDataURL("image/png");n=s=null,"function"==typeof t&&t(l,o)},s.src=e},downloadImage:function(e,t,a){var n=document.createElement("img");n.src=e;var s=document.createElement("a");s.setAttribute("download",a),s.setAttribute("href",e),s.appendChild(n);var i=open();i.document.title=t,i.document.body.appendChild(s)},asyncLoop:function(e){var t=-1,a=e.length,n=function(){return t++,t==a?void e.callback():void e.run(n,t)};n()}},N={outgoingMessage:function(e){var t=e.id||"m_"+ ++n;y.dispatch({type:g.NEW_OUT_MESSAGE,payload:{id:t,message:e.message,sender:e.sender.name,receiver:e.receiver.name,contentType:e.contentType,messageType:e.messageType,date:e.date,fullImage:e.fullImage,operator:!0}})},authSuccess:function(e){y.dispatch({type:g.AUTH_SUCCESS,operator:e})},authFail:function(e){y.dispatch({type:g.AUTH_FAIL,error:e})},incomingMessage:function(e){e.contentType==p.IMAGE?C.getThumbnailBase64(e.message,function(t,a){y.dispatch({type:g.NEW_IN_MESSAGE,payload:{id:e.id,message:t,sender:e.sender,receiver:e.receiver,contentType:e.contentType,messageType:e.messageType||u.INCOMING,date:e.date,fullImage:a,operator:e.operator}})}):y.dispatch({type:g.NEW_IN_MESSAGE,payload:{id:e.id,message:e.message,sender:e.sender,receiver:e.receiver,contentType:e.contentType,messageType:e.messageType||u.INCOMING,date:e.date,fullImage:null,operator:e.operator}})},readMessages:function(e){y.dispatch({type:g.READ_MESSAGES,contactId:e,changed:l!=e})},clickContact:function(e){y.dispatch({type:g.CLICK_CONTACT,prevContactId:l,contactId:e,changed:o!=e})},clearSelected:function(){y.dispatch({type:g.CLEAR_SELECTED_CONTACT})},messagesScroll:function(e,t){y.dispatch({type:g.CONTACT_MESSAGES_SCROLL,contactId:e,scrollTopValue:t})},contactFilter:function(e){y.dispatch({type:g.CONTACT_FILTER,pattern:e})},fetchContacts:function(){y.dispatch({type:g.API_FETCH_CONTACTS})},authenticate:function(e){y.dispatch({type:g.API_AUTH_OPERATOR,credentials:e})},putFullImage:function(e,t){y.dispatch({type:g.PUT_FULL_IMAGE,messageId:e,imageData:t})},fetchContactHistory:function(e){y.dispatch({type:g.API_FETCH_CONTACT_HISTORY,contact:e})}},S=objectAssign({},EventEmitter.prototype,{emitChange:function(){this.emit(h.OPERATOR_CHANGED)},addChangeListener:function(e){this.on(h.OPERATOR_CHANGED,e)},removeChangeListener:function(e){this.removeListener(h.OPERATOR_CHANGED,e)},setOperator:function(e){m=e},getOperator:function(){return m},getStatus:function(){return this.status},setStatus:function(e){this.status=e}}),_=objectAssign({},EventEmitter.prototype,{emitChange:function(){this.emit(h.PARTICIPANTS_CHANGED)},addChangeListener:function(e){this.on(h.PARTICIPANTS_CHANGED,e)},removeChangeListener:function(e){this.removeListener(h.PARTICIPANTS_CHANGED,e)},getParticipants:function(e){return Object.keys(c[e]||{})},addParticipant:function(e){var t=!1,a=e.receiver,n=e.sender;return c[a]||(c[a]={}),n!=a&&(c[a][n]=1,t=!0),t}}),T=objectAssign({},EventEmitter.prototype,{emitChange:function(){this.emit(h.FULL_IMAGES_CHANGE_EVENT)},addChangeListener:function(e){this.on(h.FULL_IMAGES_CHANGE_EVENT,e)},removeChangeListener:function(e){this.removeListener(h.FULL_IMAGES_CHANGE_EVENT,e)},putFullImage:function(e,t){t&&(r[e]=t)},getFullImage:function(e){return r[e]}}),R=objectAssign({},EventEmitter.prototype,{emitChange:function(){this.emit(h.MESSAGE_CHANGE_EVENT)},addChangeListener:function(e){this.on(h.MESSAGE_CHANGE_EVENT,e)},removeChangeListener:function(e){this.removeListener(h.MESSAGE_CHANGE_EVENT,e)},_getUnreadMessageIds:function(e){return s[e]&&s[e].unreadIds||[]},getCount:function(e){var t=this._getUnreadMessageIds(e);return t.length},getAll:function(){var e=0,t=Object.keys(s);for(var a in t)e+=this.getCount(t[a]);return e}}),v=objectAssign({},EventEmitter.prototype,{addContactRawMessages:function(e,t){var a={},n=null;C.asyncLoop({length:t.length,run:function(s,i){var r=t[i],c=!0,o=C.mapMessageFromRaw(r,c,e);n||(n=o.to),o.contentType==p.IMAGE?C.getThumbnailBase64(o.message,function(e,t){o.message=e,N.putFullImage(o.id,t),a[o.id]=o,s()}):(a[o.id]=o,s())},callback:function(){v.addHistoryMessages(n,a),v.emitUpdate()}})},getAll:function(){return s},getMessages:function(e){if(!e)return[];s[e]||(s[e]={messages:{},unreadIds:[],firstUnreadMsgId:null,init:!1});var t=[],a=s[e].messages;for(var n in a)t.push(a[n]);return t},addHistoryMessages:function(e,t){s[e]?s[e].messages=React.addons.update(t,{$merge:s[e].messages}):s[e]={messages:t,unreadIds:[],firstUnreadMsgId:null}},addMessage:function(e,t,a){t.isRead=a==e,s[e]||(s[e]={messages:{},unreadIds:[],firstUnreadMsgId:null}),t.isRead||(s[e].unreadIds.push(t.id),null==s[e].firstUnreadMsgId&&(s[e].firstUnreadMsgId=t.id)),s[e].messages[t.id]=t},emitChange:function(){this.emit(h.MESSAGE_CHANGE_EVENT)},emitUpdate:function(){this.emit(h.MESSAGE_UPDATE_EVENT)},addChangeListener:function(e){this.on(h.MESSAGE_CHANGE_EVENT,e)},removeChangeListener:function(e){this.removeListener(h.MESSAGE_CHANGE_EVENT,e)},removeUpdateListener:function(e){this.removeListener(h.MESSAGE_UPDATE_EVENT,e)},addUpdateListener:function(e){this.on(h.MESSAGE_UPDATE_EVENT,e)},addOutMessage:function(e){n++;var t={id:"m_"+n,from:e.operator.name,to:e.contact.name,message:e.data.message,contentType:e.type,messageType:u.OUTGOING,operator:!0,date:e.date,isRead:!0};s[e.contact.name].messages[t.id]=t,this.emitChange()},unmarkFirstRead:function(e){if(e){var t=s[e].firstUnreadMsgId;null!=t&&(s[e].messages[t].firstUnread=!1)}},readMessages:function(e){var t=s[e].messages,a=s[e].unreadIds||(s[e].unreadIds=[]),n=s[e].firstUnreadMsgId;n&&(t[n].firstUnread=!1);for(var i=a.length>0,r=0,c=a.length;c>r;r++){var o=t[a[r]];0==r&&(o.firstUnread=!0,s[e].firstUnreadMsgId=o.id),o.isRead=!0}return s[e].unreadIds=[],i}}),A=objectAssign({},EventEmitter.prototype,{init:function(e){for(var t=0,a=e.length;a>t;t++){var n=e[t];i[n.name]={id:n.id,name:n.name,status:n.status,loadStatus:"init"}}},getCountAll:function(){return Object.keys(i).length},getAll:function(){var e=[];if(d){l=o,o=null;for(var t in i){var a=i[t];a.name.indexOf(d)>=0&&e.push(a)}}else for(var t in i){var a=i[t];e.push(a)}return e},setFilter:function(e){d=e},clearContact:function(){l=o,o=null},emitChange:function(){this.emit(h.CONTACTS_CHANGE_EVENT)},emitContactSelect:function(){this.emit(h.CONTACT_SELECT_EVENT)},addChangeListener:function(e){this.on(h.CONTACTS_CHANGE_EVENT,e)},addContactSelectListener:function(e){this.on(h.CONTACT_SELECT_EVENT,e)},removeChangeListener:function(e){this.removeListener(h.CONTACTS_CHANGE_EVENT,e)},removeContactSelectListener:function(e){this.removeListener(h.CONTACT_SELECT_EVENT,e)},getActive:function(){return o},getCurrentContact:function(){return i[o]},setActive:function(e){var t=o!=e;l=o,o=e,l||(l=o);var a=i[o].clicks;return i[o].clicks=a&&++a||1,t},setLoadingState:function(e){i[e].loadStatus="loading"},setLoadedState:function(e){i[e].loadStatus="loaded"}}),y=new Flux.Dispatcher;S.dispatchToken=y.register(function(e){switch(e.type){case g.AUTH_SUCCESS:S.setStatus(f.SUCCESS),S.setOperator(e.operator),S.emitChange()}}),T.dispatchToken=y.register(function(e){switch(e.type){case g.PUT_FULL_IMAGE:T.putFullImage(e.messageId,e.imageData),T.emitChange()}}),_.dispatchToken=y.register(function(e){var t;switch(e.type){case g.NEW_IN_MESSAGE:case g.NEW_OUT_MESSAGE:var a=e.payload;t=_.addParticipant(a),t&&_.emitChange()}}),A.dispatchToken=y.register(function(e){switch(y.waitFor([S.dispatchToken]),e.type){case g.CLICK_CONTACT:var t=A.setActive(e.contactId);t&&A.emitContactSelect();break;case g.CONTACT_MESSAGES_SCROLL:i[e.contactId].scrollTop=e.scrollTopValue,A.emitChange();break;case g.CONTACT_FILTER:A.setFilter(e.pattern),A.emitChange();break;case g.CLEAR_SELECTED_CONTACT:A.clearContact();break;case g.API_FETCH_CONTACT_HISTORY:A.setLoadingState(e.contact.name,"loading")}}),v.dispatchToken=y.register(function(e){y.waitFor([A.dispatchToken]);var t,a=null,n=-1;switch(e.type){case g.CLICK_CONTACT:e.changed&&(v.unmarkFirstRead(e.prevContactId),v.emitUpdate());break;case g.NEW_OUT_MESSAGE:var i=e.payload;a=C.mapMessageFromRaw(i,!0);var r=a.to;t=A.getActive(),v.addMessage(r,a,t),T.putFullImage(a.id,i.fullImage),i.receiver==t&&v.emitUpdate(),v.emitChange();break;case g.NEW_IN_MESSAGE:var c=e.payload;a=C.mapMessageFromRaw(c),t=A.getActive(),v.addMessage(a.to,a,t),T.putFullImage(a.id,c.fullImage),c.sender==t&&v.emitUpdate(),v.emitChange();break;case g.CONTACT_FILTER:l&&(n=s[l].firstUnreadMsgId,null!=n&&(s[l].messages[n].firstUnread=!1,s[l].firstUnreadMsgId=null))}}),R.dispatchToken=y.register(function(e){switch(y.waitFor([A.dispatchToken,v.dispatchToken]),e.type){case g.READ_MESSAGES:var t=v.readMessages(e.contactId);t&&R.emitChange();break;case g.NEW_OUT_MESSAGE:R.emitChange();break;case g.NEW_IN_MESSAGE:R.emitChange();break;case g.CLICK_CONTACT:e.changed&&R.emitChange();break;case g.RECEIVE_RAW_MESSAGES:R.emitChange()}});var M=React.createClass({displayName:"LoadMessageHistoryButton",getInitialState:function(){return{btnState:this.props.status||"init"}},_onClick:function(e){e.preventDefault(),e.stopPropagation(),"function"==typeof this.props.onClick&&this.props.onClick(),this.setState({btnState:"loading"})},componentWillReceiveProps:function(e){this.setState({btnState:e.status})},_renderState:function(){switch(this.state.btnState){case"init":return React.createElement("div",{className:"history-load",style:{textAlign:"center"}},React.createElement("span",{className:"btn-badge"},React.createElement("a",{onClick:this._onClick,href:"#"},this.props.title)));case"loading":return React.createElement("div",{className:"history-load",style:{textAlign:"center"}},React.createElement("span",{className:"btn-badge"},React.createElement("b",null,this.props.titleLoading||"Loading...")));case"loaded":return React.createElement("div",{className:"history-load",style:{textAlign:"center"}})}},render:function(){return this._renderState()}}),I=React.createClass({displayName:"UploadImageButton",getCoefficient:function(e,t,a){var n=Math.max(e,t),s=1;return n>a&&(s=n/a),s},_onUploadedBase64:function(e,t){this.props.onImageBase64&&this.props.onImageBase64(e,t)},_onFileChange:function(e){if("function"==typeof window.FileReader){var t=this.refs.fileUpload,a=t.files[0],n=new FileReader,s=this;n.onload=function(){var e=new Image;e.onload=function(){var e=s.refs.imageCanvas,t=s.img.width,a=s.img.height,n=s.getCoefficient(t,a,1280);e.width=t/n,e.height=a/n;var i=e.getContext("2d");i.drawImage(s.img,0,0,e.width,e.height);var r=e.toDataURL("image/png");n=s.getCoefficient(t,a,150),e.width=t/n,e.height=a/n,i.drawImage(s.img,0,0,e.width,e.height);var c=e.toDataURL("image/png");s._onUploadedBase64(c,r)},e.src=n.result,s.img=e},n.readAsDataURL(a)}},render:function(){return React.createElement("i",{className:this.props.classes,style:{position:"relative"}},React.createElement("form",{action:"#"},React.createElement("input",{style:{opacity:0,zIndex:2,left:0,top:0,width:"100%",position:"absolute"},ref:"fileUpload",type:"file",accept:"image/*",onChange:this._onFileChange})),React.createElement("canvas",{ref:"imageCanvas",style:{display:"none"}}))}}),L=React.createClass({displayName:"UnreadOutgoingMessage",_onDownloadMessages:function(e){var t=T.getFullImage(this.props.data.id);C.downloadImage(t,"Image viewing","chat-thumbnail.png"),e.preventDefault(),e.stopPropagation()},renderMessage:function(e){return e.contentType==p.TEXT?e.message||"Empty message":e.contentType==p.IMAGE?React.createElement("a",{href:"#",onClick:this._onDownloadMessages},React.createElement("img",{className:"image-message",src:e.message})):void 0},operatorStatus:function(){return this.props.data.operator?React.createElement("i",{className:"msg-badge"},"operator"):""},render:function(){return React.createElement("li",{className:"message-container clearfix messages-unread"},React.createElement("span",{className:"mark"},"New messages"),React.createElement("div",{className:"message-data align-right"},React.createElement("span",{className:"message-data-time"},C.getCurrentTime(this.props.data.date),", ","Today"),"   ",React.createElement("span",{className:"message-data-name"},this.props.data.from||"Empty sender",this.operatorStatus()),"  ",React.createElement("i",{className:"fa fa-circle "+(this.props.status||"me")})),React.createElement("div",{className:"message other-message float-right"},this.renderMessage(this.props.data)))}}),O=React.createClass({displayName:"UnreadIncomingMessage",scrolled:!1,_onDownloadMessages:function(e){var t=T.getFullImage(this.props.data.id);C.downloadImage(t,"Image viewing","chat-thumbnail.png"),e.preventDefault(),e.stopPropagation()},renderMessage:function(e){return e.contentType==p.TEXT?e.message||"Empty message":e.contentType==p.IMAGE?React.createElement("a",{href:"#",onClick:this._onDownloadMessages},React.createElement("img",{className:"image-message",src:e.message})):void 0},scrollIntoViewIfNeeded:function(e,t){if(!this.scrolled){var a=ReactDOM.findDOMNode(this);C.scrollIntoViewNeeded(e,a,t),this.scrolled=!0}},canScroll:function(){return!this.scrolled},_operatorStatus:function(){return this.props.data.operator?React.createElement("i",{className:"msg-badge"},"operator"):""},_operatorMsgClasses:function(){return this.props.data.operator?" other-operator":""},render:function(){return React.createElement("li",{className:"message-container messages-unread"},React.createElement("span",{className:"mark"},"New messages"),React.createElement("div",{className:"message-data"},React.createElement("span",{className:"message-data-name"},React.createElement("i",{className:"fa fa-circle "+(this.props.status||"offline")}),this.props.data.from||"Not specified",this._operatorStatus()),React.createElement("span",{className:"message-data-time"},C.getCurrentTime(this.props.data.date),", ","Today")),React.createElement("div",{className:"message my-message"+this._operatorMsgClasses()},this.renderMessage(this.props.data)))}}),U=React.createClass({displayName:"UnreadEndConversationMessage",scrolled:!1,scrollIntoViewIfNeeded:function(e,t){if(!this.scrolled){var a=ReactDOM.findDOMNode(this);C.scrollIntoViewNeeded(e,a,t),this.scrolled=!0}},canScroll:function(){return!this.scrolled},renderMessage:function(e){return React.createElement("div",{className:"message-resolved"})},operatorStatus:function(){return this.props.data.operator?React.createElement("i",{className:"msg-badge"},"operator"):""},render:function(){return React.createElement("li",{className:"message-container clearfix messages-unread"},React.createElement("span",{className:"mark"},"New messages"),React.createElement("div",{className:"message-data align-right"},React.createElement("span",{className:"message-data-time"},C.getCurrentTime(this.props.data.date),", ","Today"),"   ",React.createElement("span",{className:"message-data-name"},this.props.data.from||"Empty sender",this.operatorStatus()),"  ",React.createElement("i",{className:"fa fa-circle "+(this.props.status||"me")})),this.renderMessage(this.props.data))}}),G=(React.createClass({displayName:"TypingMessage",render:function(){var e=function(){return(new Date).toLocaleTimeString().replace(/([\d]+:[\d]{2})(:[\d]{2})(.*)/,"$1$3")};return React.createElement("li",null,React.createElement("div",{className:"message-data"},React.createElement("span",{className:"message-data-name"},React.createElement("i",{className:"fa fa-circle online"}),this.props.phone||"Not specified"),React.createElement("span",{className:"message-data-time"},this.props.time||e())),React.createElement("i",{className:"fa fa-circle online"}),React.createElement("i",{className:"fa fa-circle online",style:{color:"#AED2A6"}}),React.createElement("i",{className:"fa fa-circle online",style:{color:"#DAE9DA"}}))}}),React.createClass({displayName:"OutgoingMessage",_onDownloadMessages:function(e){var t=T.getFullImage(this.props.data.id);C.downloadImage(t,"Image viewing","chat-thumbnail.png"),e.preventDefault(),e.stopPropagation()},operatorStatus:function(){return this.props.data.operator?React.createElement("i",{className:"msg-badge"},"operator"):""},renderMessage:function(e){return e.contentType==p.TEXT?e.message||"Empty message":e.contentType==p.IMAGE?React.createElement("a",{href:"#",onClick:this._onDownloadMessages},React.createElement("img",{className:"image-message",src:e.message})):void 0},render:function(){return React.createElement("li",{className:"clearfix"},React.createElement("div",{className:"message-data align-right"},React.createElement("span",{className:"message-data-time"},C.getCurrentTime(this.props.data.date),", ","Today"),"   ",React.createElement("span",{className:"message-data-name"},this.props.data.from||"Empty sender",this.operatorStatus()),"  ",React.createElement("i",{className:"fa fa-circle "+(this.props.status||"me")})),React.createElement("div",{className:"message other-message float-right"},this.renderMessage(this.props.data)))}})),w=React.createClass({displayName:"MinChatBox",getInitialState:function(){return{clientsCount:A.getCountAll(),unreadCount:R.getAll()}},componentDidMount:function(){R.addChangeListener(this._onUnreadChange),A.addChangeListener(this._onContactsChanged)},componentWillUnmount:function(){R.removeChangeListener(this._onUnreadChange),A.removeChangeListener(this._onContactsChanged)},_onContactsChanged:function(){var e=A.getCountAll();this.setState({clientsCount:e})},_onUnreadChange:function(){var e=R.getAll();this.setState({unreadCount:e})},_maximizeClicked:function(){"function"==typeof this.props.onMaximize&&this.props.onMaximize()},render:function(){return React.createElement("div",{className:"chat-container min-container clearfix"},React.createElement("div",{className:"msg-count center-text bg-"+this.props.status},React.createElement("div",{className:"status"},React.createElement("i",{className:"fa fa-circle "+this.props.status||"offline"}),this.props.status),React.createElement("div",null,"Clients: ",React.createElement("i",{className:"clients-badge"},this.state.clientsCount))),React.createElement("div",{className:"chat-info"},"New: ",React.createElement("span",{className:"msg-badge unread"},this.state.unreadCount),React.createElement(b,{onClick:this._maximizeClicked,classes:"fa fa-2x fa-plus-square maximize-icon"})))}}),k=React.createClass({displayName:"EmptyMinChatBox",_maximizeClicked:function(){"function"==typeof this.props.onMaximize&&this.props.onMaximize()},render:function(){return React.createElement("div",{className:"chat-container min-container clearfix"},React.createElement("div",{className:"msg-count-empty center-text"},"Chat"),React.createElement("div",{className:"chat-info"},React.createElement(b,{onClick:this._maximizeClicked,classes:"fa fa-2x fa-plus-square maximize-icon"})))}}),D=React.createClass({displayName:"LoginBox",componentDidMount:function(){S.addChangeListener(this._onAuthChanged)},componentWillUnmount:function(){S.removeChangeListener(this._onAuthChanged)},getInitialState:function(){return{loginState:this.props.initialLoginState||"login"}},_onAuthChanged:function(){S.getStatus()===f.SUCCESS?(this.successState(),"function"==typeof this.props.onAuthSuccess&&setTimeout(function(){this.props.onAuthSuccess(S.getOperator())}.bind(this),1e3)):this.tryAgainState()},_onMinimize:function(){this.setState({loginState:"min",originalState:this.state.loginState})},_onMaximize:function(){this.setState({loginState:this.state.originalState})},progressState:function(){this.setState({loginState:"progress",originalState:"progress"})},successState:function(){this.setState({loginState:"success",originalState:"success"})},tryAgainState:function(){this.setState({loginState:"login",originalState:"login"})},loginClick:function(e){this.progressState(),N.authenticate({session:"EdsSRssdAQwDRtdf"})},renderState:function(){switch(this.state.loginState){case"min":return React.createElement(k,{onMaximize:this._onMaximize});case"login":return React.createElement("div",{className:"chat"},React.createElement(B,{onMinimize:this._onMinimize}),React.createElement("div",{className:"wrapper"},React.createElement("button",{className:"login-btn",onClick:this.loginClick},React.createElement("i",{className:"chat-spinner"}),React.createElement("span",{className:"state"},"Log in"))));case"progress":return React.createElement("div",{className:"chat"},React.createElement(B,{onMinimize:this._onMinimize}),React.createElement("div",{className:"wrapper loading"},React.createElement("button",{className:"login-btn"},React.createElement("i",{className:"chat-spinner"}),React.createElement("span",{className:"state"},"Authenticating"))));case"success":return React.createElement("div",{className:"chat"},React.createElement(B,{onMinimize:this._onMinimize}),React.createElement("div",{className:"wrapper ok loading"},React.createElement("button",{className:"login-btn"},React.createElement("i",{className:"chat-spinner"}),React.createElement("span",{className:"state"},"Welcome back!"))))}},render:function(){return this.renderState()}}),H=React.createClass({displayName:"IncomingMessage",_onDownloadMessages:function(e){var t=T.getFullImage(this.props.data.id);C.downloadImage(t,"Image viewing","chat-thumbnail.png"),e.preventDefault(),e.stopPropagation()},renderMessage:function(e){return e.contentType==p.TEXT?e.message||"Empty message":e.contentType==p.IMAGE?React.createElement("a",{href:"#",onClick:this._onDownloadMessages},React.createElement("img",{className:"image-message",src:e.message})):void 0},operatorStatus:function(){return this.props.data.operator?React.createElement("i",{className:"msg-badge"},"operator"):""},_operatorMsgClasses:function(){return this.props.data.operator?" other-operator":""},render:function(){return React.createElement("li",null,React.createElement("div",{className:"message-data"},React.createElement("span",{className:"message-data-name"},React.createElement("i",{className:"fa fa-circle "+(this.props.status||"offline")}),this.props.data.from||"Not specified",this.operatorStatus()),React.createElement("span",{className:"message-data-time"},C.getCurrentTime(this.props.data.date),", ","Today")),React.createElement("div",{className:"message my-message"+this._operatorMsgClasses()},this.renderMessage(this.props.data)))}}),b=React.createClass({displayName:"IconButton",render:function(){return React.createElement("i",{onClick:this.props.onClick||function(){},className:this.props.classes})}}),F=React.createClass({displayName:"HistoryButton",render:function(){return React.createElement("button",{onClick:this.props.onClick,className:this.props.classes},React.createElement("i",{className:this.props.icons}),"  ",this.props.title||"")}}),x=React.createClass({displayName:"HistoryBox",scroll:0,renderMessage:function(e){var t=this.props.contact;switch(e.messageType){case u.INCOMING:return e.firstUnread?React.createElement(O,{ref:"unreadItem",key:e.id,data:e,status:t.status}):React.createElement(H,{key:e.id,data:e,status:t.status});case u.OUTGOING:return e.firstUnread?React.createElement(L,{ref:"unreadItem",key:e.id,data:e,status:t.status}):React.createElement(G,{key:e.id,data:e,status:t.status});case u.END_OF_CONVERSATION:return e.firstUnread?React.createElement(U,{ref:"unreadItem",key:e.id,data:e,status:t.status}):React.createElement(V,{key:e.id,data:e,status:t.status})}},_scrollToFirstUnread:function(){var e=50,t=this.refs.unreadItem,a=ReactDOM.findDOMNode(this);t&&t.canScroll()?(this.refs.unreadItem.scrollIntoViewIfNeeded(a,!0),this.scroll=a.scrollHeight-e):this.canScroll&&(a.scrollTop=a.scrollHeight,this.scroll=a.scrollTop)},_onLoadHistory:function(){"function"==typeof this.props.onLoadHistory&&this.props.onLoadHistory(this.props.contact)},componentDidMount:function(){this._scrollToFirstUnread()},componentWillUpdate:function(e,t){e.contact.id!=this.props.contact.id&&(this.scroll=0);var a=ReactDOM.findDOMNode(this);this.canScroll=a.scrollTop>=this.scroll},componentDidUpdate:function(){this._scrollToFirstUnread()},render:function(){var e=this.renderMessage;return React.createElement("div",{className:"chat-history"},React.createElement(M,{status:this.props.contact.loadStatus,onClick:this._onLoadHistory,title:"Load history",titleLoading:"Loading..."}),React.createElement("ul",{className:"chat-history-messages"},this.props.messages.map(function(t){return e(t)})))}}),P=React.createClass({displayName:"HeaderBox",closeClicked:function(e){"function"==typeof this.props.onClose&&this.props.onClose()},_minimizeClicked:function(e){"function"==typeof this.props.onMinimize&&this.props.onMinimize()},render:function(){return React.createElement("div",{className:"chat-header clearfix"},React.createElement("div",{className:"chat-about"},React.createElement("div",{className:"chat-with"}," Chat with: ",this.props.contact.name||""),React.createElement("div",{className:"chat-num-messages"},"already",React.createElement("i",{className:"msg-badge"},this.props.count||0),"messages")),React.createElement(b,{onClick:this.closeClicked,classes:"fa fa-times header-icon"}),React.createElement(b,{onClick:this._minimizeClicked,classes:"fa fa-minus-square header-icon"}))}}),z=React.createClass({displayName:"FooterBox",getInitialState:function(){return{value:""}},sendMessage:function(e){if(""!==this.state.value.trim()){var t=new Date,a={id:null,message:this.state.value,sender:this.props.operator,receiver:this.props.contact,contentType:p.TEXT,messageType:u.OUTGOING,date:t,fullImage:null};N.outgoingMessage(a),this.setState({value:""})}},sendEndMessage:function(e){N.outgoingMessage(null,"End of conversation",this.props.operator,this.props.contact,p.TEXT,u.END_OF_CONVERSATION)},handleChange:function(e){this.setState({value:e.target.value})},handleKeyUp:function(e){e.keyCode===E.ENTER_KEY&&this.sendMessage()},_onImageUpload:function(e,t){var a=new Date,n={id:null,message:e,sender:this.props.operator,receiver:this.props.contact,contentType:p.IMAGE,messageType:u.OUTGOING,date:a,fullImage:t};N.outgoingMessage(n)},render:function(){return React.createElement("div",{className:"chat-message clearfix"},React.createElement("textarea",{name:"message-to-send",id:"message-to-send",placeholder:"Type your message",value:this.state.value,onChange:this.handleChange,onKeyUp:this.handleKeyUp,rows:"2"}),React.createElement(b,{classes:"fa fa-file-o"}),"   ",React.createElement(I,{onImageBase64:this._onImageUpload,classes:"fa fa-file-image-o"}),React.createElement(F,{onClick:this.sendMessage,title:"send",icons:"fa fa-paper-plane-o",classes:"btn-send"}),React.createElement(F,{onClick:this.sendEndMessage,title:"end",icons:"fa fa-comments",classes:"btn-replied"}))}}),V=React.createClass({displayName:"EndConversationMessage",operatorStatus:function(){return this.props.data.operator?React.createElement("i",{className:"msg-badge"},"operator"):""},renderMessage:function(e){return React.createElement("div",{className:"message-resolved"})},render:function(){return React.createElement("li",{className:"clearfix"},React.createElement("div",{className:"message-data align-right"},React.createElement("span",{className:"message-data-time"},C.getCurrentTime(this.props.data.date),", ","Today"),"   ",React.createElement("span",{className:"message-data-name"},this.props.data.from||"Empty sender",this.operatorStatus()),"  ",React.createElement("i",{className:"fa fa-circle "+(this.props.status||"me")})),this.renderMessage(this.props.data))}}),B=React.createClass({displayName:"EmptyHeaderBox",_onMinimize:function(){"function"==typeof this.props.onMinimize&&this.props.onMinimize()},render:function(){return React.createElement("div",{className:"chat-header clearfix"},React.createElement(b,{onClick:this._onMinimize,classes:"fa fa-minus-square header-icon"}))}}),W=React.createClass({displayName:"EmptyConversationBox",_onMinimize:function(){"function"==typeof this.props.onMinimize&&this.props.onMinimize()},render:function(){return React.createElement("div",{className:"chat"},React.createElement(B,{onMinimize:this._onMinimize}),React.createElement(K,null))}}),K=React.createClass({displayName:"EmptyChatBox",render:function(){return React.createElement("div",{className:"wrapper no-conversation"},React.createElement("div",null,React.createElement("i",{className:"fa fa-4x fa-comment"})),React.createElement("span",{className:"state"},"No conversation"))}}),j=React.createClass({displayName:"ConversationBox",_onClose:function(){"function"==typeof this.props.onClose&&this.props.onClose()},_onMinimize:function(){"function"==typeof this.props.onMinimize&&this.props.onMinimize()},_onOutMessage:function(e){"function"==typeof this.props.onOutgoingMessage&&this.props.onOutgoingMessage(e);
},_onLoadHistory:function(e){"function"==typeof this.props.onLoadHistory&&this.props.onLoadHistory(e)},render:function(){return React.createElement("div",{className:"chat"},React.createElement(P,{contact:this.props.contact,count:this.props.messages.length,onClose:this._onClose,onMinimize:this._onMinimize}),React.createElement(x,{contact:this.props.contact,messages:this.props.messages,onLoadHistory:this._onLoadHistory}),React.createElement(z,{operator:this.props.operator,contact:this.props.contact,onMessage:this._onOutMessage}))}}),q=React.createClass({displayName:"ContactsListBox",onActivateContact:function(e){"function"==typeof this.props.onSelectContact&&this.props.onSelectContact(e)},render:function(){var e=this.props.current?this.props.current.name:null,t=this.onActivateContact;return React.createElement("ul",{className:"list"},this.props.items.map(function(a){return React.createElement($,{key:a.id,data:a,selectedId:e,onActivate:t})}))}}),X=React.createClass({displayName:"ContactSearchBox",getInitialState:function(){return{value:""}},_handleChange:function(e){this.setState({value:e.target.value}),"function"==typeof this.props.onLiveSearch&&this.props.onLiveSearch(e.target.value)},_handleKeyUp:function(e){e.keyCode===E.ENTER_KEY&&this._onSearch()},_onSearch:function(){"function"==typeof this.props.onSearch&&this.props.onSearch(this.state.value)},_onClear:function(){this.setState({value:""}),"function"==typeof this.props.onClear&&this.props.onClear()},render:function(){return React.createElement("div",{className:"search"},React.createElement("input",{className:"search-input",onChange:this._handleChange,onKeyUp:this._handleKeyUp,type:"text",placeholder:"search",value:this.state.value}),React.createElement("i",{onClick:this._onSearch,className:"fa fa-search"}),React.createElement("i",{onClick:this._onClear,className:"fa fa-close"}))}}),Y=React.createClass({displayName:"ContactsBox",_onSearch:function(e){N.contactFilter(e)},_onClear:function(){N.contactFilter("")},_onLiveSearch:function(e){N.contactFilter(e)},_onSelectContact:function(e){"function"==typeof this.props.onSelectContact&&this.props.onSelectContact(e)},render:function(){return React.createElement("div",{className:"people-list",id:"people-list"},React.createElement(X,{onLiveSearch:this._onLiveSearch,onSearch:this._onSearch,onClear:this._onClear}),React.createElement(q,{items:this.props.contacts,current:this.props.current,onSelectContact:this._onSelectContact}))}}),$=React.createClass({displayName:"Contact",getInitialState:function(){var e=R.getCount(this.props.data.name),t=_.getParticipants(this.props.data.name);return{data:this.props.data||{},active:!1,unread:e,participants:t}},componentDidMount:function(){R.addChangeListener(this._onUnreadChange),_.addChangeListener(this._participantsChange)},componentWillUnmount:function(){R.removeChangeListener(this._onUnreadChange),_.removeChangeListener(this._participantsChange)},_onUnreadChange:function(){var e=R.getCount(this.state.data.name);this.setState({unread:e})},_participantsChange:function(){var e=_.getParticipants(this.state.data.name);e.length>0&&this.setState({participants:e})},_getParticipants:function(){return this.state.participants?React.createElement("span",null,this.state.participants.map(function(e,t){return React.createElement("span",{key:t,className:"msg-badge badge-sm"},e)})):""},activateContact:function(){"function"==typeof this.props.onActivate&&this.props.onActivate(this.state.data)},getUnreadMessageCount:function(){return this.state.unread?React.createElement("i",{className:"msg-badge unread"},this.state.unread||0):""},clientActive:function(){var e=this.state.data;return this.props.selectedId==e.name?" active":""},render:function(){return React.createElement("li",{className:"contact clearfix"+this.clientActive(),onClick:this.activateContact},React.createElement("div",{className:"about"},React.createElement("div",{className:"name"},this.state.data.name||"+000000000000"),React.createElement("div",{className:"status"},React.createElement("i",{className:"fa fa-circle "+this.state.data.status||"offline"}),this.state.data.status||"offline"),React.createElement("div",null,this._getParticipants()),React.createElement("div",{className:"msg-unread"},this.getUnreadMessageCount())))}}),Q=React.createClass({displayName:"ChatBox",getInitialState:function(){return{chatState:this.props.initialChatState||"login",contacts:[],messages:[],currentContact:{},operator:{},unread:0}},componentDidMount:function(){A.addChangeListener(this._storeContactsChange),A.addContactSelectListener(this._storeContactSelect),v.addUpdateListener(this._storeMessagesChange)},componentWillUnmount:function(){A.removeChangeListener(this._storeContactsChange),A.removeContactSelectListener(this._storeContactSelect),v.removeUpdateListener(this._storeMessagesChange)},_onSelectContact:function(e){N.clickContact(e.name),N.readMessages(e.name)},_storeContactSelect:function(){var e=A.getCurrentContact();this.setState({chatState:"chat",currentContact:e})},_storeContactsChange:function(){this.setState({chatState:"no-chat",currentContact:{},messages:[],contacts:A.getAll()})},_storeMessagesChange:function(){var e=A.getCurrentContact();e&&this.setState({currentContact:e,messages:v.getMessages(e.name)})},authSuccess:function(e){this.setState({operator:e,chatState:"no-chat"}),N.fetchContacts()},onConversationClose:function(){this.setState({chatState:"no-chat",messages:[],currentContact:{}}),N.clearSelected()},_onMinimize:function(){this.setState({chatState:"min",messages:[],currentContact:{}}),N.clearSelected()},_onMaximize:function(){this.setState({chatState:"no-chat",messages:[],currentContact:{}})},_onLoadHistory:function(e){N.fetchContactHistory(e)},onOutgoingMessage:function(e){var t=this.state.operator,a=this.state.currentContact;v.addOutMessage({contact:a,operator:t,data:e,type:p.TEXT})},renderState:function(){switch(this.state.chatState||"login"){case"min":return React.createElement(w,{onMaximize:this._onMaximize,status:this.state.operator.status});case"login":return React.createElement("div",{id:"chat-template",className:"chat-container clearfix"},React.createElement(D,{onAuthSuccess:this.authSuccess}));case"chat":return React.createElement("div",{id:"chat-template",className:"chat-container clearfix"},React.createElement(Y,{current:this.state.currentContact,contacts:this.state.contacts,onSelectContact:this._onSelectContact}),React.createElement(j,{contact:this.state.currentContact,operator:this.state.operator,messages:this.state.messages,onClose:this.onConversationClose,onMinimize:this._onMinimize,onOutgoingMessage:this.onOutgoingMessage,onLoadHistory:this._onLoadHistory}));case"no-chat":return React.createElement("div",{id:"chat-template",className:"chat-container clearfix"},React.createElement(Y,{contacts:this.state.contacts,onSelectContact:this._onSelectContact}),React.createElement(W,{onMinimize:this._onMinimize}))}},render:function(){return this.renderState()}});ReactDOM.render(React.createElement(Q,null),document.getElementById("chatbox"),function(){if("function"==typeof window.OkkChatReady){var e={Dispatcher:y,ActionTypes:g,Actions:N,Stores:{AuthStore:S,ContactsStore:A,MessageStore:v,FullImageStore:T,ParticipantsStore:_,UnreadMessageStore:R},MessageTypes:u,MessageContentTypes:p,CoreUtils:C};window.OkkChatReady(e)}})},{}]},{},[1]);