function OkkChatReady(e){var t=objectAssign({},{_audio:null,_mute:!1,_hasError:!1,mute:function(){this._mute=!0},unmute:function(){this._mute=!1},_onerror:function(){this._hasError=!0},hasError:function(){return this._hasError},play:function(){var e=ChatConfig.INCOMING_MESSAGE_SOUND_PATH||null;!this._audio&&e&&(this._audio=new Audio,this._audio.onerror=this._onerror,this._audio.src=e),!this._audio||this.hasError()||this._mute||this._audio.play()}}),a=objectAssign({},{_loadQueue:{},_accessKey:null,_socket:null,_firstConnection:!0,_connectToSocket:function(){var t=this,s={path:ChatConfig.SOCKET_IO_NS};this._accessKey&&(s.extraHeaders={Authorization:this._accessKey});var n=io(ChatConfig.SOCKET_IO_URL,s);n.on("connect",function(){console.log("connected!!!"),t._socket=n,e.Actions.operatorStatusChanged(e.ContactStatus.ONLINE),a._firstConnection||a.loadContacts(a.loadNewestMessagesForCurrentContact),a._firstConnection=!1}),n.on("disconnect",function(){console.log("disconnect!!!"),e.Actions.operatorStatusChanged(e.ContactStatus.OFFLINE),e.Stores.ContactsStore.makeAllOffline()}),n.on("incoming:message",function(t,a){var s=JSON.parse(t);if("function"==typeof a){var n=e.Stores.AuthStore.getOperator();a(JSON.stringify({id:+s.id,deliveredTo:n.nick}))}e.Actions.incomingMessage(s)}),n.on("client:status",function(t){var a=JSON.parse(t);e.Actions.clientStatusChanged(a.id,a.username,a.status)}),n.on("client:new",function(e){})},pushQueue:function(e){return this._loadQueue[e]?!1:(this._loadQueue[e]=!0,!0)},popQueue:function(e){delete this._loadQueue[e]},authenticate:function(){fetch(ChatConfig.URL_TO_OPERATOR_AUTH,{credentials:"include"}).then(function(e){return e.json()}).then(function(t){t.success?(a._accessKey=t.access_key,setTimeout(function(){var s=t.user,n={id:s.id,name:s.first_name,nick:s.username,status:e.ContactStatus.ONLINE};e.Actions.authSuccess(n),a._connectToSocket()},1e3)):setTimeout(function(){e.Actions.authFail(t.message)},1e3)})["catch"](function(t){setTimeout(function(){e.Actions.authFail(t.message)},1e3)})},loadContacts:function(t){this._socket.emit("client:list",{},function(a){var s=JSON.parse(a);s.success&&(e.Stores.ContactsStore.init(s.data),e.Stores.ContactsStore.emitChange(),e.Stores.MessageStore.init(s.unread)),"function"==typeof t&&t()})},loadNewestMessagesForCurrentContact:function(){var t=e.Stores.ContactsStore.getCurrentContact(),s=null;if(t){var n=e.Stores.MessageStore.getUnsentMessages(t.name);n&&!n.length?(s=e.Stores.MessageStore.getLastDeliveredMessageId(t.name),a.loadNewestRawContactMessages(t.name,s)):(s=e.Stores.MessageStore.getLastDeliveredMessageId(t.name),a.loadNewestRawContactMessages(t.name,s))}},checkUnreadMessages:function(e,t){e&&e.length&&a._socket.emit("operator:check:messages",JSON.stringify(e),t)},sendReadEvent:function(e){var t=a.getNormalizedUnreadIds(e);t.messageIds.length&&a._socket.emit("operator:read:messages",JSON.stringify(t),function(e){})},loadRawContactMessages:function(t,s){var n={mobile:t};s&&(n.firstMessageId=s),this._socket.emit("operator:message:history",JSON.stringify(n),function(t){var s=JSON.parse(t);if(s.success){var n=e.Stores.AuthStore.getOperator(),r=e.Stores.MessageStore.addContactRawMessages(n,s.contact,s.data);e.Stores.MessageStore.emitUpdate(),e.Stores.ContactsStore.setLoadedState(s.contact),e.Stores.ContactsStore.emitContactSelect(),a.popQueue(s.contact),this.sendReadEvent(r),e.Stores.MessageStore.clearUnreadMessages(s.contact)}}.bind(this))},loadNewestRawContactMessages:function(t,s){var n={mobile:t};s&&(n.lastMessageId=s),this._socket.emit("operator:newest:message:history",JSON.stringify(n),function(s){var n=JSON.parse(s),r=[];if(n.success){for(var o=[],i=e.Stores.AuthStore.getOperator(),c=n.data,l=0,d=c.length;d>l;l++){var u=c[l],m=e.Stores.MessageStore._updateExisted(t,u);m==e.ChatMessageUpdateStatus.NOT_UPDATED&&(r.push(u.id),o.push(u)),m==e.ChatMessageUpdateStatus.UPDATED_WITH_TEMP_ID&&e.Stores.MessageStore._unregisterOutMessage(n.contact,u.tempId)}e.Stores.MessageStore.addContactRawMessages(i,n.contact,o,!0),data=a.getNormalizedUnreadIds(r);for(var p=e.Stores.MessageStore.getUnsentMessages(n.contact),g=0,h=p.length;h>g;g++)a.sendMessageToServer(p[g]);data.messageIds.length&&a._socket.emit("operator:read:messages",JSON.stringify(data),function(e){}),a.popQueue(n.contact)}})},sendMessageToServer:function(t){this._socket.emit("operator:message",JSON.stringify(t),function(t){var a=JSON.parse(t);e.Actions.updateMessageContent(this.receiver,a.temp_id,a)}.bind(t))},getNormalizedUnreadIds:function(e){if(e&&e.length){for(var t=[],a=0;a<e.length;a++)0!=+e[a]&&t.push(+e[a].replace(/m_/gi,""));return{messageIds:t}}return{messageIds:[]}}});a.dispatchToken=e.Dispatcher.register(function(s){var n,r=!1;switch(s.type){case e.ActionTypes.NEW_OUT_MESSAGE:var o=s.payload,i={id:o.id,message:o.contentType==e.MessageContentTypes.IMAGE?o.fullImage:o.message,sender:o.sender,receiver:o.receiver,contentType:o.contentType,messageType:o.messageType,date:e.CoreUtils.formatDate(o.date),endOfConversation:o.endOfConversation,operator:!0};a.sendMessageToServer(i);break;case e.ActionTypes.API_FETCH_CONTACTS:a.loadContacts();break;case e.ActionTypes.API_AUTH_OPERATOR:a.authenticate(s.credentials);break;case e.ActionTypes.API_FETCH_CONTACT_HISTORY:n=s.contact.name,r=a.pushQueue(n),r&&a.loadRawContactMessages(n,s.firstMessageId);break;case e.ActionTypes.API_FETCH_NEWEST_CONTACT_HISTORY:n=s.contact.name,r=a.pushQueue(n),r&&a.loadNewestRawContactMessages(n,s.lastMessageId);break;case e.ActionTypes.NEW_IN_MESSAGE:t.play();var c=e.Stores.ContactsStore.getCurrentContact(),o=s.payload;c&&o.sender==c.name&&a.sendReadEvent([o.id]);break;case e.ActionTypes.MUTE_NOTIFICATION_SOUND:t.mute();break;case e.ActionTypes.UNMUTE_NOTIFICATION_SOUND:t.unmute();break;case e.ActionTypes.READ_MESSAGES:var l=e.Stores.UnreadMessageStore.getUnreadIds(s.contactId);a.sendReadEvent(l),e.Stores.MessageStore.clearUnreadMessages(s.contactId)}})}function getRandomItem(e){var t=Object.keys(e),a=t.length;return e[t[Math.floor(Math.random()*a)]]}function genNumber(){return genNumber.prevValues||(genNumber.prevValues=0),genNumber.prevValues++,genNumber.prevValues+1e5}var _lastMessageId=1,_messages={},_contacts={},_fullMessageImages={},_chatParticipants={},_chatOutMessages={},_activeContactId,_preActiveContactId,_contactFilterPattern="",_currentOperator,keyMirror=function(e){var t,a={};if(!(e instanceof Object)||Array.isArray(e))throw new Error("keyMirror(...): Argument must be an object.");for(t in e)e.hasOwnProperty(t)&&(a[t]=t);return a},MessageContentTypes={IMAGE:"image",TEXT:"text"},ContactStatus={ONLINE:"online",OFFLINE:"offline"},MessageTypes={INCOMING:"in",OUTGOING:"out"},ChatMessageUpdateStatus={NOT_UPDATED:0,UPDATED_WITH_DB_ID:1,UPDATED_WITH_TEMP_ID:2},ChatConstants=keyMirror({MESSAGE_CHANGE_EVENT:null,CONTACT_SELECT_EVENT:null,MESSAGE_UPDATE_EVENT:null,CONTACTS_CHANGE_EVENT:null,FULL_IMAGES_CHANGE_EVENT:null,OPERATOR_CHANGED:null,PARTICIPANTS_CHANGED:null}),ActionTypes=keyMirror({CLICK_CONTACT:null,RECEIVE_RAW_MESSAGES:null,NEW_OUT_MESSAGE:null,NEW_IN_MESSAGE:null,READ_MESSAGES:null,CONTACT_MESSAGES_SCROLL:null,CONTACT_FILTER:null,CLEAR_SELECTED_CONTACT:null,AUTH_SUCCESS:null,AUTH_FAIL:null,PUT_FULL_IMAGE:null,API_FETCH_CONTACTS:null,API_AUTH_OPERATOR:null,API_FETCH_CONTACT_MESSAGES:null,API_FETCH_CONTACT_HISTORY:null,UPDATE_MESSAGE_CONTENT:null,CLIENT_STATUS_CHANGED:null,OPERATOR_STATUS_CHANGED:null,MUTE_NOTIFICATION_SOUND:null,UNMUTE_NOTIFICATION_SOUND:null,API_FETCH_NEWEST_CONTACT_HISTORY:null,NEWEST_HISTORY_MESSAGES:null}),AuthStatuses={SUCCESS:1,ERROR:2},KeyConstants={ENTER_KEY:13},CoreUtils={timeSince:function(e){switch(typeof e){case"number":break;case"string":e=+new Date(e);break;case"object":e.constructor===Date&&(e=e.getTime());break;default:e=+new Date}var t=[[60,"seconds",1],[120,"1 minute ago","1 minute from now"],[3600,"minutes",60],[7200,"1 hour ago","1 hour from now"],[86400,"hours",3600],[172800,"Yesterday","Tomorrow"],[604800,"days",86400],[1209600,"Last week","Next week"],[2419200,"weeks",604800],[4838400,"Last month","Next month"],[29030400,"months",2419200],[58060800,"Last year","Next year"],[290304e4,"years",29030400],[580608e4,"Last century","Next century"],[580608e5,"centuries",290304e4]],a=(+new Date-e)/1e3,s="ago",n=1;if(0==Math.floor(a))return"Just now";Math.floor(a)<0&&(a=Math.abs(a),s="from now",n=2);for(var r,o=0;r=t[o++];)if(a<r[0])return"string"==typeof r[2]?r[n]:Math.floor(a/r[2])+" "+r[1]+" "+s;return e},padLeft:function(e,t,a){var s=String(t||10).length-String(e).length+1;return s>0?new Array(s).join(a||"0")+e:e},getCurrentTime:function(e){var t=new Date(e)||new Date;return CoreUtils.formatDate(t)},formatDate:function(e){var t;return t="string"==typeof e?new Date(e):"object"==typeof e&&e.constructor==Date?e:new Date,[t.getFullYear(),CoreUtils.padLeft(t.getMonth()+1),CoreUtils.padLeft(t.getDate())].join("-")+" "+[CoreUtils.padLeft(t.getHours()),CoreUtils.padLeft(t.getMinutes()),CoreUtils.padLeft(t.getSeconds())].join(":")},mapMessageFromRaw:function(e,t,a){a&&(e.messageType=e.sender!=a?MessageTypes.INCOMING:MessageTypes.OUTGOING),e.receiver||(e.receiver=e.sender);var s=""+e.id,n=0==s.indexOf("m_")||0==s.indexOf("temp_")?e.id:"m_"+e.id,r={id:n,from:e.sender,fromName:e.operator?e.operatorName:e.sender,to:e.receiver,message:e.message,contentType:e.contentType,messageType:e.messageType,operator:e.operator,date:new Date(e.date),endOfConversation:e.endOfConversation,fullImageUrl:e.fullImageUrl,sending:e.sending||!1,isRead:!!e.isReadByOperator,delivered:!!e.delivered};return r},scrollIntoViewNeeded:function(e,t,a){var s=!1;a=0===arguments.length?!0:!!a;var n=window.getComputedStyle(e,null),r=parseInt(n.getPropertyValue("border-top-width")),o=parseInt(n.getPropertyValue("border-left-width")),i=t.offsetTop-e.offsetTop<e.scrollTop,c=t.offsetTop-e.offsetTop+t.clientHeight-r>e.scrollTop+e.clientHeight,l=t.offsetLeft-e.offsetLeft<e.scrollLeft,d=t.offsetLeft-e.offsetLeft+t.clientWidth-o>e.scrollLeft+e.clientWidth,u=i&&!c;return(i||c)&&a&&(e.scrollTop=t.offsetTop-e.offsetTop-e.clientHeight/2-r+t.clientHeight/2),(l||d)&&a&&(e.scrollLeft=t.offsetLeft-e.offsetLeft-e.clientWidth/2-o+t.clientWidth/2,s=!0),(i||c||l||d)&&!a&&(t.scrollIntoView(u),s=!0),s},getCoefficient:function(e,t,a){var s=Math.max(e,t),n=1;return s>a&&(n=s/a),n},getThumbnailBase64:function(e,t){var a=this,s=document.createElement("canvas"),n=new Image;n.onload=function(){var e=n.width,r=n.height,o=a.getCoefficient(e,r,1280);s.width=e/o,s.height=r/o;var i=s.getContext("2d");i.drawImage(n,0,0,s.width,s.height);var c=s.toDataURL("image/png");o=a.getCoefficient(e,r,300),s.width=e/o,s.height=r/o,i.drawImage(n,0,0,s.width,s.height);var l=s.toDataURL("image/png");s=n=null,"function"==typeof t&&t(l,c)},n.src=e},downloadImage:function(e,t,a){var s=document.createElement("img");s.src=e;var n=document.createElement("a");n.setAttribute("download",a),n.setAttribute("href",e),n.appendChild(s);var r=open();r.document.title=t,r.document.body.appendChild(n)},downloadImageByUrl:function(e,t,a){var s=document.createElement("img");s.src=e;var n=document.createElement("a");n.setAttribute("download",a),n.setAttribute("href",e),n.appendChild(s);var r=open();r.document.title=t,r.document.body.appendChild(n)},asyncLoop:function(e){var t=-1,a=e.length,s=function(){return t++,t==a?void e.callback():void e.run(s,t)};s()}},ChatActions={muteNotifications:function(){ChatDispatcher.dispatch({type:ActionTypes.MUTE_NOTIFICATION_SOUND,payload:{}})},unmuteNotifications:function(){ChatDispatcher.dispatch({type:ActionTypes.UNMUTE_NOTIFICATION_SOUND,payload:{}})},operatorStatusChanged:function(e){ChatDispatcher.dispatch({type:ActionTypes.OPERATOR_STATUS_CHANGED,payload:{status:e}})},clientStatusChanged:function(e,t,a){ChatDispatcher.dispatch({type:ActionTypes.CLIENT_STATUS_CHANGED,payload:{id:e,username:t,status:a}})},updateMessageContent:function(e,t,a){ChatDispatcher.dispatch({type:ActionTypes.UPDATE_MESSAGE_CONTENT,payload:{receiver:e,tempMessageId:t,data:a}})},outgoingMessage:function(e){var t=e.id||"m_"+ ++_lastMessageId;ChatDispatcher.dispatch({type:ActionTypes.NEW_OUT_MESSAGE,payload:{id:t,message:e.message,sender:e.sender,operatorName:e.operatorName,receiver:e.receiver,contentType:e.contentType,messageType:e.messageType,date:e.date,fullImage:e.fullImage,sending:e.sending,endOfConversation:e.endOfConversation,operator:!0}})},authSuccess:function(e){ChatDispatcher.dispatch({type:ActionTypes.AUTH_SUCCESS,operator:e})},authFail:function(e){ChatDispatcher.dispatch({type:ActionTypes.AUTH_FAIL,error:e})},incomingMessage:function(e){e.contentType==MessageContentTypes.IMAGE?ChatDispatcher.dispatch({type:ActionTypes.NEW_IN_MESSAGE,payload:{id:e.id,message:"data:image/jpg;base64,"+e.message,sender:e.sender,receiver:e.receiver,contentType:e.contentType,messageType:e.messageType||MessageTypes.INCOMING,date:e.date,endOfConversation:e.endOfConversation,fullImage:null,fullImageUrl:e.fullImageUrl,operator:e.operator,isReadByOperator:e.isReadByOperator,operatorName:e.operatorName},operator:AuthStore.getOperator()}):ChatDispatcher.dispatch({type:ActionTypes.NEW_IN_MESSAGE,payload:{id:e.id,message:e.message,sender:e.sender,receiver:e.receiver,contentType:e.contentType,messageType:e.messageType||MessageTypes.INCOMING,date:e.date,endOfConversation:e.endOfConversation,fullImage:null,fullImageUrl:null,operator:e.operator,isReadByOperator:e.isReadByOperator,operatorName:e.operatorName},operator:AuthStore.getOperator()})},readMessages:function(e){ChatDispatcher.dispatch({type:ActionTypes.READ_MESSAGES,contactId:e,changed:_preActiveContactId!=e})},clickContact:function(e){ChatDispatcher.dispatch({type:ActionTypes.CLICK_CONTACT,prevContactId:_preActiveContactId,contactId:e,changed:_activeContactId!=e})},clearSelected:function(){ChatDispatcher.dispatch({type:ActionTypes.CLEAR_SELECTED_CONTACT})},messagesScroll:function(e,t){ChatDispatcher.dispatch({type:ActionTypes.CONTACT_MESSAGES_SCROLL,contactId:e,scrollTopValue:t})},contactFilter:function(e){ChatDispatcher.dispatch({type:ActionTypes.CONTACT_FILTER,pattern:e})},fetchContacts:function(){ChatDispatcher.dispatch({type:ActionTypes.API_FETCH_CONTACTS})},authenticate:function(e){ChatDispatcher.dispatch({type:ActionTypes.API_AUTH_OPERATOR,credentials:e})},putFullImage:function(e,t){ChatDispatcher.dispatch({type:ActionTypes.PUT_FULL_IMAGE,messageId:e,imageData:t})},fetchContactHistory:function(e,t){ChatDispatcher.dispatch({type:ActionTypes.API_FETCH_CONTACT_HISTORY,contact:e,firstMessageId:t})},fetchNewestContactHistory:function(e,t){var a=/m_|temp_/i,s=t&&+(""+t).replace(a,"");ChatDispatcher.dispatch({type:ActionTypes.API_FETCH_NEWEST_CONTACT_HISTORY,contact:e,lastMessageId:s})}},AuthStore=objectAssign({},EventEmitter.prototype,{errors:[],_clearErrors:function(){this.errors=[]},_addError:function(e){this.errors.push(e)},getErrors:function(){return this.errors},emitChange:function(){this.emit(ChatConstants.OPERATOR_CHANGED)},addChangeListener:function(e){this.on(ChatConstants.OPERATOR_CHANGED,e)},removeChangeListener:function(e){this.removeListener(ChatConstants.OPERATOR_CHANGED,e)},setOperator:function(e){_currentOperator=e},getOperator:function(){return _currentOperator},getStatus:function(){return this.status},setStatus:function(e){this.status=e}}),ParticipantsStore=objectAssign({},EventEmitter.prototype,{emitChange:function(){this.emit(ChatConstants.PARTICIPANTS_CHANGED)},addChangeListener:function(e){this.on(ChatConstants.PARTICIPANTS_CHANGED,e)},removeChangeListener:function(e){this.removeListener(ChatConstants.PARTICIPANTS_CHANGED,e)},getParticipants:function(e){return Object.keys(_chatParticipants[e]||{})},addParticipant:function(e){var t=!1,a=e.receiver,s=e.sender;return _chatParticipants[a]||(_chatParticipants[a]={}),s!=a&&(_chatParticipants[a][s]=1,t=!0),t}}),UnreadMessageStore=objectAssign({},EventEmitter.prototype,{emitChange:function(){this.emit(ChatConstants.MESSAGE_CHANGE_EVENT)},addChangeListener:function(e){this.on(ChatConstants.MESSAGE_CHANGE_EVENT,e)},removeChangeListener:function(e){this.removeListener(ChatConstants.MESSAGE_CHANGE_EVENT,e)},_getUnreadMessageIds:function(e){return _messages[e]&&_messages[e].unreadIds||[]},getCount:function(e){var t=this._getUnreadMessageIds(e);return t.length},getUnreadIds:function(e){return this._getUnreadMessageIds(e)},getAll:function(){var e=0,t=Object.keys(_messages);for(var a in t)e+=this.getCount(t[a]);return e}}),MessageStore=objectAssign({},EventEmitter.prototype,{init:function(e){if(e&&e.length){for(var t=0,a=e.length;a>t;t++){var s=e[t];this.getMessages(s.username),_messages[s.username].unreadIds=new Array(s.unread+1).join("0").split("")}UnreadMessageStore.emitChange()}},_registerOutMessage:function(e){var t=_chatOutMessages[e.receiver];t||(t={}),t[e.id]=e,_chatOutMessages[e.receiver]=t},_unregisterOutMessage:function(e,t){var a=_chatOutMessages[e];a&&delete a[t]},_updateExisted:function(e,t){var a=_messages[e].messages;if(!a)return ChatMessageUpdateStatus.NOT_UPDATED;var s=a["m_"+t.id];return s?(s.id=t.id,s.sending=!1,ChatMessageUpdateStatus.UPDATED_WITH_DB_ID):(s=a[t.tempId])?(s.id=t.id,s.sending=!1,ChatMessageUpdateStatus.UPDATED_WITH_TEMP_ID):!1},getUnsentMessages:function(e){var t=_chatOutMessages[e],a=[];if(t)for(var s in t)a.push(t[s]);return a},getFirstMessageId:function(e){var t=_messages[e].messages;if(!t)return null;var a=Object.keys(t);if(!a.length)return null;var s=a[0];return t[s].id||null},_clearMessageId:function(e){var t=/m_|temp_/i,a=e&&+(""+e).replace(t,"");return+a},getLastDeliveredMessageId:function(e){var t=this.getUnsentMessages(e),a=_messages[e];if(!a)return 0;var s=Object.keys(a.messages);if(t&&t.length>0){var n=t[0].id;if(!a)return 0;var r=s.indexOf(n),o=r-1;return 0>o?0:this._clearMessageId(a.messages[s[o]].id)}var i=s.length-1;if(0>i)return 0;var c=s[i];return this._clearMessageId(a.messages[c].id)},getDbMessageId:function(e,t){var a=_messages[e];return a&&a.messages&&a.messages[t]?a.messages[t].id:null},addContactRawMessages:function(e,t,a,s){var n={},r=[];for(var o in a){var i=a[o],c=!0;i.contentType==MessageContentTypes.IMAGE&&(i.message="data:image/jpg;base64,"+i.message);var l=CoreUtils.mapMessageFromRaw(i,c,e.nick);n[l.id]=l,l.isRead||r.push(l.id)}return MessageStore.addHistoryMessages(t,n,r,s),MessageStore.emitUpdate(),UnreadMessageStore.emitChange(),r},getAll:function(){return _messages},getMessages:function(e){if(!e)return[];_messages[e]||(_messages[e]={messages:{},unreadIds:[],firstUnreadMsgId:null,init:!1});var t=[],a=_messages[e].messages;for(var s in a)t.push(a[s]);return t},getFirstUnreadId:function(e){return e?_messages[e].firstUnreadMsgId:null},addHistoryMessages:function(e,t,a,s){var n=null,r=_messages[e];r?(a&&a.length&&(n=a[0],r.firstUnreadMsgId||(r.firstUnreadMsgId=n),r.unreadIds=a),s?r.messages=React.addons.update(r.messages,{$merge:t}):r.messages=React.addons.update(t,{$merge:r.messages})):(a&&a.length&&(n=a[0]),_messages[e]={messages:t,unreadIds:[],firstUnreadMsgId:n})},addMessage:function(e,t,a){t.isRead=a==e,_messages[e]||(_messages[e]={messages:{},unreadIds:[],firstUnreadMsgId:null}),t.messageType==MessageTypes.OUTGOING||_messages[e].firstUnreadMsgId||(_messages[e].firstUnreadMsgId=t.id),t.isRead||_messages[e].unreadIds.push(t.id),_messages[e].messages[t.id]=t},getUnreadMessagesIds:function(e){return e&&_messages[e]?_messages[e].unreadIds:[]},emitChange:function(){this.emit(ChatConstants.MESSAGE_CHANGE_EVENT)},emitUpdate:function(){this.emit(ChatConstants.MESSAGE_UPDATE_EVENT)},addChangeListener:function(e){this.on(ChatConstants.MESSAGE_CHANGE_EVENT,e)},removeChangeListener:function(e){this.removeListener(ChatConstants.MESSAGE_CHANGE_EVENT,e)},removeUpdateListener:function(e){this.removeListener(ChatConstants.MESSAGE_UPDATE_EVENT,e)},addUpdateListener:function(e){this.on(ChatConstants.MESSAGE_UPDATE_EVENT,e)},addOutMessage:function(e){_lastMessageId++;var t={id:e.id,from:e.operator.nick,fromName:e.operator.name,to:e.contact.name,message:e.data.message,contentType:e.type,messageType:MessageTypes.OUTGOING,endOfConversation:e.endOfConversation,operator:!0,date:e.date,isRead:!0};_messages[e.contact.name].messages[t.id]=t,this.emitChange()},readMessages:function(e){for(var t=_messages[e].messages,a=_messages[e].unreadIds||(_messages[e].unreadIds=[]),s=a.length>0,n=0,r=a.length;r>n;n++)if(0!=a[n]){var o=t[a[n]];o.isRead=!0}return s},clearUnreadMessages:function(e){_messages[e]&&(_messages[e].unreadIds=[])},clearMessages:function(e){_messages[e].messages=[]},getMessage:function(e,t){return _messages[e]&&_messages[e].messages?_messages[e].messages[t]:null}}),ContactsStore=objectAssign({},EventEmitter.prototype,{init:function(e){for(var t=0,a=e.length;a>t;t++){var s=e[t],n=_contacts[s.username]&&_contacts[s.username].loadStatus||"init";_contacts[s.username]={id:s.id,name:s.username,status:s.status,loadStatus:n}}},getCountAll:function(){return Object.keys(_contacts).length},getSearchPattern:function(){return _contactFilterPattern},getAll:function(){var e=[],t=[];if(_contactFilterPattern)for(var a in _contacts){var s=_contacts[a];s.name.indexOf(_contactFilterPattern)>=0&&(s.status==ContactStatus.ONLINE?e.push(s):t.push(s))}else for(var a in _contacts){var s=_contacts[a];s.status==ContactStatus.ONLINE?e.push(s):t.push(s)}return e.concat(t)},setFilter:function(e){this.clearContact(),_contactFilterPattern=e},clearContact:function(){_preActiveContactId=_activeContactId,_activeContactId=null},emitChange:function(){this.emit(ChatConstants.CONTACTS_CHANGE_EVENT)},emitContactSelect:function(){this.emit(ChatConstants.CONTACT_SELECT_EVENT)},addChangeListener:function(e){this.on(ChatConstants.CONTACTS_CHANGE_EVENT,e)},addContactSelectListener:function(e){this.on(ChatConstants.CONTACT_SELECT_EVENT,e)},removeChangeListener:function(e){this.removeListener(ChatConstants.CONTACTS_CHANGE_EVENT,e)},removeContactSelectListener:function(e){this.removeListener(ChatConstants.CONTACT_SELECT_EVENT,e)},getActive:function(){return _activeContactId},getCurrentContact:function(){return _contacts[_activeContactId]},setActive:function(e){var t=_activeContactId!=e;_preActiveContactId=_activeContactId,_activeContactId=e,_preActiveContactId||(_preActiveContactId=_activeContactId);var a=_contacts[_activeContactId].clicks;return _contacts[_activeContactId].clicks=a&&++a||1,t},setLoadingState:function(e){_contacts[e].loadStatus="loading"},setLoadedState:function(e){_contacts[e].loadStatus="loaded"},makeAllOffline:function(){var e=Object.keys(_contacts);if(e.length>0)for(var t=0,a=e.length;a>t;t++)_contacts[e[t]].status=ContactStatus.OFFLINE;this.emitChange()}}),ChatDispatcher=new Flux.Dispatcher;AuthStore.dispatchToken=ChatDispatcher.register(function(e){switch(e.type){case ActionTypes.AUTH_SUCCESS:AuthStore.setStatus(AuthStatuses.SUCCESS),AuthStore.setOperator(e.operator),AuthStore.emitChange();break;case ActionTypes.AUTH_FAIL:AuthStore.setStatus(AuthStatuses.ERROR),AuthStore._clearErrors(),AuthStore._addError(e.error),AuthStore.emitChange();break;case ActionTypes.OPERATOR_STATUS_CHANGED:_currentOperator.status=e.payload.status,AuthStore.emitChange()}}),ParticipantsStore.dispatchToken=ChatDispatcher.register(function(e){var t;switch(e.type){case ActionTypes.NEW_IN_MESSAGE:case ActionTypes.NEW_OUT_MESSAGE:var a=e.payload;t=ParticipantsStore.addParticipant(a),t&&ParticipantsStore.emitChange()}}),ContactsStore.dispatchToken=ChatDispatcher.register(function(e){switch(ChatDispatcher.waitFor([AuthStore.dispatchToken]),e.type){case ActionTypes.CLICK_CONTACT:if(e.changed){var t=ContactsStore.setActive(e.contactId);t&&ContactsStore.emitContactSelect()}break;case ActionTypes.CONTACT_MESSAGES_SCROLL:_contacts[e.contactId].scrollTop=e.scrollTopValue,ContactsStore.emitChange();break;case ActionTypes.CONTACT_FILTER:ContactsStore.setFilter(e.pattern),ContactsStore.emitChange();break;case ActionTypes.CLEAR_SELECTED_CONTACT:ContactsStore.clearContact();break;case ActionTypes.API_FETCH_CONTACT_HISTORY:ContactsStore.setLoadingState(e.contact.name,"loading");break;case ActionTypes.CLIENT_STATUS_CHANGED:var a=e.payload,s=_contacts[a.username];s?s.status=a.status:_contacts[a.username]={id:a.id,name:a.username,status:a.status,loadStatus:"init"},ContactsStore.emitChange()}}),MessageStore.dispatchToken=ChatDispatcher.register(function(e){ChatDispatcher.waitFor([ContactsStore.dispatchToken]);var t,a=null;switch(e.type){case ActionTypes.CLICK_CONTACT:e.changed&&(_messages[e.prevContactId]&&(_messages[e.prevContactId].firstUnreadMsgId=null,_preActiveContactId=_activeContactId),MessageStore.emitUpdate());break;case ActionTypes.NEW_OUT_MESSAGE:var s=e.payload;a=CoreUtils.mapMessageFromRaw(s,!0);var n=a.to;t=ContactsStore.getActive(),MessageStore.addMessage(n,a,t),s.receiver==t&&MessageStore.emitUpdate(),MessageStore._registerOutMessage(s),MessageStore.emitChange();break;case ActionTypes.NEW_IN_MESSAGE:var r=e.payload;a=CoreUtils.mapMessageFromRaw(r,!1,e.operator.nick),t=ContactsStore.getActive(),MessageStore.addMessage(a.to,a,t),r.sender!=t&&r.receiver!=t||MessageStore.emitUpdate(),MessageStore.emitChange();break;case ActionTypes.CONTACT_FILTER:break;case ActionTypes.UPDATE_MESSAGE_CONTENT:var o=e.payload,i=o.data,c=_messages[o.receiver].messages[o.tempMessageId];MessageStore._unregisterOutMessage(o.receiver,o.tempMessageId),c.id=i.id,c.sending=!1,i.contentType==MessageContentTypes.IMAGE&&(c.fullImageUrl=i.fullImageUrl),i.receiver==t&&MessageStore.emitUpdate(),MessageStore.emitChange()}}),UnreadMessageStore.dispatchToken=ChatDispatcher.register(function(e){switch(ChatDispatcher.waitFor([ContactsStore.dispatchToken,MessageStore.dispatchToken]),e.type){case ActionTypes.READ_MESSAGES:var t=MessageStore.readMessages(e.contactId);t&&UnreadMessageStore.emitChange();break;case ActionTypes.NEW_OUT_MESSAGE:UnreadMessageStore.emitChange();break;case ActionTypes.NEW_IN_MESSAGE:UnreadMessageStore.emitChange();break;case ActionTypes.CLICK_CONTACT:e.changed&&UnreadMessageStore.emitChange();break;case ActionTypes.RECEIVE_RAW_MESSAGES:UnreadMessageStore.emitChange()}});var OperatorInfo=React.createClass({displayName:"OperatorInfo",getInitialState:function(){return{operator:AuthStore.getOperator()}},componentDidMount:function(){AuthStore.addChangeListener(this._onAuthChanged)},componentWillUnmount:function(){AuthStore.removeChangeListener(this._onAuthChanged)},_onAuthChanged:function(){this.setState({operator:AuthStore.getOperator()})},_onMuteVolumeChange:function(e){e?ChatActions.muteNotifications():ChatActions.unmuteNotifications()},render:function(){return React.createElement("div",{className:"operator-info operator-"+this.state.operator.status},React.createElement(MuteUnmuteButton,{muted:!1,onChange:this._onMuteVolumeChange}),"  ",React.createElement("i",{className:"fa fa-circle "+this.state.operator.status||ContactStatus.OFFLINE}),"  ",React.createElement("b",null,this.state.operator.name)," ","("+this.state.operator.nick+")")}}),LoadMessageHistoryButton=React.createClass({displayName:"LoadMessageHistoryButton",getInitialState:function(){return{btnState:this.props.status||"init"}},_onClick:function(e){e.preventDefault(),e.stopPropagation(),"function"==typeof this.props.onClick&&this.props.onClick(),this.setState({btnState:"loading"})},componentWillReceiveProps:function(e){this.setState({btnState:e.status})},_renderState:function(){switch(this.state.btnState){case"init":return React.createElement("div",{className:"history-load",style:{textAlign:"center"}},React.createElement("span",{className:"btn-badge"},React.createElement("a",{onClick:this._onClick,href:"#"},this.props.title)));case"loading":return React.createElement("div",{className:"history-load",style:{textAlign:"center"}},React.createElement("span",{className:"btn-badge"},React.createElement("b",null,this.props.titleLoading||"Loading...")));case"loaded":return React.createElement("div",{className:"history-load",style:{textAlign:"center"}})}},render:function(){return this._renderState()}}),UploadImageButton=React.createClass({displayName:"UploadImageButton",getCoefficient:function(e,t,a){var s=Math.max(e,t),n=1;return s>a&&(n=s/a),n},_onUploadedBase64:function(e,t){this.props.onImageBase64&&this.props.onImageBase64(e,t)},_onFileChange:function(e){if("function"==typeof window.FileReader){var t=this.refs.fileUpload,a=t.files[0],s=new FileReader,n=this;s.onload=function(){var e=new Image;e.onload=function(){var e=n.refs.imageCanvas,t=n.img.width,a=n.img.height,s=n.getCoefficient(t,a,1280);e.width=t/s,e.height=a/s;var r=e.getContext("2d");r.drawImage(n.img,0,0,e.width,e.height);var o=e.toDataURL("image/png");s=n.getCoefficient(t,a,300),e.width=t/s,e.height=a/s,r.drawImage(n.img,0,0,e.width,e.height);var i=e.toDataURL("image/png");n._onUploadedBase64(i,o)},e.src=s.result,n.img=e},s.readAsDataURL(a)}},render:function(){return this.props.btnEnabled?React.createElement("i",{className:this.props.classes,style:{position:"relative"}},React.createElement("form",{action:"#"},React.createElement("input",{style:{opacity:0,zIndex:2,left:0,top:0,width:"100%",position:"absolute"},ref:"fileUpload",type:"file",accept:"image/*",onChange:this._onFileChange})),React.createElement("canvas",{ref:"imageCanvas",style:{display:"none"}})):React.createElement("i",{className:this.props.classes,style:{position:"relative"}})}}),UnreadOutgoingMessage=React.createClass({displayName:"UnreadOutgoingMessage",scrolled:!1,canScroll:function(){return!this.scrolled},scrollIntoViewIfNeeded:function(e,t){if(!this.scrolled){var a=ReactDOM.findDOMNode(this);CoreUtils.scrollIntoViewNeeded(e,a,t),this.scrolled=!0}},_onDownloadMessages:function(e){CoreUtils.downloadImageByUrl(this.props.data.fullImageUrl,"Image viewing","chat-thumbnail.png"),e.preventDefault(),e.stopPropagation()},renderMessage:function(e){return e.contentType==MessageContentTypes.TEXT?e.message||"Empty message":e.contentType==MessageContentTypes.IMAGE?React.createElement("a",{href:"#",onClick:this._onDownloadMessages},React.createElement("img",{className:"image-message",src:e.message})):void 0},operatorStatus:function(){return this.props.data.operator?React.createElement("i",{className:"msg-badge"},"operator"):""},render:function(){return React.createElement("li",{className:"message-container clearfix messages-unread"},React.createElement("span",{className:"mark"},"New messages"),React.createElement("div",{className:"message-data align-right"},React.createElement("span",{className:"message-data-time"},CoreUtils.getCurrentTime(this.props.data.date)),"   ",React.createElement("span",{className:"message-data-name"},this.props.data.fromName||"Empty sender",this.operatorStatus()),"  "),React.createElement("div",{className:"message other-message float-right"},this.renderMessage(this.props.data)))}}),UnreadIncomingMessage=React.createClass({displayName:"UnreadIncomingMessage",scrolled:!1,_onDownloadMessages:function(e){CoreUtils.downloadImageByUrl(this.props.data.fullImageUrl,"Image viewing","chat-thumbnail.png"),e.preventDefault(),e.stopPropagation()},renderMessage:function(e){return e.contentType==MessageContentTypes.TEXT?e.message||"Empty message":e.contentType==MessageContentTypes.IMAGE?React.createElement("a",{href:"#",onClick:this._onDownloadMessages},React.createElement("img",{className:"image-message",src:e.message})):void 0},scrollIntoViewIfNeeded:function(e,t){if(!this.scrolled){var a=ReactDOM.findDOMNode(this);CoreUtils.scrollIntoViewNeeded(e,a,t),this.scrolled=!0}},canScroll:function(){return!this.scrolled},_operatorStatus:function(){return this.props.data.operator?React.createElement("i",{className:"msg-badge"},"operator"):""},_operatorMsgClasses:function(){return this.props.data.operator?" other-operator":""},render:function(){return React.createElement("li",{className:"message-container messages-unread"},React.createElement("span",{className:"mark"},"New messages"),React.createElement("div",{className:"message-data"},React.createElement("span",{className:"message-data-name"},this.props.data.fromName||"Not specified",this._operatorStatus()),React.createElement("span",{
className:"message-data-time"},CoreUtils.getCurrentTime(this.props.data.date))),React.createElement("div",{className:"message my-message"+this._operatorMsgClasses()},this.renderMessage(this.props.data)))}}),UnreadEndConversationMessage=React.createClass({displayName:"UnreadEndConversationMessage",scrolled:!1,scrollIntoViewIfNeeded:function(e,t){if(!this.scrolled){var a=ReactDOM.findDOMNode(this);CoreUtils.scrollIntoViewNeeded(e,a,t),this.scrolled=!0}},canScroll:function(){return!this.scrolled},renderMessage:function(e){return React.createElement("div",{className:"message-resolved"})},operatorStatus:function(){return this.props.data.operator?React.createElement("i",{className:"msg-badge"},"operator"):""},render:function(){return React.createElement("li",{className:"message-container clearfix messages-unread"},React.createElement("span",{className:"mark"},"New messages"),React.createElement("div",{className:"message-data align-right"},React.createElement("span",{className:"message-data-time"},CoreUtils.getCurrentTime(this.props.data.date)),"   ",React.createElement("span",{className:"message-data-name"},this.props.data.fromName||"Empty sender",this.operatorStatus()),"  "),this.renderMessage(this.props.data))}}),TypingMessage=React.createClass({displayName:"TypingMessage",render:function(){var e=function(){return(new Date).toLocaleTimeString().replace(/([\d]+:[\d]{2})(:[\d]{2})(.*)/,"$1$3")};return React.createElement("li",null,React.createElement("div",{className:"message-data"},React.createElement("span",{className:"message-data-name"},React.createElement("i",{className:"fa fa-circle online"}),this.props.phone||"Not specified"),React.createElement("span",{className:"message-data-time"},this.props.time||e())),React.createElement("i",{className:"fa fa-circle online"}),React.createElement("i",{className:"fa fa-circle online",style:{color:"#AED2A6"}}),React.createElement("i",{className:"fa fa-circle online",style:{color:"#DAE9DA"}}))}}),OutgoingMessage=React.createClass({displayName:"OutgoingMessage",canScroll:function(){return!0},scrollIntoViewIfNeeded:function(e,t){var a=ReactDOM.findDOMNode(this);CoreUtils.scrollIntoViewNeeded(e,a,t)},_onDownloadMessages:function(e){CoreUtils.downloadImageByUrl(this.props.data.fullImageUrl,"Image viewing","chat-thumbnail.png"),e.preventDefault(),e.stopPropagation()},operatorStatus:function(){return this.props.data.operator?React.createElement("i",{className:"msg-badge"},"operator"):""},renderSendIndicator:function(e){return e.sending?React.createElement("span",{className:"fa fa-refresh fa-spin fa-fw send-icon"}):""},renderMessage:function(e){return e.contentType==MessageContentTypes.TEXT?e.message||"Empty message":e.contentType==MessageContentTypes.IMAGE?React.createElement("a",{href:"#",onClick:this._onDownloadMessages},React.createElement("img",{className:"image-message",src:e.message})):void 0},render:function(){return React.createElement("li",{className:"clearfix"},React.createElement("div",{className:"message-data align-right"},React.createElement("span",{className:"message-data-time"},CoreUtils.getCurrentTime(this.props.data.date)),"   ",React.createElement("span",{className:"message-data-name"},this.props.data.fromName||"Empty sender",this.operatorStatus()),"  "),React.createElement("div",{className:"message other-message float-right"},this.renderMessage(this.props.data),this.renderSendIndicator(this.props.data)))}}),MinChatBox=React.createClass({displayName:"MinChatBox",getInitialState:function(){return{clientsCount:ContactsStore.getCountAll(),unreadCount:UnreadMessageStore.getAll()}},componentDidMount:function(){UnreadMessageStore.addChangeListener(this._onUnreadChange),ContactsStore.addChangeListener(this._onContactsChanged)},componentWillUnmount:function(){UnreadMessageStore.removeChangeListener(this._onUnreadChange),ContactsStore.removeChangeListener(this._onContactsChanged)},_onContactsChanged:function(){var e=ContactsStore.getCountAll();this.setState({clientsCount:e})},_onUnreadChange:function(){var e=UnreadMessageStore.getAll();this.setState({unreadCount:e})},_maximizeClicked:function(){"function"==typeof this.props.onMaximize&&this.props.onMaximize()},render:function(){return React.createElement("div",{className:"chat-container min-container clearfix"},React.createElement("div",{className:"msg-count center-text bg-"+this.props.status},React.createElement("div",{className:"status"},React.createElement("i",{className:"fa fa-circle "+this.props.status||ContactStatus.OFFLINE}),this.props.status),React.createElement("div",null,"Clients: ",React.createElement("i",{className:"clients-badge"},this.state.clientsCount))),React.createElement("div",{className:"chat-info"},"New: ",React.createElement("span",{className:"msg-badge unread"},this.state.unreadCount),React.createElement(IconButton,{onClick:this._maximizeClicked,classes:"fa fa-2x fa-plus-square maximize-icon"})))}}),EmptyMinChatBox=React.createClass({displayName:"EmptyMinChatBox",_maximizeClicked:function(){"function"==typeof this.props.onMaximize&&this.props.onMaximize()},render:function(){return React.createElement("div",{className:"chat-container min-container clearfix"},React.createElement("div",{className:"msg-count-empty center-text"},"Chat"),React.createElement("div",{className:"chat-info"},React.createElement(IconButton,{onClick:this._maximizeClicked,classes:"fa fa-2x fa-plus-square maximize-icon"})))}}),LoginBox=React.createClass({displayName:"LoginBox",componentDidMount:function(){AuthStore.addChangeListener(this._onAuthChanged)},componentWillUnmount:function(){AuthStore.removeChangeListener(this._onAuthChanged)},getInitialState:function(){return{loginState:this.props.initialLoginState||"login",error:!1,messages:AuthStore.getErrors()}},_onAuthChanged:function(){AuthStore.getStatus()===AuthStatuses.SUCCESS?(this.successState(),"function"==typeof this.props.onAuthSuccess&&setTimeout(function(){this.props.onAuthSuccess(AuthStore.getOperator())}.bind(this),1e3)):this.tryAgainState()},_onMinimize:function(){this.setState({loginState:"min",originalState:this.state.loginState})},_onMaximize:function(){this.setState({loginState:this.state.originalState})},progressState:function(){this.setState({loginState:"progress",originalState:"progress"})},successState:function(){this.setState({loginState:"success",originalState:"success",error:!1,messages:[]})},tryAgainState:function(){this.setState({loginState:"login",originalState:"login",error:!0,messages:AuthStore.getErrors()})},loginClick:function(e){this.progressState(),ChatActions.authenticate()},_renderErrorInfo:function(){return this.state.error?React.createElement("div",{className:"error-box"},React.createElement("ul",null,this.state.messages.map(function(e){return React.createElement("li",null,e)}))):""},renderState:function(){switch(this.state.loginState){case"min":return React.createElement(EmptyMinChatBox,{onMaximize:this._onMaximize});case"login":return React.createElement("div",{className:"chat"},React.createElement(EmptyHeaderBox,{onMinimize:this._onMinimize}),React.createElement("div",{className:"wrapper"},this._renderErrorInfo(),React.createElement("button",{className:"login-btn",onClick:this.loginClick},React.createElement("i",{className:"chat-spinner"}),React.createElement("span",{className:"state"},"Log in"))));case"progress":return React.createElement("div",{className:"chat"},React.createElement(EmptyHeaderBox,{onMinimize:this._onMinimize}),React.createElement("div",{className:"wrapper loading"},React.createElement("button",{className:"login-btn"},React.createElement("i",{className:"chat-spinner"}),React.createElement("span",{className:"state"},"Authenticating"))));case"success":return React.createElement("div",{className:"chat"},React.createElement(EmptyHeaderBox,{onMinimize:this._onMinimize}),React.createElement("div",{className:"wrapper ok loading"},React.createElement("button",{className:"login-btn"},React.createElement("i",{className:"chat-spinner"}),React.createElement("span",{className:"state"},"Welcome back!"))))}},render:function(){return this.renderState()}}),IncomingMessage=React.createClass({displayName:"IncomingMessage",_onDownloadMessages:function(e){CoreUtils.downloadImageByUrl(this.props.data.fullImageUrl,"Image viewing","chat-thumbnail.png"),e.preventDefault(),e.stopPropagation()},renderMessage:function(e){return e.contentType==MessageContentTypes.TEXT?e.message||"Empty message":e.contentType==MessageContentTypes.IMAGE?React.createElement("a",{href:"#",onClick:this._onDownloadMessages},React.createElement("img",{className:"image-message",src:e.message})):void 0},operatorStatus:function(){return this.props.data.operator?React.createElement("i",{className:"msg-badge"},"operator"):""},_operatorMsgClasses:function(){return this.props.data.operator?" other-operator":""},render:function(){return React.createElement("li",null,React.createElement("div",{className:"message-data"},React.createElement("span",{className:"message-data-name"},this.props.data.fromName||"Not specified",this.operatorStatus()),React.createElement("span",{className:"message-data-time"},CoreUtils.getCurrentTime(this.props.data.date))),React.createElement("div",{className:"message my-message"+this._operatorMsgClasses()},this.renderMessage(this.props.data)))}}),MuteUnmuteButton=React.createClass({displayName:"MuteUnmuteButton",_styles:{cursor:"pointer"},getInitialState:function(){return{muted:this.props.muted||!1}},getClasses:function(){var e="msg-badge badge-sm ";return this.state.muted?e+"fa fa-volume-off":e+"fa fa-volume-up"},_onClick:function(){"function"==typeof this.props.onChange&&this.props.onChange(!this.state.muted),this.setState({muted:!this.state.muted})},render:function(){return React.createElement("i",{style:this._styles,onClick:this._onClick,className:this.getClasses()})}}),IconButton=React.createClass({displayName:"IconButton",render:function(){return React.createElement("i",{onClick:this.props.onClick||function(){},className:this.props.classes})}}),HistoryButton=React.createClass({displayName:"HistoryButton",render:function(){return this.props.btnEnabled?React.createElement("button",{onClick:this.props.onClick,className:this.props.classes},React.createElement("i",{className:this.props.icons}),"  ",this.props.title||""):React.createElement("button",{disabled:"disabled",className:this.props.classes},React.createElement("i",{className:this.props.icons}),"  ",this.props.title||"")}}),HistoryBox=React.createClass({displayName:"HistoryBox",scroll:0,canScroll:!0,renderMessage:function(e,t){var a=this.props.contact;switch(e.messageType){case MessageTypes.INCOMING:return e.id==t?e.endOfConversation?React.createElement(UnreadEndConversationMessage,{key:e.id,data:e,status:a.status}):React.createElement(UnreadIncomingMessage,{ref:"unreadItem",key:e.id,data:e,status:a.status}):e.endOfConversation?React.createElement(EndConversationMessage,{key:e.id,data:e,status:a.status}):React.createElement(IncomingMessage,{key:e.id,data:e,status:a.status});case MessageTypes.OUTGOING:return e.id==t?e.endOfConversation?React.createElement(UnreadEndConversationMessage,{key:e.id,data:e,status:a.status}):React.createElement(UnreadOutgoingMessage,{ref:"unreadItem",key:e.id,data:e,status:a.status}):e.endOfConversation?React.createElement(EndConversationMessage,{key:e.id,data:e,status:a.status}):React.createElement(OutgoingMessage,{key:e.id,data:e,status:a.status})}},_scrollToFirstUnread:function(){var e=this.refs.unreadItem,t=ReactDOM.findDOMNode(this);e&&e.canScroll()?(this.refs.unreadItem.scrollIntoViewIfNeeded(t,!0),this.scroll=t.scrollHeight-t.offsetHeight):this.canScroll&&(t.scrollTop=t.scrollHeight,this.scroll=t.scrollHeight-t.offsetHeight)},_onLoadHistory:function(){"function"==typeof this.props.onLoadHistory&&this.props.onLoadHistory(this.props.contact)},componentDidMount:function(){this._scrollToFirstUnread()},componentWillUpdate:function(e,t){e.contact.id!=this.props.contact.id&&(this.scroll=0);var a=ReactDOM.findDOMNode(this);this.canScroll=!this.props.messages.length||a.scrollTop>=this.scroll},componentDidUpdate:function(){this._scrollToFirstUnread()},_renderLoadHistoryButton:function(){return this.props.operator.status==ContactStatus.ONLINE?React.createElement(LoadMessageHistoryButton,{status:this.props.contact.loadStatus,onClick:this._onLoadHistory,title:"Load history",titleLoading:"Loading..."}):null},render:function(){var e=this.renderMessage,t=this.props.firstUnreadMsgId;return React.createElement("div",{className:"chat-history"},this._renderLoadHistoryButton(),React.createElement("ul",{className:"chat-history-messages"},this.props.messages.map(function(a){return e(a,t)})))}}),HeaderBox=React.createClass({displayName:"HeaderBox",closeClicked:function(e){"function"==typeof this.props.onClose&&this.props.onClose()},_minimizeClicked:function(e){"function"==typeof this.props.onMinimize&&this.props.onMinimize()},render:function(){return React.createElement("div",{className:"chat-header clearfix"},React.createElement("div",{className:"chat-about"},React.createElement("div",{className:"chat-with"}," Chat with: ",this.props.contact.name||""),React.createElement("div",{className:"chat-num-messages"},"already",React.createElement("i",{className:"msg-badge"},this.props.count||0),"messages")),React.createElement(IconButton,{onClick:this.closeClicked,classes:"fa fa-times header-icon"}),React.createElement(IconButton,{onClick:this._minimizeClicked,classes:"fa fa-minus-square header-icon"}))}}),FooterBox=React.createClass({displayName:"FooterBox",getInitialState:function(){return{value:""}},sendMessage:function(e){if(""!==this.state.value.trim()){var t=new Date,a={id:"temp_"+ ++_lastMessageId,message:this.state.value,sender:this.props.operator.nick,operatorName:this.props.operator.name,receiver:this.props.contact.name,contentType:MessageContentTypes.TEXT,messageType:MessageTypes.OUTGOING,endOfConversation:!1,date:t,sending:!0,fullImage:null};ChatActions.outgoingMessage(a),this.setState({value:""})}},sendEndMessage:function(e){var t=new Date,a={id:"temp_"+ ++_lastMessageId,message:"End of conversation",sender:this.props.operator.nick,operatorName:this.props.operator.name,receiver:this.props.contact.name,contentType:MessageContentTypes.TEXT,messageType:MessageTypes.OUTGOING,endOfConversation:!0,date:t,sending:!0,fullImage:null};ChatActions.outgoingMessage(a)},handleChange:function(e){this.setState({value:e.target.value})},handleKeyUp:function(e){e.keyCode===KeyConstants.ENTER_KEY&&this.sendMessage()},_onImageUpload:function(e,t){var a=new Date,s={id:null,message:e,sender:this.props.operator.nick,operatorName:this.props.operator.name,receiver:this.props.contact.name,contentType:MessageContentTypes.IMAGE,messageType:MessageTypes.OUTGOING,endOfConversation:!1,date:a,sending:!0,fullImage:t};ChatActions.outgoingMessage(s)},_operatorOnline:function(){return this.props.operator.status==ContactStatus.ONLINE},_getTextArea:function(){return this._operatorOnline()?React.createElement("textarea",{name:"message-to-send",id:"message-to-send",placeholder:"Type your message",value:this.state.value,onChange:this.handleChange,onKeyUp:this.handleKeyUp,rows:"2"}):React.createElement("textarea",{disabled:"disabled",name:"message-to-send",id:"message-to-send",placeholder:"Type your message",value:this.state.value,rows:"2"})},render:function(){return React.createElement("div",{className:"chat-message clearfix"},this._getTextArea(),React.createElement(IconButton,{btnEnabled:this._operatorOnline(),classes:"fa fa-file-o"}),"   ",React.createElement(UploadImageButton,{btnEnabled:this._operatorOnline(),onImageBase64:this._onImageUpload,classes:"fa fa-file-image-o"}),React.createElement(HistoryButton,{btnEnabled:this._operatorOnline(),onClick:this.sendMessage,title:"send",icons:"fa fa-paper-plane-o",classes:"btn-send"}),React.createElement(HistoryButton,{btnEnabled:this._operatorOnline(),onClick:this.sendEndMessage,title:"end",icons:"fa fa-comments",classes:"btn-replied"}))}}),EndConversationMessage=React.createClass({displayName:"EndConversationMessage",operatorStatus:function(){return this.props.data.operator?React.createElement("i",{className:"msg-badge"},"operator"):""},renderMessage:function(e){return React.createElement("div",{className:"message-resolved"})},render:function(){return React.createElement("li",{className:"clearfix"},React.createElement("div",{className:"message-data align-right"},React.createElement("span",{className:"message-data-time"},CoreUtils.getCurrentTime(this.props.data.date)),"   ",React.createElement("span",{className:"message-data-name"},this.props.data.fromName||"Empty sender",this.operatorStatus()),"  "),this.renderMessage(this.props.data))}}),EmptyHeaderBox=React.createClass({displayName:"EmptyHeaderBox",_onMinimize:function(){"function"==typeof this.props.onMinimize&&this.props.onMinimize()},render:function(){return React.createElement("div",{className:"chat-header clearfix"},React.createElement(IconButton,{onClick:this._onMinimize,classes:"fa fa-minus-square header-icon"}))}}),EmptyConversationBox=React.createClass({displayName:"EmptyConversationBox",_onMinimize:function(){"function"==typeof this.props.onMinimize&&this.props.onMinimize()},render:function(){return React.createElement("div",{className:"chat"},React.createElement(EmptyHeaderBox,{onMinimize:this._onMinimize}),React.createElement(EmptyChatBox,null))}}),EmptyChatBox=React.createClass({displayName:"EmptyChatBox",render:function(){return React.createElement("div",{className:"wrapper no-conversation"},React.createElement("div",null,React.createElement("i",{className:"fa fa-4x fa-comment"})),React.createElement("span",{className:"state"},"No conversation"))}}),ConversationBox=React.createClass({displayName:"ConversationBox",_onClose:function(){"function"==typeof this.props.onClose&&this.props.onClose()},_onMinimize:function(){"function"==typeof this.props.onMinimize&&this.props.onMinimize()},_onOutMessage:function(e){"function"==typeof this.props.onOutgoingMessage&&this.props.onOutgoingMessage(e)},_onLoadHistory:function(e){"function"==typeof this.props.onLoadHistory&&this.props.onLoadHistory(e)},render:function(){return React.createElement("div",{className:"chat"},React.createElement(HeaderBox,{contact:this.props.contact,count:this.props.messages.length,onClose:this._onClose,onMinimize:this._onMinimize}),React.createElement(HistoryBox,{contact:this.props.contact,operator:this.props.operator,firstUnreadMsgId:this.props.firstUnreadMsgId,messages:this.props.messages,onLoadHistory:this._onLoadHistory}),React.createElement(FooterBox,{operator:this.props.operator,contact:this.props.contact,onMessage:this._onOutMessage}))}}),ContactsListBox=React.createClass({displayName:"ContactsListBox",onActivateContact:function(e){"function"==typeof this.props.onSelectContact&&this.props.onSelectContact(e)},render:function(){var e=this.props.current?this.props.current.name:null,t=this.onActivateContact;return React.createElement("ul",{className:"list"},this.props.items.map(function(a){return React.createElement(Contact,{key:a.id,data:a,selectedId:e,onActivate:t})}))}}),ContactSearchBox=React.createClass({displayName:"ContactSearchBox",getInitialState:function(){return{value:this.props.pattern||""}},_handleChange:function(e){this.setState({value:e.target.value}),"function"==typeof this.props.onLiveSearch&&this.props.onLiveSearch(e.target.value)},_handleKeyUp:function(e){e.keyCode===KeyConstants.ENTER_KEY&&this._onSearch()},_onSearch:function(){"function"==typeof this.props.onSearch&&this.props.onSearch(this.state.value)},_onClear:function(){this.setState({value:""}),"function"==typeof this.props.onClear&&this.props.onClear()},render:function(){return React.createElement("div",{className:"search"},React.createElement("input",{className:"search-input",onChange:this._handleChange,onKeyUp:this._handleKeyUp,type:"text",placeholder:"search",value:this.state.value}),React.createElement("i",{onClick:this._onSearch,className:"fa fa-search"}),React.createElement("i",{onClick:this._onClear,className:"fa fa-close"}))}}),ContactsBox=React.createClass({displayName:"ContactsBox",_onSearch:function(e){ChatActions.contactFilter(e)},_onClear:function(){ChatActions.contactFilter("")},_onLiveSearch:function(e){ChatActions.contactFilter(e)},_onSelectContact:function(e){"function"==typeof this.props.onSelectContact&&this.props.onSelectContact(e)},render:function(){var e=this.props.searchPattern||"";return React.createElement("div",{className:"people-list",id:"people-list"},React.createElement(ContactSearchBox,{onLiveSearch:this._onLiveSearch,pattern:e,onSearch:this._onSearch,onClear:this._onClear}),React.createElement(OperatorInfo,null),React.createElement(ContactsListBox,{items:this.props.contacts,current:this.props.current,onSelectContact:this._onSelectContact}))}}),Contact=React.createClass({displayName:"Contact",getInitialState:function(){var e=UnreadMessageStore.getCount(this.props.data.name),t=ParticipantsStore.getParticipants(this.props.data.name);return{active:!1,unread:e,participants:t}},componentDidMount:function(){UnreadMessageStore.addChangeListener(this._onUnreadChange),ParticipantsStore.addChangeListener(this._participantsChange)},componentWillUnmount:function(){UnreadMessageStore.removeChangeListener(this._onUnreadChange),ParticipantsStore.removeChangeListener(this._participantsChange)},_onUnreadChange:function(){var e=UnreadMessageStore.getCount(this.props.data.name);this.setState({unread:e})},_participantsChange:function(){var e=ParticipantsStore.getParticipants(this.props.data.name);e.length>0&&this.setState({participants:e})},_getParticipants:function(){return this.state.participants?React.createElement("span",null,this.state.participants.map(function(e,t){return React.createElement("span",{key:t,className:"msg-badge badge-sm"},e)})):""},activateContact:function(){"function"==typeof this.props.onActivate&&this.props.onActivate(this.props.data)},getUnreadMessageCount:function(){return this.state.unread?React.createElement("i",{className:"msg-badge unread"},this.state.unread||0):""},clientActive:function(){var e=this.props.data;return this.props.selectedId==e.name?" active":""},render:function(){return React.createElement("li",{className:"contact clearfix"+this.clientActive(),onClick:this.activateContact},React.createElement("div",{className:"about"},React.createElement("div",{className:"name"},this.props.data.name||"+000000000000"),React.createElement("div",{className:"status"},React.createElement("i",{className:"fa fa-circle "+this.props.data.status||ContactStatus.OFFLINE}),this.props.data.status||ContactStatus.OFFLINE),React.createElement("div",null,this._getParticipants()),React.createElement("div",{className:"msg-unread"},this.getUnreadMessageCount())))}}),ChatBox=React.createClass({displayName:"ChatBox",getInitialState:function(){return{chatState:this.props.initialChatState||"login",contacts:[],messages:[],currentContact:{},operator:{},unread:0,searchPattern:ContactsStore.getSearchPattern()}},componentDidMount:function(){AuthStore.addChangeListener(this._onAuthChanged),ContactsStore.addChangeListener(this._storeContactsChange),ContactsStore.addContactSelectListener(this._storeContactSelect),MessageStore.addUpdateListener(this._storeMessagesChange)},componentWillUnmount:function(){AuthStore.removeChangeListener(this._onAuthChanged),ContactsStore.removeChangeListener(this._storeContactsChange),ContactsStore.removeContactSelectListener(this._storeContactSelect),MessageStore.removeUpdateListener(this._storeMessagesChange)},_onAuthChanged:function(){this.setState({operator:AuthStore.getOperator(),searchPattern:ContactsStore.getSearchPattern()})},_onSelectContact:function(e){if(ChatActions.clickContact(e.name),ChatActions.readMessages(e.name),this.state.operator.status==ContactStatus.ONLINE)if("init"==e.loadStatus){var t=MessageStore.getLastDeliveredMessageId(e.name);ChatActions.fetchContactHistory(e,t)}else{var a=MessageStore.getLastDeliveredMessageId(e.name);ChatActions.fetchNewestContactHistory(e,a)}},_storeContactSelect:function(){var e=ContactsStore.getCurrentContact();this.setState({chatState:"chat",currentContact:e,searchPattern:ContactsStore.getSearchPattern()})},_storeContactsChange:function(){var e=this.state.chatState,t=ContactsStore.getCurrentContact(),a=t&&t.name||null;t||"min"==e||(e="no-chat"),this.setState({chatState:e,currentContact:t,messages:MessageStore.getMessages(a),firstUnreadMsgId:MessageStore.getFirstUnreadId(a),contacts:ContactsStore.getAll(),searchPattern:ContactsStore.getSearchPattern()})},_storeMessagesChange:function(){var e=ContactsStore.getCurrentContact();e&&this.setState({currentContact:e,messages:MessageStore.getMessages(e.name),firstUnreadMsgId:MessageStore.getFirstUnreadId(e.name),searchPattern:ContactsStore.getSearchPattern()})},authSuccess:function(e){this.setState({operator:e,chatState:"no-chat",searchPattern:ContactsStore.getSearchPattern()}),ChatActions.fetchContacts()},onConversationClose:function(){this.setState({chatState:"no-chat",messages:[],currentContact:{},searchPattern:ContactsStore.getSearchPattern()}),ChatActions.clearSelected()},_onMinimize:function(){this.setState({chatState:"min",messages:[],currentContact:{},searchPattern:ContactsStore.getSearchPattern()}),ChatActions.clearSelected()},_onMaximize:function(){this.setState({chatState:"no-chat",messages:[],currentContact:{},searchPattern:ContactsStore.getSearchPattern()})},_onLoadHistory:function(e){var t=MessageStore.getLastDeliveredMessageId(e.name);ChatActions.fetchContactHistory(e,t)},onOutgoingMessage:function(e){var t=this.state.operator,a=this.state.currentContact;MessageStore.addOutMessage({contact:a,operator:t,data:e,type:MessageContentTypes.TEXT})},renderState:function(){switch(this.state.chatState||"login"){case"min":return React.createElement(MinChatBox,{onMaximize:this._onMaximize,status:this.state.operator.status});case"login":return React.createElement("div",{id:"chat-template",className:"chat-container clearfix"},React.createElement(LoginBox,{onAuthSuccess:this.authSuccess}));case"chat":return React.createElement("div",{id:"chat-template",className:"chat-container clearfix"},React.createElement(ContactsBox,{current:this.state.currentContact,searchPattern:this.state.searchPattern,contacts:this.state.contacts,onSelectContact:this._onSelectContact}),React.createElement(ConversationBox,{contact:this.state.currentContact,operator:this.state.operator,messages:this.state.messages,firstUnreadMsgId:this.state.firstUnreadMsgId,onClose:this.onConversationClose,onMinimize:this._onMinimize,onOutgoingMessage:this.onOutgoingMessage,onLoadHistory:this._onLoadHistory}));case"no-chat":return React.createElement("div",{id:"chat-template",className:"chat-container clearfix"},React.createElement(ContactsBox,{searchPattern:this.state.searchPattern,contacts:this.state.contacts,onSelectContact:this._onSelectContact}),React.createElement(EmptyConversationBox,{onMinimize:this._onMinimize}))}},render:function(){return this.renderState()}}),chatBox=ReactDOM.render(React.createElement(ChatBox,null),document.getElementById("chatbox"),function(){if("function"==typeof window.OkkChatReady){var e={Dispatcher:ChatDispatcher,ActionTypes:ActionTypes,Actions:ChatActions,Stores:{AuthStore:AuthStore,ContactsStore:ContactsStore,MessageStore:MessageStore,ParticipantsStore:ParticipantsStore,UnreadMessageStore:UnreadMessageStore},MessageTypes:MessageTypes,MessageContentTypes:MessageContentTypes,CoreUtils:CoreUtils,ChatMessageUpdateStatus:ChatMessageUpdateStatus,ContactStatus:ContactStatus};window.OkkChatReady(e)}});