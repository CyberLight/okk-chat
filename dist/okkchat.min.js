!function e(t,a,n){function s(i,o){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!o&&c)return c(i,!0);if(r)return r(i,!0);throw new Error("Cannot find module '"+i+"'")}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return s(a?a:e)},l,l.exports,e,t,a,n)}return a[i].exports}for(var r="function"==typeof require&&require,i=0;i<n.length;i++)s(n[i]);return s}({1:[function(e,t,a){var n,s,r,i=1,o={},c={},l={},m="",d=function(e){var t,a={};if(!(e instanceof Object)||Array.isArray(e))throw new Error("keyMirror(...): Argument must be an object.");for(t in e)e.hasOwnProperty(t)&&(a[t]=t);return a},u={IMAGE:"image",TEXT:"text"},p={INCOMING:"in",OUTGOING:"out"},h=d({MESSAGE_CHANGE_EVENT:null,CONTACT_SELECT_EVENT:null,MESSAGE_UPDATE_EVENT:null,CONTACTS_CHANGE_EVENT:null,FULL_IMAGES_CHANGE_EVENT:null,OPERATOR_CHANGED:null,PARTICIPANTS_CHANGED:null}),g=d({CLICK_CONTACT:null,RECEIVE_RAW_MESSAGES:null,NEW_OUT_MESSAGE:null,NEW_IN_MESSAGE:null,READ_MESSAGES:null,CONTACT_MESSAGES_SCROLL:null,CONTACT_FILTER:null,CLEAR_SELECTED_CONTACT:null,AUTH_SUCCESS:null,AUTH_FAIL:null,PUT_FULL_IMAGE:null,API_FETCH_CONTACTS:null,API_AUTH_OPERATOR:null,API_FETCH_CONTACT_MESSAGES:null,API_FETCH_CONTACT_HISTORY:null,UPDATE_MESSAGE_CONTENT:null,CLIENT_STATUS_CHANGED:null,OPERATOR_STATUS_CHANGED:null,MUTE_NOTIFICATION_SOUND:null,UNMUTE_NOTIFICATION_SOUND:null}),f={SUCCESS:1,ERROR:2},E={ENTER_KEY:13},C={padLeft:function(e,t,a){var n=String(t||10).length-String(e).length+1;return n>0?new Array(n).join(a||"0")+e:e},getCurrentTime:function(e){var t=new Date(e)||new Date;return t.toLocaleTimeString().replace(/([\d]+:[\d]{2})(:[\d]{2})(.*)/,"$1$3")},formatDate:function(e){var t;return t="string"==typeof e?new Date(e):"object"==typeof e&&e.constructor==Date?e:new Date,[t.getFullYear(),C.padLeft(t.getMonth()+1),C.padLeft(t.getDate())].join("-")+" "+[C.padLeft(t.getHours()),C.padLeft(t.getMinutes()),C.padLeft(t.getSeconds())].join(":")},mapMessageFromRaw:function(e,t,a){a&&(e.messageType=e.sender!=a?p.INCOMING:p.OUTGOING),e.receiver||(e.receiver=e.sender);var n=""+e.id,s=0==n.indexOf("m_")||0==n.indexOf("temp_")?e.id:"m_"+e.id,r={id:s,from:e.sender,fromName:e.operator?e.operatorName:e.sender,to:e.receiver,message:e.message,contentType:e.contentType,messageType:e.messageType,operator:e.operator,date:e.date,endOfConversation:e.endOfConversation,fullImageUrl:e.fullImageUrl,sending:e.sending||!1,isRead:!!t};return r},scrollIntoViewNeeded:function(e,t,a){var n=!1;a=0===arguments.length?!0:!!a;var s=window.getComputedStyle(e,null),r=parseInt(s.getPropertyValue("border-top-width")),i=parseInt(s.getPropertyValue("border-left-width")),o=t.offsetTop-e.offsetTop<e.scrollTop,c=t.offsetTop-e.offsetTop+t.clientHeight-r>e.scrollTop+e.clientHeight,l=t.offsetLeft-e.offsetLeft<e.scrollLeft,m=t.offsetLeft-e.offsetLeft+t.clientWidth-i>e.scrollLeft+e.clientWidth,d=o&&!c;return(o||c)&&a&&(e.scrollTop=t.offsetTop-e.offsetTop-e.clientHeight/2-r+t.clientHeight/2),(l||m)&&a&&(e.scrollLeft=t.offsetLeft-e.offsetLeft-e.clientWidth/2-i+t.clientWidth/2,n=!0),(o||c||l||m)&&!a&&(t.scrollIntoView(d),n=!0),n},getCoefficient:function(e,t,a){var n=Math.max(e,t),s=1;return n>a&&(s=n/a),s},getThumbnailBase64:function(e,t){var a=this,n=document.createElement("canvas"),s=new Image;s.onload=function(){var e=s.width,r=s.height,i=a.getCoefficient(e,r,1280);n.width=e/i,n.height=r/i;var o=n.getContext("2d");o.drawImage(s,0,0,n.width,n.height);var c=n.toDataURL("image/png");i=a.getCoefficient(e,r,150),n.width=e/i,n.height=r/i,o.drawImage(s,0,0,n.width,n.height);var l=n.toDataURL("image/png");n=s=null,"function"==typeof t&&t(l,c)},s.src=e},downloadImage:function(e,t,a){var n=document.createElement("img");n.src=e;var s=document.createElement("a");s.setAttribute("download",a),s.setAttribute("href",e),s.appendChild(n);var r=open();r.document.title=t,r.document.body.appendChild(s)},downloadImageByUrl:function(e,t,a){var n=document.createElement("img");n.src=e;var s=document.createElement("a");s.setAttribute("download",a),s.setAttribute("href",e),s.appendChild(n);var r=open();r.document.title=t,r.document.body.appendChild(s)},asyncLoop:function(e){var t=-1,a=e.length,n=function(){return t++,t==a?void e.callback():void e.run(n,t)};n()}},N={muteNotifications:function(){y.dispatch({type:g.MUTE_NOTIFICATION_SOUND,payload:{}})},unmuteNotifications:function(){y.dispatch({type:g.UNMUTE_NOTIFICATION_SOUND,payload:{}})},operatorStatusChanged:function(e){y.dispatch({type:g.OPERATOR_STATUS_CHANGED,payload:{status:e}})},clientStatusChanged:function(e,t,a){y.dispatch({type:g.CLIENT_STATUS_CHANGED,payload:{id:e,username:t,status:a}})},updateMessageContent:function(e,t,a){y.dispatch({type:g.UPDATE_MESSAGE_CONTENT,payload:{receiver:e,tempMessageId:t,data:a}})},outgoingMessage:function(e){var t=e.id||"m_"+ ++i;y.dispatch({type:g.NEW_OUT_MESSAGE,payload:{id:t,message:e.message,sender:e.sender,operatorName:e.operatorName,receiver:e.receiver,contentType:e.contentType,messageType:e.messageType,date:e.date,fullImage:e.fullImage,sending:e.sending,endOfConversation:e.endOfConversation,operator:!0}})},authSuccess:function(e){y.dispatch({type:g.AUTH_SUCCESS,operator:e})},authFail:function(e){y.dispatch({type:g.AUTH_FAIL,error:e})},incomingMessage:function(e){e.contentType==u.IMAGE?y.dispatch({type:g.NEW_IN_MESSAGE,payload:{id:e.id,message:"data:image/jpg;base64,"+e.message,sender:e.sender,receiver:e.receiver,contentType:e.contentType,messageType:e.messageType||p.INCOMING,date:e.date,endOfConversation:e.endOfConversation,fullImage:null,fullImageUrl:e.fullImageUrl,operator:e.operator,operatorName:e.operatorName},operator:S.getOperator()}):y.dispatch({type:g.NEW_IN_MESSAGE,payload:{id:e.id,message:e.message,sender:e.sender,receiver:e.receiver,contentType:e.contentType,messageType:e.messageType||p.INCOMING,date:e.date,endOfConversation:e.endOfConversation,fullImage:null,fullImageUrl:null,operator:e.operator,operatorName:e.operatorName},operator:S.getOperator()})},readMessages:function(e){y.dispatch({type:g.READ_MESSAGES,contactId:e,changed:s!=e})},clickContact:function(e){y.dispatch({type:g.CLICK_CONTACT,prevContactId:s,contactId:e,changed:n!=e})},clearSelected:function(){y.dispatch({type:g.CLEAR_SELECTED_CONTACT})},messagesScroll:function(e,t){y.dispatch({type:g.CONTACT_MESSAGES_SCROLL,contactId:e,scrollTopValue:t})},contactFilter:function(e){y.dispatch({type:g.CONTACT_FILTER,pattern:e})},fetchContacts:function(){y.dispatch({type:g.API_FETCH_CONTACTS})},authenticate:function(e){y.dispatch({type:g.API_AUTH_OPERATOR,credentials:e})},putFullImage:function(e,t){y.dispatch({type:g.PUT_FULL_IMAGE,messageId:e,imageData:t})},fetchContactHistory:function(e,t){var a=/m_|temp_/i,n=t&&+(""+t).replace(a,"");y.dispatch({type:g.API_FETCH_CONTACT_HISTORY,contact:e,firstMessageId:n})}},S=objectAssign({},EventEmitter.prototype,{errors:[],_clearErrors:function(){this.errors=[]},_addError:function(e){this.errors.push(e)},getErrors:function(){return this.errors},emitChange:function(){this.emit(h.OPERATOR_CHANGED)},addChangeListener:function(e){this.on(h.OPERATOR_CHANGED,e)},removeChangeListener:function(e){this.removeListener(h.OPERATOR_CHANGED,e)},setOperator:function(e){r=e},getOperator:function(){return r},getStatus:function(){return this.status},setStatus:function(e){this.status=e}}),R=objectAssign({},EventEmitter.prototype,{emitChange:function(){this.emit(h.PARTICIPANTS_CHANGED)},addChangeListener:function(e){this.on(h.PARTICIPANTS_CHANGED,e)},removeChangeListener:function(e){this.removeListener(h.PARTICIPANTS_CHANGED,e)},getParticipants:function(e){return Object.keys(l[e]||{})},addParticipant:function(e){var t=!1,a=e.receiver,n=e.sender;return l[a]||(l[a]={}),n!=a&&(l[a][n]=1,t=!0),t}}),_=objectAssign({},EventEmitter.prototype,{emitChange:function(){this.emit(h.MESSAGE_CHANGE_EVENT)},addChangeListener:function(e){this.on(h.MESSAGE_CHANGE_EVENT,e)},removeChangeListener:function(e){this.removeListener(h.MESSAGE_CHANGE_EVENT,e)},_getUnreadMessageIds:function(e){return o[e]&&o[e].unreadIds||[]},getCount:function(e){var t=this._getUnreadMessageIds(e);return t.length},getAll:function(){var e=0,t=Object.keys(o);for(var a in t)e+=this.getCount(t[a]);return e}}),v=objectAssign({},EventEmitter.prototype,{getFirstMessageId:function(e){var t=o[e].messages;if(!t)return null;var a=Object.keys(t);if(!a.length)return null;var n=a[0];return t[n].id||null},addContactRawMessages:function(e,t,a){var n={};for(var s in a){var r=a[s],i=!0;r.contentType==u.IMAGE&&(r.message="data:image/jpg;base64,"+r.message);var o=C.mapMessageFromRaw(r,i,e.nick);n[o.id]=o}v.addHistoryMessages(t,n),v.emitUpdate()},getAll:function(){return o},getMessages:function(e){if(!e)return[];o[e]||(o[e]={messages:{},unreadIds:[],firstUnreadMsgId:null,init:!1});var t=[],a=o[e].messages;for(var n in a)t.push(a[n]);return t},addHistoryMessages:function(e,t){o[e]?o[e].messages=React.addons.update(t,{$merge:o[e].messages}):o[e]={messages:t,unreadIds:[],firstUnreadMsgId:null}},addMessage:function(e,t,a){t.isRead=a==e,o[e]||(o[e]={messages:{},unreadIds:[],firstUnreadMsgId:null}),t.isRead||(o[e].unreadIds.push(t.id),null==o[e].firstUnreadMsgId&&(o[e].firstUnreadMsgId=t.id)),o[e].messages[t.id]=t},emitChange:function(){this.emit(h.MESSAGE_CHANGE_EVENT)},emitUpdate:function(){this.emit(h.MESSAGE_UPDATE_EVENT)},addChangeListener:function(e){this.on(h.MESSAGE_CHANGE_EVENT,e)},removeChangeListener:function(e){this.removeListener(h.MESSAGE_CHANGE_EVENT,e)},removeUpdateListener:function(e){this.removeListener(h.MESSAGE_UPDATE_EVENT,e)},addUpdateListener:function(e){this.on(h.MESSAGE_UPDATE_EVENT,e)},addOutMessage:function(e){i++;var t={id:e.id,from:e.operator.nick,fromName:e.operator.name,to:e.contact.name,message:e.data.message,contentType:e.type,messageType:p.OUTGOING,endOfConversation:e.endOfConversation,operator:!0,date:e.date,isRead:!0};o[e.contact.name].messages[t.id]=t,this.emitChange()},unmarkFirstRead:function(e){if(e){var t=o[e].firstUnreadMsgId;null!=t&&(o[e].messages[t].firstUnread=!1)}},readMessages:function(e){var t=o[e].messages,a=o[e].unreadIds||(o[e].unreadIds=[]),n=o[e].firstUnreadMsgId;n&&(t[n].firstUnread=!1);for(var s=a.length>0,r=0,i=a.length;i>r;r++){var c=t[a[r]];0==r&&(c.firstUnread=!0,o[e].firstUnreadMsgId=c.id),c.isRead=!0}return o[e].unreadIds=[],s}}),T=objectAssign({},EventEmitter.prototype,{init:function(e){for(var t=0,a=e.length;a>t;t++){var n=e[t];c[n.username]={id:n.id,name:n.username,status:n.status,loadStatus:"init"}}},getCountAll:function(){return Object.keys(c).length},getAll:function(){var e=[];if(m){s=n,n=null;for(var t in c){var a=c[t];a.name.indexOf(m)>=0&&e.push(a)}}else for(var t in c){var a=c[t];e.push(a)}return e},setFilter:function(e){this.clearContact(),m=e},clearContact:function(){s=n,n=null},emitChange:function(){this.emit(h.CONTACTS_CHANGE_EVENT)},emitContactSelect:function(){this.emit(h.CONTACT_SELECT_EVENT)},addChangeListener:function(e){this.on(h.CONTACTS_CHANGE_EVENT,e)},addContactSelectListener:function(e){this.on(h.CONTACT_SELECT_EVENT,e)},removeChangeListener:function(e){this.removeListener(h.CONTACTS_CHANGE_EVENT,e)},removeContactSelectListener:function(e){this.removeListener(h.CONTACT_SELECT_EVENT,e)},getActive:function(){return n},getCurrentContact:function(){return c[n]},setActive:function(e){var t=n!=e;s=n,n=e,s||(s=n);var a=c[n].clicks;return c[n].clicks=a&&++a||1,t},setLoadingState:function(e){c[e].loadStatus="loading"},setLoadedState:function(e){c[e].loadStatus="loaded"}}),y=new Flux.Dispatcher;S.dispatchToken=y.register(function(e){switch(e.type){case g.AUTH_SUCCESS:S.setStatus(f.SUCCESS),S.setOperator(e.operator),S.emitChange();break;case g.AUTH_FAIL:S.setStatus(f.ERROR),S._clearErrors(),S._addError(e.error),S.emitChange();break;case g.OPERATOR_STATUS_CHANGED:r.status=e.payload.status,S.emitChange()}}),R.dispatchToken=y.register(function(e){var t;switch(e.type){case g.NEW_IN_MESSAGE:case g.NEW_OUT_MESSAGE:var a=e.payload;t=R.addParticipant(a),t&&R.emitChange()}}),T.dispatchToken=y.register(function(e){switch(y.waitFor([S.dispatchToken]),e.type){case g.CLICK_CONTACT:var t=T.setActive(e.contactId);t&&T.emitContactSelect();break;case g.CONTACT_MESSAGES_SCROLL:c[e.contactId].scrollTop=e.scrollTopValue,T.emitChange();break;case g.CONTACT_FILTER:T.setFilter(e.pattern),T.emitChange();break;case g.CLEAR_SELECTED_CONTACT:T.clearContact();break;case g.API_FETCH_CONTACT_HISTORY:T.setLoadingState(e.contact.name,"loading");break;case g.CLIENT_STATUS_CHANGED:var a=e.payload,n=c[a.username];n?n.status=a.status:c[a.username]={id:a.id,name:a.username,status:a.status,loadStatus:"init"},T.emitChange()}}),v.dispatchToken=y.register(function(e){y.waitFor([T.dispatchToken]);var t,a=null,n=-1;switch(e.type){case g.CLICK_CONTACT:e.changed&&(v.unmarkFirstRead(e.prevContactId),v.emitUpdate());break;case g.NEW_OUT_MESSAGE:var r=e.payload;a=C.mapMessageFromRaw(r,!0);var i=a.to;t=T.getActive(),v.addMessage(i,a,t),r.receiver==t&&v.emitUpdate(),v.emitChange();break;case g.NEW_IN_MESSAGE:var c=e.payload;a=C.mapMessageFromRaw(c,!1,e.operator.nick),t=T.getActive(),v.addMessage(a.to,a,t),c.sender!=t&&c.receiver!=t||v.emitUpdate(),v.emitChange();break;case g.CONTACT_FILTER:s&&(n=o[s].firstUnreadMsgId,null!=n&&(o[s].messages[n].firstUnread=!1,o[s].firstUnreadMsgId=null));break;case g.UPDATE_MESSAGE_CONTENT:var l=e.payload,m=l.data,d=o[l.receiver].messages[l.tempMessageId];d.id=m.id,d.sending=!1,m.contentType==u.IMAGE&&(d.fullImageUrl=m.fullImageUrl),m.receiver==t&&v.emitUpdate(),v.emitChange()}}),_.dispatchToken=y.register(function(e){switch(y.waitFor([T.dispatchToken,v.dispatchToken]),e.type){case g.READ_MESSAGES:var t=v.readMessages(e.contactId);t&&_.emitChange();break;case g.NEW_OUT_MESSAGE:_.emitChange();break;case g.NEW_IN_MESSAGE:_.emitChange();break;case g.CLICK_CONTACT:e.changed&&_.emitChange();break;case g.RECEIVE_RAW_MESSAGES:_.emitChange()}});var A=React.createClass({displayName:"OperatorInfo",getInitialState:function(){return{operator:S.getOperator()}},componentDidMount:function(){S.addChangeListener(this._onAuthChanged)},componentWillUnmount:function(){S.removeChangeListener(this._onAuthChanged)},_onAuthChanged:function(){this.setState({operator:S.getOperator()})},_onMuteVolumeChange:function(e){e?N.muteNotifications():N.unmuteNotifications()},render:function(){return React.createElement("div",{className:"operator-info operator-"+this.state.operator.status},React.createElement(H,{muted:!1,onChange:this._onMuteVolumeChange}),"  ",React.createElement("i",{className:"fa fa-circle "+this.state.operator.status||"offline"}),"  ",React.createElement("b",null,this.state.operator.name)," ","("+this.state.operator.nick+")")}}),M=React.createClass({displayName:"LoadMessageHistoryButton",getInitialState:function(){return{btnState:this.props.status||"init"}},_onClick:function(e){e.preventDefault(),e.stopPropagation(),"function"==typeof this.props.onClick&&this.props.onClick(),this.setState({btnState:"loading"})},componentWillReceiveProps:function(e){this.setState({btnState:e.status})},_renderState:function(){switch(this.state.btnState){case"init":return React.createElement("div",{className:"history-load",style:{textAlign:"center"}},React.createElement("span",{className:"btn-badge"},React.createElement("a",{onClick:this._onClick,href:"#"},this.props.title)));case"loading":return React.createElement("div",{className:"history-load",style:{textAlign:"center"}},React.createElement("span",{className:"btn-badge"},React.createElement("b",null,this.props.titleLoading||"Loading...")));case"loaded":return React.createElement("div",{className:"history-load",style:{textAlign:"center"}})}},render:function(){return this._renderState()}}),I=React.createClass({displayName:"UploadImageButton",getCoefficient:function(e,t,a){var n=Math.max(e,t),s=1;return n>a&&(s=n/a),s},_onUploadedBase64:function(e,t){this.props.onImageBase64&&this.props.onImageBase64(e,t)},_onFileChange:function(e){if("function"==typeof window.FileReader){var t=this.refs.fileUpload,a=t.files[0],n=new FileReader,s=this;n.onload=function(){var e=new Image;e.onload=function(){var e=s.refs.imageCanvas,t=s.img.width,a=s.img.height,n=s.getCoefficient(t,a,1280);e.width=t/n,e.height=a/n;var r=e.getContext("2d");r.drawImage(s.img,0,0,e.width,e.height);var i=e.toDataURL("image/png");n=s.getCoefficient(t,a,150),e.width=t/n,e.height=a/n,r.drawImage(s.img,0,0,e.width,e.height);var o=e.toDataURL("image/png");s._onUploadedBase64(o,i)},e.src=n.result,s.img=e},n.readAsDataURL(a)}},render:function(){return React.createElement("i",{className:this.props.classes,style:{position:"relative"}},React.createElement("form",{action:"#"},React.createElement("input",{style:{opacity:0,zIndex:2,left:0,top:0,width:"100%",position:"absolute"},ref:"fileUpload",type:"file",accept:"image/*",onChange:this._onFileChange})),React.createElement("canvas",{ref:"imageCanvas",style:{display:"none"}}))}}),O=React.createClass({displayName:"UnreadOutgoingMessage",scrolled:!1,canScroll:function(){return!this.scrolled},scrollIntoViewIfNeeded:function(e,t){if(!this.scrolled){var a=ReactDOM.findDOMNode(this);C.scrollIntoViewNeeded(e,a,t),this.scrolled=!0}},_onDownloadMessages:function(e){C.downloadImageByUrl(this.props.data.fullImageUrl,"Image viewing","chat-thumbnail.png"),e.preventDefault(),e.stopPropagation()},renderMessage:function(e){return e.contentType==u.TEXT?e.message||"Empty message":e.contentType==u.IMAGE?React.createElement("a",{href:"#",onClick:this._onDownloadMessages},React.createElement("img",{className:"image-message",src:e.message})):void 0},operatorStatus:function(){return this.props.data.operator?React.createElement("i",{className:"msg-badge"},"operator"):""},render:function(){return React.createElement("li",{className:"message-container clearfix messages-unread"},React.createElement("span",{className:"mark"},"New messages"),React.createElement("div",{className:"message-data align-right"},React.createElement("span",{className:"message-data-time"},C.getCurrentTime(this.props.data.date),", ","Today"),"   ",React.createElement("span",{className:"message-data-name"},this.props.data.fromName||"Empty sender",this.operatorStatus()),"  ",React.createElement("i",{className:"fa fa-circle "+(this.props.status||"me")})),React.createElement("div",{className:"message other-message float-right"},this.renderMessage(this.props.data)))}}),U=React.createClass({displayName:"UnreadIncomingMessage",scrolled:!1,_onDownloadMessages:function(e){C.downloadImageByUrl(this.props.data.fullImageUrl,"Image viewing","chat-thumbnail.png"),e.preventDefault(),e.stopPropagation()},renderMessage:function(e){return e.contentType==u.TEXT?e.message||"Empty message":e.contentType==u.IMAGE?React.createElement("a",{href:"#",onClick:this._onDownloadMessages},React.createElement("img",{className:"image-message",src:e.message})):void 0},scrollIntoViewIfNeeded:function(e,t){if(!this.scrolled){var a=ReactDOM.findDOMNode(this);C.scrollIntoViewNeeded(e,a,t),this.scrolled=!0}},canScroll:function(){return!this.scrolled},_operatorStatus:function(){return this.props.data.operator?React.createElement("i",{className:"msg-badge"},"operator"):""},_operatorMsgClasses:function(){return this.props.data.operator?" other-operator":""},render:function(){return React.createElement("li",{className:"message-container messages-unread"},React.createElement("span",{className:"mark"},"New messages"),React.createElement("div",{className:"message-data"},React.createElement("span",{className:"message-data-name"},React.createElement("i",{className:"fa fa-circle "+(this.props.status||"offline")}),this.props.data.fromName||"Not specified",this._operatorStatus()),React.createElement("span",{className:"message-data-time"},C.getCurrentTime(this.props.data.date),", ","Today")),React.createElement("div",{className:"message my-message"+this._operatorMsgClasses()},this.renderMessage(this.props.data)))}}),L=React.createClass({displayName:"UnreadEndConversationMessage",scrolled:!1,scrollIntoViewIfNeeded:function(e,t){if(!this.scrolled){var a=ReactDOM.findDOMNode(this);C.scrollIntoViewNeeded(e,a,t),this.scrolled=!0}},canScroll:function(){return!this.scrolled},renderMessage:function(e){return React.createElement("div",{className:"message-resolved"})},operatorStatus:function(){return this.props.data.operator?React.createElement("i",{className:"msg-badge"},"operator"):""},render:function(){return React.createElement("li",{className:"message-container clearfix messages-unread"},React.createElement("span",{className:"mark"},"New messages"),React.createElement("div",{className:"message-data align-right"},React.createElement("span",{className:"message-data-time"},C.getCurrentTime(this.props.data.date),", ","Today"),"   ",React.createElement("span",{className:"message-data-name"},this.props.data.fromName||"Empty sender",this.operatorStatus()),"  ",React.createElement("i",{className:"fa fa-circle "+(this.props.status||"me")})),this.renderMessage(this.props.data))}}),w=(React.createClass({displayName:"TypingMessage",render:function(){var e=function(){return(new Date).toLocaleTimeString().replace(/([\d]+:[\d]{2})(:[\d]{2})(.*)/,"$1$3")};return React.createElement("li",null,React.createElement("div",{className:"message-data"},React.createElement("span",{className:"message-data-name"},React.createElement("i",{className:"fa fa-circle online"}),this.props.phone||"Not specified"),React.createElement("span",{className:"message-data-time"},this.props.time||e())),React.createElement("i",{className:"fa fa-circle online"}),React.createElement("i",{className:"fa fa-circle online",style:{color:"#AED2A6"}}),React.createElement("i",{className:"fa fa-circle online",style:{color:"#DAE9DA"}}))}}),React.createClass({displayName:"OutgoingMessage",canScroll:function(){return!0},scrollIntoViewIfNeeded:function(e,t){var a=ReactDOM.findDOMNode(this);C.scrollIntoViewNeeded(e,a,t)},_onDownloadMessages:function(e){C.downloadImageByUrl(this.props.data.fullImageUrl,"Image viewing","chat-thumbnail.png"),e.preventDefault(),e.stopPropagation()},operatorStatus:function(){return this.props.data.operator?React.createElement("i",{className:"msg-badge"},"operator"):""},renderSendIndicator:function(e){return e.sending?React.createElement("span",{className:"fa fa-refresh fa-spin fa-fw send-icon"}):""},renderMessage:function(e){return e.contentType==u.TEXT?e.message||"Empty message":e.contentType==u.IMAGE?React.createElement("a",{href:"#",onClick:this._onDownloadMessages},React.createElement("img",{className:"image-message",src:e.message})):void 0},render:function(){return React.createElement("li",{className:"clearfix"},React.createElement("div",{className:"message-data align-right"},React.createElement("span",{className:"message-data-time"},C.getCurrentTime(this.props.data.date),", ","Today"),"   ",React.createElement("span",{className:"message-data-name"},this.props.data.fromName||"Empty sender",this.operatorStatus()),"  ",React.createElement("i",{className:"fa fa-circle "+(this.props.status||"me")})),React.createElement("div",{className:"message other-message float-right"},this.renderMessage(this.props.data),this.renderSendIndicator(this.props.data)))}})),k=React.createClass({displayName:"MinChatBox",getInitialState:function(){return{clientsCount:T.getCountAll(),unreadCount:_.getAll()}},componentDidMount:function(){_.addChangeListener(this._onUnreadChange),T.addChangeListener(this._onContactsChanged)},componentWillUnmount:function(){_.removeChangeListener(this._onUnreadChange),T.removeChangeListener(this._onContactsChanged)},_onContactsChanged:function(){var e=T.getCountAll();this.setState({clientsCount:e})},_onUnreadChange:function(){var e=_.getAll();this.setState({unreadCount:e})},_maximizeClicked:function(){"function"==typeof this.props.onMaximize&&this.props.onMaximize()},render:function(){return React.createElement("div",{className:"chat-container min-container clearfix"},React.createElement("div",{className:"msg-count center-text bg-"+this.props.status},React.createElement("div",{className:"status"},React.createElement("i",{className:"fa fa-circle "+this.props.status||"offline"}),this.props.status),React.createElement("div",null,"Clients: ",React.createElement("i",{className:"clients-badge"},this.state.clientsCount))),React.createElement("div",{className:"chat-info"},"New: ",React.createElement("span",{className:"msg-badge unread"},this.state.unreadCount),React.createElement(x,{onClick:this._maximizeClicked,classes:"fa fa-2x fa-plus-square maximize-icon"})))}}),G=React.createClass({displayName:"EmptyMinChatBox",_maximizeClicked:function(){"function"==typeof this.props.onMaximize&&this.props.onMaximize()},render:function(){return React.createElement("div",{className:"chat-container min-container clearfix"},React.createElement("div",{className:"msg-count-empty center-text"},"Chat"),React.createElement("div",{className:"chat-info"},React.createElement(x,{onClick:this._maximizeClicked,classes:"fa fa-2x fa-plus-square maximize-icon"})))}}),D=React.createClass({displayName:"LoginBox",componentDidMount:function(){S.addChangeListener(this._onAuthChanged)},componentWillUnmount:function(){S.removeChangeListener(this._onAuthChanged)},getInitialState:function(){return{loginState:this.props.initialLoginState||"login",error:!1,messages:S.getErrors()}},_onAuthChanged:function(){S.getStatus()===f.SUCCESS?(this.successState(),"function"==typeof this.props.onAuthSuccess&&setTimeout(function(){this.props.onAuthSuccess(S.getOperator())}.bind(this),1e3)):this.tryAgainState()},_onMinimize:function(){this.setState({loginState:"min",originalState:this.state.loginState})},_onMaximize:function(){this.setState({loginState:this.state.originalState})},progressState:function(){this.setState({loginState:"progress",originalState:"progress"})},successState:function(){this.setState({loginState:"success",originalState:"success",error:!1,messages:[]})},tryAgainState:function(){this.setState({loginState:"login",originalState:"login",error:!0,messages:S.getErrors()})},loginClick:function(e){this.progressState(),N.authenticate()},_renderErrorInfo:function(){return this.state.error?React.createElement("div",{className:"error-box"},React.createElement("ul",null,this.state.messages.map(function(e){return React.createElement("li",null,e)}))):""},renderState:function(){switch(this.state.loginState){case"min":return React.createElement(G,{onMaximize:this._onMaximize});case"login":return React.createElement("div",{className:"chat"},React.createElement(W,{onMinimize:this._onMinimize}),React.createElement("div",{className:"wrapper"},this._renderErrorInfo(),React.createElement("button",{className:"login-btn",onClick:this.loginClick},React.createElement("i",{className:"chat-spinner"}),React.createElement("span",{className:"state"},"Log in"))));case"progress":return React.createElement("div",{className:"chat"},React.createElement(W,{onMinimize:this._onMinimize}),React.createElement("div",{className:"wrapper loading"},React.createElement("button",{className:"login-btn"},React.createElement("i",{className:"chat-spinner"}),React.createElement("span",{className:"state"},"Authenticating"))));case"success":return React.createElement("div",{className:"chat"},React.createElement(W,{onMinimize:this._onMinimize}),React.createElement("div",{className:"wrapper ok loading"},React.createElement("button",{className:"login-btn"},React.createElement("i",{className:"chat-spinner"}),React.createElement("span",{className:"state"},"Welcome back!"))))}},render:function(){return this.renderState()}}),b=React.createClass({displayName:"IncomingMessage",_onDownloadMessages:function(e){C.downloadImageByUrl(this.props.data.fullImageUrl,"Image viewing","chat-thumbnail.png"),e.preventDefault(),e.stopPropagation()},renderMessage:function(e){return e.contentType==u.TEXT?e.message||"Empty message":e.contentType==u.IMAGE?React.createElement("a",{href:"#",onClick:this._onDownloadMessages},React.createElement("img",{className:"image-message",src:e.message})):void 0},operatorStatus:function(){return this.props.data.operator?React.createElement("i",{className:"msg-badge"},"operator"):""},_operatorMsgClasses:function(){return this.props.data.operator?" other-operator":""},render:function(){return React.createElement("li",null,React.createElement("div",{className:"message-data"},React.createElement("span",{className:"message-data-name"},React.createElement("i",{className:"fa fa-circle "+(this.props.status||"offline")}),this.props.data.fromName||"Not specified",this.operatorStatus()),React.createElement("span",{className:"message-data-time"},C.getCurrentTime(this.props.data.date),", ","Today")),React.createElement("div",{className:"message my-message"+this._operatorMsgClasses()},this.renderMessage(this.props.data)))}}),H=React.createClass({displayName:"MuteUnmuteButton",_styles:{cursor:"pointer"},getInitialState:function(){return{muted:this.props.muted||!1}},getClasses:function(){var e="msg-badge badge-sm ";return this.state.muted?e+"fa fa-volume-off":e+"fa fa-volume-up"},_onClick:function(){"function"==typeof this.props.onChange&&this.props.onChange(!this.state.muted),this.setState({muted:!this.state.muted})},render:function(){return React.createElement("i",{style:this._styles,onClick:this._onClick,className:this.getClasses()})}}),x=React.createClass({displayName:"IconButton",render:function(){return React.createElement("i",{onClick:this.props.onClick||function(){},className:this.props.classes})}}),P=React.createClass({displayName:"HistoryButton",render:function(){return React.createElement("button",{onClick:this.props.onClick,className:this.props.classes},React.createElement("i",{className:this.props.icons}),"  ",this.props.title||"")}}),F=React.createClass({displayName:"HistoryBox",scroll:0,canScroll:!0,renderMessage:function(e){var t=this.props.contact;switch(e.messageType){case p.INCOMING:return e.firstUnread?e.endOfConversation?React.createElement(L,{key:e.id,data:e,status:t.status}):React.createElement(U,{ref:"unreadItem",key:e.id,data:e,status:t.status}):e.endOfConversation?React.createElement(B,{key:e.id,data:e,status:t.status}):React.createElement(b,{key:e.id,data:e,status:t.status});case p.OUTGOING:return e.firstUnread?e.endOfConversation?React.createElement(L,{key:e.id,data:e,status:t.status}):React.createElement(O,{ref:"unreadItem",key:e.id,data:e,status:t.status}):e.endOfConversation?React.createElement(B,{key:e.id,data:e,status:t.status}):React.createElement(w,{key:e.id,data:e,status:t.status})}},_scrollToFirstUnread:function(){var e=this.refs.unreadItem,t=ReactDOM.findDOMNode(this);e&&e.canScroll()?(this.refs.unreadItem.scrollIntoViewIfNeeded(t,!0),this.scroll=t.scrollHeight-t.offsetHeight):this.canScroll&&(t.scrollTop=t.scrollHeight,this.scroll=t.scrollHeight-t.offsetHeight)},_onLoadHistory:function(){"function"==typeof this.props.onLoadHistory&&this.props.onLoadHistory(this.props.contact)},componentDidMount:function(){this._scrollToFirstUnread()},componentWillUpdate:function(e,t){e.contact.id!=this.props.contact.id&&(this.scroll=0);var a=ReactDOM.findDOMNode(this);this.canScroll=!this.props.messages.length||a.scrollTop>=this.scroll},componentDidUpdate:function(){this._scrollToFirstUnread()},render:function(){var e=this.renderMessage;return React.createElement("div",{className:"chat-history"},React.createElement(M,{status:this.props.contact.loadStatus,onClick:this._onLoadHistory,title:"Load history",titleLoading:"Loading..."}),React.createElement("ul",{className:"chat-history-messages"},this.props.messages.map(function(t){return e(t)})))}}),z=React.createClass({displayName:"HeaderBox",closeClicked:function(e){"function"==typeof this.props.onClose&&this.props.onClose()},_minimizeClicked:function(e){"function"==typeof this.props.onMinimize&&this.props.onMinimize()},render:function(){return React.createElement("div",{className:"chat-header clearfix"},React.createElement("div",{className:"chat-about"},React.createElement("div",{className:"chat-with"}," Chat with: ",this.props.contact.name||""),React.createElement("div",{
className:"chat-num-messages"},"already",React.createElement("i",{className:"msg-badge"},this.props.count||0),"messages")),React.createElement(x,{onClick:this.closeClicked,classes:"fa fa-times header-icon"}),React.createElement(x,{onClick:this._minimizeClicked,classes:"fa fa-minus-square header-icon"}))}}),V=React.createClass({displayName:"FooterBox",getInitialState:function(){return{value:""}},sendMessage:function(e){if(""!==this.state.value.trim()){var t=new Date,a={id:"temp_"+ ++i,message:this.state.value,sender:this.props.operator.nick,operatorName:this.props.operator.name,receiver:this.props.contact.name,contentType:u.TEXT,messageType:p.OUTGOING,endOfConversation:!1,date:t,sending:!0,fullImage:null};N.outgoingMessage(a),this.setState({value:""})}},sendEndMessage:function(e){var t=new Date,a={id:"temp_"+ ++i,message:"End of conversation",sender:this.props.operator.nick,operatorName:this.props.operator.name,receiver:this.props.contact.name,contentType:u.TEXT,messageType:p.OUTGOING,endOfConversation:!0,date:t,sending:!0,fullImage:null};N.outgoingMessage(a)},handleChange:function(e){this.setState({value:e.target.value})},handleKeyUp:function(e){e.keyCode===E.ENTER_KEY&&this.sendMessage()},_onImageUpload:function(e,t){var a=new Date,n={id:null,message:e,sender:this.props.operator.nick,operatorName:this.props.operator.name,receiver:this.props.contact.name,contentType:u.IMAGE,messageType:p.OUTGOING,endOfConversation:!1,date:a,sending:!0,fullImage:t};N.outgoingMessage(n)},render:function(){return React.createElement("div",{className:"chat-message clearfix"},React.createElement("textarea",{name:"message-to-send",id:"message-to-send",placeholder:"Type your message",value:this.state.value,onChange:this.handleChange,onKeyUp:this.handleKeyUp,rows:"2"}),React.createElement(x,{classes:"fa fa-file-o"}),"   ",React.createElement(I,{onImageBase64:this._onImageUpload,classes:"fa fa-file-image-o"}),React.createElement(P,{onClick:this.sendMessage,title:"send",icons:"fa fa-paper-plane-o",classes:"btn-send"}),React.createElement(P,{onClick:this.sendEndMessage,title:"end",icons:"fa fa-comments",classes:"btn-replied"}))}}),B=React.createClass({displayName:"EndConversationMessage",operatorStatus:function(){return this.props.data.operator?React.createElement("i",{className:"msg-badge"},"operator"):""},renderMessage:function(e){return React.createElement("div",{className:"message-resolved"})},render:function(){return React.createElement("li",{className:"clearfix"},React.createElement("div",{className:"message-data align-right"},React.createElement("span",{className:"message-data-time"},C.getCurrentTime(this.props.data.date),", ","Today"),"   ",React.createElement("span",{className:"message-data-name"},this.props.data.fromName||"Empty sender",this.operatorStatus()),"  ",React.createElement("i",{className:"fa fa-circle "+(this.props.status||"me")})),this.renderMessage(this.props.data))}}),W=React.createClass({displayName:"EmptyHeaderBox",_onMinimize:function(){"function"==typeof this.props.onMinimize&&this.props.onMinimize()},render:function(){return React.createElement("div",{className:"chat-header clearfix"},React.createElement(x,{onClick:this._onMinimize,classes:"fa fa-minus-square header-icon"}))}}),j=React.createClass({displayName:"EmptyConversationBox",_onMinimize:function(){"function"==typeof this.props.onMinimize&&this.props.onMinimize()},render:function(){return React.createElement("div",{className:"chat"},React.createElement(W,{onMinimize:this._onMinimize}),React.createElement(K,null))}}),K=React.createClass({displayName:"EmptyChatBox",render:function(){return React.createElement("div",{className:"wrapper no-conversation"},React.createElement("div",null,React.createElement("i",{className:"fa fa-4x fa-comment"})),React.createElement("span",{className:"state"},"No conversation"))}}),q=React.createClass({displayName:"ConversationBox",_onClose:function(){"function"==typeof this.props.onClose&&this.props.onClose()},_onMinimize:function(){"function"==typeof this.props.onMinimize&&this.props.onMinimize()},_onOutMessage:function(e){"function"==typeof this.props.onOutgoingMessage&&this.props.onOutgoingMessage(e)},_onLoadHistory:function(e){"function"==typeof this.props.onLoadHistory&&this.props.onLoadHistory(e)},render:function(){return React.createElement("div",{className:"chat"},React.createElement(z,{contact:this.props.contact,count:this.props.messages.length,onClose:this._onClose,onMinimize:this._onMinimize}),React.createElement(F,{contact:this.props.contact,messages:this.props.messages,onLoadHistory:this._onLoadHistory}),React.createElement(V,{operator:this.props.operator,contact:this.props.contact,onMessage:this._onOutMessage}))}}),X=React.createClass({displayName:"ContactsListBox",onActivateContact:function(e){"function"==typeof this.props.onSelectContact&&this.props.onSelectContact(e)},render:function(){var e=this.props.current?this.props.current.name:null,t=this.onActivateContact;return React.createElement("ul",{className:"list"},this.props.items.map(function(a){return React.createElement(J,{key:a.id,data:a,selectedId:e,onActivate:t})}))}}),Y=React.createClass({displayName:"ContactSearchBox",getInitialState:function(){return{value:""}},_handleChange:function(e){this.setState({value:e.target.value}),"function"==typeof this.props.onLiveSearch&&this.props.onLiveSearch(e.target.value)},_handleKeyUp:function(e){e.keyCode===E.ENTER_KEY&&this._onSearch()},_onSearch:function(){"function"==typeof this.props.onSearch&&this.props.onSearch(this.state.value)},_onClear:function(){this.setState({value:""}),"function"==typeof this.props.onClear&&this.props.onClear()},render:function(){return React.createElement("div",{className:"search"},React.createElement("input",{className:"search-input",onChange:this._handleChange,onKeyUp:this._handleKeyUp,type:"text",placeholder:"search",value:this.state.value}),React.createElement("i",{onClick:this._onSearch,className:"fa fa-search"}),React.createElement("i",{onClick:this._onClear,className:"fa fa-close"}))}}),$=React.createClass({displayName:"ContactsBox",_onSearch:function(e){N.contactFilter(e)},_onClear:function(){N.contactFilter("")},_onLiveSearch:function(e){N.contactFilter(e)},_onSelectContact:function(e){"function"==typeof this.props.onSelectContact&&this.props.onSelectContact(e)},render:function(){return React.createElement("div",{className:"people-list",id:"people-list"},React.createElement(Y,{onLiveSearch:this._onLiveSearch,onSearch:this._onSearch,onClear:this._onClear}),React.createElement(A,null),React.createElement(X,{items:this.props.contacts,current:this.props.current,onSelectContact:this._onSelectContact}))}}),J=React.createClass({displayName:"Contact",getInitialState:function(){var e=_.getCount(this.props.data.name),t=R.getParticipants(this.props.data.name);return{active:!1,unread:e,participants:t}},componentDidMount:function(){_.addChangeListener(this._onUnreadChange),R.addChangeListener(this._participantsChange)},componentWillUnmount:function(){_.removeChangeListener(this._onUnreadChange),R.removeChangeListener(this._participantsChange)},_onUnreadChange:function(){var e=_.getCount(this.props.data.name);this.setState({unread:e})},_participantsChange:function(){var e=R.getParticipants(this.props.data.name);e.length>0&&this.setState({participants:e})},_getParticipants:function(){return this.state.participants?React.createElement("span",null,this.state.participants.map(function(e,t){return React.createElement("span",{key:t,className:"msg-badge badge-sm"},e)})):""},activateContact:function(){"function"==typeof this.props.onActivate&&this.props.onActivate(this.props.data)},getUnreadMessageCount:function(){return this.state.unread?React.createElement("i",{className:"msg-badge unread"},this.state.unread||0):""},clientActive:function(){var e=this.props.data;return this.props.selectedId==e.name?" active":""},render:function(){return React.createElement("li",{className:"contact clearfix"+this.clientActive(),onClick:this.activateContact},React.createElement("div",{className:"about"},React.createElement("div",{className:"name"},this.props.data.name||"+000000000000"),React.createElement("div",{className:"status"},React.createElement("i",{className:"fa fa-circle "+this.props.data.status||"offline"}),this.props.data.status||"offline"),React.createElement("div",null,this._getParticipants()),React.createElement("div",{className:"msg-unread"},this.getUnreadMessageCount())))}}),Q=React.createClass({displayName:"ChatBox",getInitialState:function(){return{chatState:this.props.initialChatState||"login",contacts:[],messages:[],currentContact:{},operator:{},unread:0}},componentDidMount:function(){S.addChangeListener(this._onAuthChanged),T.addChangeListener(this._storeContactsChange),T.addContactSelectListener(this._storeContactSelect),v.addUpdateListener(this._storeMessagesChange)},componentWillUnmount:function(){S.removeChangeListener(this._onAuthChanged),T.removeChangeListener(this._storeContactsChange),T.removeContactSelectListener(this._storeContactSelect),v.removeUpdateListener(this._storeMessagesChange)},_onAuthChanged:function(){this.setState({operator:S.getOperator()})},_onSelectContact:function(e){N.clickContact(e.name),N.readMessages(e.name)},_storeContactSelect:function(){var e=T.getCurrentContact();this.setState({chatState:"chat",currentContact:e})},_storeContactsChange:function(){var e=T.getCurrentContact(),t=e&&e.name||null;this.setState({chatState:e?"chat":"no-chat",currentContact:e,messages:v.getMessages(t),contacts:T.getAll()})},_storeMessagesChange:function(){var e=T.getCurrentContact();e&&this.setState({currentContact:e,messages:v.getMessages(e.name)})},authSuccess:function(e){this.setState({operator:e,chatState:"no-chat"}),N.fetchContacts()},onConversationClose:function(){this.setState({chatState:"no-chat",messages:[],currentContact:{}}),N.clearSelected()},_onMinimize:function(){this.setState({chatState:"min",messages:[],currentContact:{}}),N.clearSelected()},_onMaximize:function(){this.setState({chatState:"no-chat",messages:[],currentContact:{}})},_onLoadHistory:function(e){var t=v.getFirstMessageId(e.name);N.fetchContactHistory(e,t)},onOutgoingMessage:function(e){var t=this.state.operator,a=this.state.currentContact;v.addOutMessage({contact:a,operator:t,data:e,type:u.TEXT})},renderState:function(){switch(this.state.chatState||"login"){case"min":return React.createElement(k,{onMaximize:this._onMaximize,status:this.state.operator.status});case"login":return React.createElement("div",{id:"chat-template",className:"chat-container clearfix"},React.createElement(D,{onAuthSuccess:this.authSuccess}));case"chat":return React.createElement("div",{id:"chat-template",className:"chat-container clearfix"},React.createElement($,{current:this.state.currentContact,contacts:this.state.contacts,onSelectContact:this._onSelectContact}),React.createElement(q,{contact:this.state.currentContact,operator:this.state.operator,messages:this.state.messages,onClose:this.onConversationClose,onMinimize:this._onMinimize,onOutgoingMessage:this.onOutgoingMessage,onLoadHistory:this._onLoadHistory}));case"no-chat":return React.createElement("div",{id:"chat-template",className:"chat-container clearfix"},React.createElement($,{contacts:this.state.contacts,onSelectContact:this._onSelectContact}),React.createElement(j,{onMinimize:this._onMinimize}))}},render:function(){return this.renderState()}});ReactDOM.render(React.createElement(Q,null),document.getElementById("chatbox"),function(){if("function"==typeof window.OkkChatReady){var e={Dispatcher:y,ActionTypes:g,Actions:N,Stores:{AuthStore:S,ContactsStore:T,MessageStore:v,ParticipantsStore:R,UnreadMessageStore:_},MessageTypes:p,MessageContentTypes:u,CoreUtils:C};window.OkkChatReady(e)}})},{}]},{},[1]);